<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session c0f089d4-3162-400d-b88f-887272e3d4ce (2026-01-01 22:50Z) -->

# AI card blueprint generation service (2026-01-01 22:50Z)

_**User (2026-01-01 22:21Z)**_

Create `services/ai_architect.py`.

Stack: `google-genai`, `pydantic`.

1.  **Define Pydantic Model (`CardBlueprint`)**:
    - `target_user_id`: int
    - `card_name_ua`: str
    - `rarity`: Rarity Enum (Common, Rare, etc.)
    - `biome`: BiomeType Enum (Techno, Fire, etc.)
    - `stats_atk`: int (0-100)
    - `stats_def`: int (0-100)
    - `stats_meme`: int (0-100)
    - `lore_ua`: str (2 sentences max)
    - `raw_image_prompt_en`: str (Descriptive prompt for visual elements only)

2.  **Class `CardArchitectService`**:
    - Init with `GEMINI_API_KEY`.
    - Method `generate_blueprint(user_context_logs: list[str]) -> CardBlueprint`:
    - **System Instruction**: Convert the "Gemini Gem" prompt provided earlier into a Python string. Crucially, emphasize the output must be valid JSON matching the `CardBlueprint` schema.
    - **Call Gemini**: Use a model like `gemini-1.5-pro-latest` with `generation_config={"response_mime_type": "application/json"}`.
    - **Parsing**: Use `CardBlueprint.model_validate_json(response.text)` to ensure robust parsing.
    - **Error Handling**: Catch validation errors and retry once if Gemini hallucinates the schema.

---

_**Agent (model default, mode Agent)**_



---


Reviewing the codebase to understand the enums and structure before creating `services/ai_architect.py`.


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: database/enums.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: services/scheduler.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: pyproject.toml</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="codebase_search">
<details>
                <summary>Tool use: **codebase_search** • Searched codebase "Gemini Gem prompt system instruction for card generation" • **15** results</summary>
            
| File | Lines |
|------|-------|
| `handlers/admin.py` | L102-208 |
| `handlers/admin.py` | L130-300 |
| `.cursor/rules/derived-cursor-rules.mdc` | L80-106 |
| `.cursor/rules/derived-cursor-rules.mdc` | L51 |
| `database/models.py` | L30-89 |
| `handlers/admin.py` | L41 |
| `handlers/admin.py` | L70-167 |
| `handlers/drops.py` | L94-241 |
| `handlers/admin.py` | L57-127 |
| `handlers/admin.py` | L208-300 |
| `handlers/admin.py` | L49-99 |
| `database/models.py` | L40-89 |
| `services/scheduler.py` | L16-229 |
| `handlers/admin.py` | L170-300 |
| `config.py` | L57 |

</details>
</tool-use>

---



---





---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: config.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="grep">
<details>
<summary>Tool use: **grep** • Grep for "gemini|Gemini|GEMINI" • 6 matches</summary>

Output mode: content


| File | Content | Line |
|------|------|------|
| `.\handlers\admin.py` | `if not settings.gemini_api_key:` | L142 |
| `.\handlers\admin.py` | `logger.warning("Gemini API key not configured, skipping image generation")` | L143 |
| `.\handlers\admin.py` | `genai.configure(api_key=settings.gemini_api_key)` | L147 |
| `.\handlers\admin.py` | `# Note: Google's Generative AI (gemini) primarily generates text, not images.` | L150 |
| `.\config.py` | `# Google Gemini API (Optional)` | L26 |
| `.\config.py` | `gemini_api_key: Optional[str] = Field(default=None, alias="GEMINI_API_KEY")` | L27 |


</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="codebase_search">
<details>
                <summary>Tool use: **codebase_search** • Searched codebase "Gemini Gem prompt system instruction card generation blueprint" • **15** results</summary>
            
| File | Lines |
|------|-------|
| `handlers/admin.py` | L102-208 |
| `handlers/admin.py` | L130-300 |
| `.cursor/rules/derived-cursor-rules.mdc` | L80-106 |
| `.cursor/rules/derived-cursor-rules.mdc` | L51 |
| `database/models.py` | L30-89 |
| `handlers/admin.py` | L41 |
| `handlers/admin.py` | L57-127 |
| `database/models.py` | L40-89 |
| `handlers/admin.py` | L70-167 |
| `handlers/drops.py` | L94-241 |
| `services/scheduler.py` | L16-229 |
| `handlers/admin.py` | L49-99 |
| `config.py` | L57 |
| `handlers/admin.py` | L208-300 |
| `pyproject.toml` | L31 |

</details>
</tool-use>

---



---





---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: handlers/admin.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: logging_config.py</summary>

</details>
</tool-use>

---



---


Creating `services/ai_architect.py` with the CardBlueprint model and CardArchitectService.


---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **write** • Edit file: services/ai_architect.py</summary>

**Chunk 1**
Lines added: 183, lines removed: 1

```diff
@@ -1,1 +1,183 @@
- 
+ """AI service for generating card blueprints using Google Gemini."""
+ 
+ from typing import Optional
+ 
+ import google.generativeai as genai
+ from pydantic import BaseModel, Field, field_validator
+ 
+ from database.enums import BiomeType, Rarity
+ from logging_config import get_logger
+ 
+ logger = get_logger(__name__)
+ 
+ 
+ class CardBlueprint(BaseModel):
+     """Pydantic model for card blueprint generated by AI."""
+ 
+     target_user_id: int = Field(..., description="Target user ID for the card")
+     card_name_ua: str = Field(..., description="Card name in Ukrainian")
+     rarity: Rarity = Field(..., description="Card rarity level")
+     biome: BiomeType = Field(..., description="Card biome type")
+     stats_atk: int = Field(..., ge=0, le=100, description="Attack stat (0-100)")
+     stats_def: int = Field(..., ge=0, le=100, description="Defense stat (0-100)")
+     stats_meme: int = Field(..., ge=0, le=100, description="Meme stat (0-100)")
+     lore_ua: str = Field(..., max_length=500, description="Card lore in Ukrainian (2 sentences max)")
+     raw_image_prompt_en: str = Field(
+         ..., description="Descriptive prompt for visual elements only (English)"
+     )
+ 
+     @field_validator("lore_ua")
+     @classmethod
+     def validate_lore_length(cls, v: str) -&gt; str:
+         """Ensure lore is at most 2 sentences."""
+         sentences = [s.strip() for s in v.split(".") if s.strip()]
+         if len(sentences) &gt; 2:
+             logger.warning(
+                 "Lore exceeds 2 sentences, truncating",
+                 original_length=len(sentences),
+             )
+             return ". ".join(sentences[:2]) + "."
+         return v
+ 
+ 
+ class CardArchitectService:
+     """Service for generating card blueprints using Google Gemini AI."""
+ 
+     def __init__(self, gemini_api_key: str) -&gt; None:
+         """
+         Initialize CardArchitectService.
+ 
+         Args:
+             gemini_api_key: Google Gemini API key.
+         """
+         self._api_key = gemini_api_key
+         genai.configure(api_key=gemini_api_key)
+         self._model = genai.GenerativeModel(
+             model_name="gemini-1.5-pro-latest",
+             generation_config={"response_mime_type": "application/json"},
+         )
+ 
+         # System instruction for Gemini
+         self._system_instruction = """You are a creative card architect for "Хроніки Помийки" (Chronicles of the Dumpster), a Ukrainian Telegram card game bot.
+ 
+ Your task is to generate unique, engaging card blueprints based on user context logs (conversation history, messages, interactions).
+ 
+ CRITICAL: You MUST output valid JSON that exactly matches the CardBlueprint schema. The output must be parseable JSON with no additional text, markdown formatting, or code blocks.
+ 
+ CardBlueprint Schema Requirements:
+ - target_user_id: integer (the user ID from context)
+ - card_name_ua: string (card name in Ukrainian, creative and thematic)
+ - rarity: string enum - must be one of: "Common", "Rare", "Epic", "Legendary", "Mythic"
+ - biome: string enum - must be one of: "Звичайний", "Вогняний", "Водний", "Трав'яний", "Психічний", "Техно", "Темний"
+ - stats_atk: integer (0-100) - attack stat, should correlate with rarity
+ - stats_def: integer (0-100) - defense stat, should correlate with rarity
+ - stats_meme: integer (0-100) - meme/humor stat, reflects the playful nature of the game
+ - lore_ua: string (maximum 2 sentences in Ukrainian) - brief, thematic lore that fits the card
+ - raw_image_prompt_en: string (English) - descriptive prompt for visual elements ONLY, no game mechanics or stats, focus on appearance, style, mood, colors, composition
+ 
+ Rarity Guidelines:
+ - Common: stats 0-30, simple concepts
+ - Rare: stats 20-50, more interesting concepts
+ - Epic: stats 40-70, unique and powerful concepts
+ - Legendary: stats 60-85, exceptional and memorable concepts
+ - Mythic: stats 75-100, legendary-tier concepts with maximum impact
+ 
+ Biome Selection:
+ Choose the biome that best fits the card's theme based on the user context. Consider the mood, setting, and thematic elements from the conversation.
+ 
+ Stats Balance:
+ Ensure stats are balanced and make sense for the rarity. Higher rarity should generally have higher stats, but creativity and thematic fit are more important than pure power.
+ 
+ Lore:
+ Write engaging, brief lore in Ukrainian (2 sentences maximum) that captures the essence of the card and connects to the user's context.
+ 
+ Image Prompt:
+ Create a detailed visual description in English that focuses purely on visual elements: appearance, art style, color palette, mood, composition, details. Do NOT include game mechanics, stats, or text elements.
+ 
+ Output Format:
+ Return ONLY valid JSON matching the CardBlueprint schema. No markdown, no code blocks, no explanations."""
+ 
+     def generate_blueprint(self, user_context_logs: list[str]) -&gt; CardBlueprint:
+         """
+         Generate a card blueprint based on user context logs.
+ 
+         Args:
+             user_context_logs: List of context strings (messages, interactions, etc.)
+ 
+         Returns:
+             CardBlueprint instance with generated card data.
+ 
+         Raises:
+             ValueError: If API key is not configured or generation fails after retries.
+             ValidationError: If generated JSON doesn't match schema (after retry).
+         """
+         if not self._api_key:
+             raise ValueError("Gemini API key not configured")
+ 
+         # Build user message from context logs
+         user_message = "\n".join(
+             [
+                 "User Context Logs:",
+                 "---",
+                 *user_context_logs,
+                 "---",
+                 "Generate a card blueprint based on this context.",
+             ]
+         )
+ 
+         max_retries = 2
+         last_error: Optional[Exception] = None
+ 
+         for attempt in range(max_retries):
+             try:
+                 logger.debug(
+                     "Generating card blueprint",
+                     attempt=attempt + 1,
+                     max_retries=max_retries,
+                     context_logs_count=len(user_context_logs),
+                 )
+ 
+                 response = self._model.generate_content(
+                     user_message,
+                     generation_config={"response_mime_type": "application/json"},
+                 )
+ 
+                 if not response.text:
+                     raise ValueError("Empty response from Gemini API")
+ 
+                 # Parse JSON response into CardBlueprint
+                 blueprint = CardBlueprint.model_validate_json(response.text)
+ 
+                 logger.info(
+                     "Card blueprint generated successfully",
+                     card_name=blueprint.card_name_ua,
+                     rarity=blueprint.rarity.value,
+                     biome=blueprint.biome.value,
+                     target_user_id=blueprint.target_user_id,
+                 )
+ 
+                 return blueprint
+ 
+             except Exception as e:
+                 last_error = e
+                 logger.warning(
+                     "Failed to generate or validate blueprint",
+                     attempt=attempt + 1,
+                     error=str(e),
+                     exc_info=True,
+                 )
+ 
+                 if attempt &lt; max_retries - 1:
+                     logger.info("Retrying blueprint generation")
+                     continue
+ 
+         # If we get here, all retries failed
+         logger.error(
+             "Failed to generate valid blueprint after retries",
+             max_retries=max_retries,
+             error=str(last_error) if last_error else "Unknown error",
+         )
+         raise ValueError(
+             f"Failed to generate valid card blueprint after {max_retries} attempts: {last_error}"
+         ) from last_error
+ 
```

</details>

</tool-use>

---



---


Checking for linting errors:


---

<tool-use data-tool-type="generic" data-tool-name="read_lints">
<details>
          <summary>Tool use: **read_lints** • Read lints for 1 file</summary>
      
Lint paths:

- `services/ai_architect.py`

Lint results


**No lint errors found**
</details>
</tool-use>

---



---


Updating the model initialization to pass the system instruction correctly:


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: services/ai_architect.py</summary>

</details>
</tool-use>

---



---


Updating the model initialization to include the system instruction:


---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: services/ai_architect.py</summary>

**Chunk 1**
Lines added: 1, lines removed: 5

```diff
@@ -53,11 +53,7 @@
          self._api_key = gemini_api_key
          genai.configure(api_key=gemini_api_key)
-         self._model = genai.GenerativeModel(
-             model_name="gemini-1.5-pro-latest",
-             generation_config={"response_mime_type": "application/json"},
-         )
  
          # System instruction for Gemini
-         self._system_instruction = """You are a creative card architect for "Хроніки Помийки" (Chronicles of the Dumpster), a Ukrainian Telegram card game bot.
+         system_instruction = """You are a creative card architect for "Хроніки Помийки" (Chronicles of the Dumpster), a Ukrainian Telegram card game bot.
  
  Your task is to generate unique, engaging card blueprints based on user context logs (conversation history, messages, interactions).
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: services/ai_architect.py</summary>

**Chunk 1**
Lines added: 6, lines removed: undefined

```diff
@@ -93,4 +93,10 @@
  Output Format:
  Return ONLY valid JSON matching the CardBlueprint schema. No markdown, no code blocks, no explanations."""
+ 
+         self._model = genai.GenerativeModel(
+             model_name="gemini-1.5-pro-latest",
+             system_instruction=system_instruction,
+             generation_config={"response_mime_type": "application/json"},
+         )
  
      def generate_blueprint(self, user_context_logs: list[str]) -&gt; CardBlueprint:
```

</details>

</tool-use>

---



---


Verifying the final file and checking for lint errors:


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: services/ai_architect.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="read_lints">
<details>
          <summary>Tool use: **read_lints** • Read lints for 1 file</summary>
      
Lint paths:

- `services/ai_architect.py`

Lint results


**No lint errors found**
</details>
</tool-use>

---



---


Created `services/ai_architect.py` with:

1. **CardBlueprint Pydantic Model** — All required fields:
   - `target_user_id`, `card_name_ua`, `rarity`, `biome`
   - `stats_atk`, `stats_def`, `stats_meme` (0-100 range)
   - `lore_ua` (2 sentences max with validator)
   - `raw_image_prompt_en`

2. **CardArchitectService Class**:
   - Initializes with `GEMINI_API_KEY`
   - System instruction embedded in the model initialization
   - `generate_blueprint()` method that:
     - Takes `user_context_logs: list[str]`
     - Uses `gemini-1.5-pro-latest` with JSON response format
     - Parses response with `CardBlueprint.model_validate_json()`
     - Retries once on validation errors
     - Includes error handling and structured logging

The system instruction emphasizes JSON output matching the `CardBlueprint` schema, with guidelines for rarity, biome selection, stats balance, and lore generation. The implementation follows the existing codebase patterns and uses the project's logging configuration.

---

