<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session 1354b8b3-3458-4994-acbb-c53a43b612c3 (2026-01-02 20:23Z) -->

# Card text generation and edit interface (2026-01-02 20:23Z)

_**User**_

Investigate and provide a fix to the model not generating text info on the images. Also - implement proper buttons to edit the generated card (right now it's requiring the admin to provide a json - very unfriendly)

---

_**Agent (model gpt-5.2-xhigh, mode Plan)**_

<think><details><summary>Thought Process</summary>
**Investigating model issues**

I'm currently in plan mode and I can't make edits or use any non-read-only tools until the plan gets accepted. I can read files, which is allowed. The user wants me to investigate and fix a model that's not generating text info on images, and also implement better editing buttons for generated cards. I need to check the existing flow in the admin_autocard handler, especially how it generates images and overlays with necessary text information.
**Exploring image generation issues**

In this system, it seems like a base image is generated and then text is overlaid locally. However, the overlay might be broken. The user also wants proper buttons for editing generated cards, as right now, the admin needs to send JSON to make changes. They'd prefer interactive inline keyboard buttons for each field in the card. I should check files like handlers/admin_autocard.py and services related to AI and cards. I'll read and analyze, while proposing steps for fixes. It's also important to ask the user a couple of critical questions to clarify further.
**Analyzing code files**

I'm planning to read handlers/admin_autocard.py and possibly services like art_forge.py or card_architect due to their size‚Äî1243 lines can be a lot! I think using a targeted search for terms like "text info" or "image description" could help. I'll utilize Grep for searching "image_description." Since I'm in plan mode, I can use multi_tool_use to read multiple files at once, which is great for analysis. Next, I'll also check the workspace rules.</details></think>

---

Got it. I‚Äôll first inspect the current auto-card generation flow (where text metadata is produced vs where the image is rendered), pinpoint why text info isn‚Äôt being generated/attached, then design a Telegram-friendly edit UI (inline buttons + prompts) to replace the raw JSON editing. I‚Äôm going to read the relevant handler/service files now.

---

An unknown error occurred

---

An unknown error occurred

---

An unknown error occurred

---

An unknown error occurred

---

<think><details><summary>Thought Process</summary>
**Identifying image generation issues**

I'm noticing a bug: the image generation model isn't incorporating blueprint text fields, just leaving placeholders. This could be related to the way prompts are structured in the "NanoBanana" service. It seems the final card image generation might not be including necessary blueprint JSON fields in the prompt. The system instructions state that certain text elements shouldn't be included in raw image prompts. However, when generating the final card image, these text elements are crucial, such as card names and stats. It's possible they avoided instructing the model to produce text to prevent inaccuracies, given how generative models handle text.
**Investigating image generation workflow**

The specs indicate that Option A AI-driven should produce a final card image, which includes text. However, the model might struggle with producing this text due to certain rules. I need to check `services/nano_banana.py` and `services/art_forge.py` for the image generation prompts. It's possible that the issue arises from using the wrong prompt, like `raw_image_prompt_en`, instead of a more suitable "card_render_prompt" that contains stats. In `admin_autocard.py`, the card generation method may indeed call the appropriate services for creating the image, but the current setup might miss incorporating text from the placeholders.
**Clarifying image text generation**

It seems the AI is meant to edit placeholders without adding new text, so any existing text remains. To address this, I should provide a separate prompt for the image generation model that includes all necessary textual information like names, stats, and lore. I also need to instruct the AI to maintain layout and replace placeholders while keeping the font and language consistent, including Ukrainian/English. However, since the user notes that the model isn‚Äôt generating text, it might be better to consider using a tool like Pillow for compositing text instead of relying solely on the AI. Still, I understand they might prefer the AI to manage it due to the complexity of placeholders.
**Considering text generation for card images**

The specs indicate that Option A with Nano Banana Pro should generate final card images using placeholder and user photos, meaning the AI should handle text like stats. However, a fallback local overlay can be put in place if the AI fails. The user mentioned needing a fix for the model not generating text info, which likely requires adjusting the prompt to include card details. It seems we may only be sending `blueprint.raw_image_prompt_en` to ArtForgeService without considering other fields. We should create a complete "card_render_prompt" to ensure placeholders are replaced, and we also need proper buttons for editing generated cards, as editing currently requires JSON input.
**Planning user-friendly editing features**

The goal is to create a user-friendly editing experience, like options for "Edit name," "Edit biome," or "Edit stats," potentially using inline keyboards for multi-step interaction. The specifications require that generated cards must allow editing of all fields, and after any edits, the image should automatically regenerate with updated information. While we're in planning mode for this fix, I also need to thoroughly investigate the code to pinpoint the root cause. I'll check `services/nano_banana.py`, `services/art_forge.py`, and `utils/images` to understand how prompt building works and run a Grep search for usage of "forge_card_image" or "raw_image_prompt_en."</details></think>

---

I‚Äôve found the current symptom in code matches your screenshot: the preview caption uses the generated fields, but the image regeneration path only passes `raw_image_prompt_en` (which explicitly forbids text) into the image model‚Äîso the placeholder‚Äôs ‚Äú–ù–ê–ó–í–ê –ö–ê–†–¢–ö–ò / –ü—Ä–∏–∫–ª–∞–¥ –ê—Ç–∞–∫–∏ ‚Ä¶‚Äù never gets replaced. Next I‚Äôll inspect the image-generation prompts (`services/nano_banana.py`, `services/art_forge.py`) and then outline a button-driven edit UI to replace JSON editing.

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "raw_image_prompt_en",
  "path": "h:\\repos\\pomyyka-the-game",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "raw_image_prompt_en",
    "path": "h:\\repos\\pomyyka-the-game",
    "outputMode": "content",
    "workspaceResults": {
      "h:\\repos\\pomyyka-the-game": {
        "content": {
          "matches": [
            {
              "file": "handlers\\admin_autocard.py",
              "matches": [
                {
                  "lineNumber": 487,
                  "content": "            \"raw_image_prompt_en\": blueprint.raw_image_prompt_en,"
                },
                {
                  "lineNumber": 661,
                  "content": "            blueprint_prompt=blueprint_data[\"raw_image_prompt_en\"],"
                },
                {
                  "lineNumber": 921,
                  "content": "            \"‚Ä¢ &#96;raw_image_prompt_en&#96; - –ø—Ä–æ–º–ø—Ç –¥–ª—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è (–∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é)\\n\""
                },
                {
                  "lineNumber": 1155,
                  "content": "            \"name\", \"biome\", \"rarity\", \"atk\", \"def\", \"meme\", \"lore\", \"raw_image_prompt_en\","
                }
              ]
            },
            {
              "file": "IMPLEMENTATION_SUMMARY.md",
              "matches": [
                {
                  "lineNumber": 113,
                  "content": "- &#96;raw_image_prompt_en&#96; - Image generation prompt (English)"
                }
              ]
            },
            {
              "file": "handlers\\admin.py",
              "matches": [
                {
                  "lineNumber": 641,
                  "content": "            blueprint.raw_image_prompt_en, blueprint.biome"
                }
              ]
            },
            {
              "file": "services/nano_banana.py",
              "matches": [
                {
                  "lineNumber": 338,
                  "content": "                blueprint_prompt=blueprint.raw_image_prompt_en,"
                }
              ]
            },
            {
              "file": "CARD_PLACEHOLDER_SPEC.md",
              "matches": [
                {
                  "lineNumber": 41,
                  "content": "- **Field**: Main visual area (generated from &#96;raw_image_prompt_en&#96;)"
                }
              ]
            },
            {
              "file": "handlers/admin.py",
              "matches": [
                {
                  "lineNumber": 641,
                  "content": "            blueprint.raw_image_prompt_en, blueprint.biome"
                }
              ]
            },
            {
              "file": "handlers/admin_autocard.py",
              "matches": [
                {
                  "lineNumber": 487,
                  "content": "            \"raw_image_prompt_en\": blueprint.raw_image_prompt_en,"
                },
                {
                  "lineNumber": 661,
                  "content": "            blueprint_prompt=blueprint_data[\"raw_image_prompt_en\"],"
                },
                {
                  "lineNumber": 921,
                  "content": "            \"‚Ä¢ &#96;raw_image_prompt_en&#96; - –ø—Ä–æ–º–ø—Ç –¥–ª—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è (–∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é)\\n\""
                },
                {
                  "lineNumber": 1155,
                  "content": "            \"name\", \"biome\", \"rarity\", \"atk\", \"def\", \"meme\", \"lore\", \"raw_image_prompt_en\","
                }
              ]
            },
            {
              "file": "services/card_architect.py",
              "matches": [
                {
                  "lineNumber": 26,
                  "content": "    raw_image_prompt_en: str"
                },
                {
                  "lineNumber": 162,
                  "content": "                raw_image_prompt_en=ai_blueprint.raw_image_prompt_en,"
                },
                {
                  "lineNumber": 246,
                  "content": "                raw_image_prompt_en=ai_blueprint.raw_image_prompt_en,"
                }
              ]
            },
            {
              "file": ".specstory/history/2026-01-02_19-28Z-card-info-generation-issue.md",
              "matches": [
                {
                  "lineNumber": 668,
                  "content": "              \"‚Ä¢ &amp;#96;raw_image_prompt_en&amp;#96; - –ø—Ä–æ–º–ø—Ç –¥–ª—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è (–∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é)\\n\""
                },
                {
                  "lineNumber": 711,
                  "content": "-             \"name\", \"biome\", \"rarity\", \"atk\", \"def\", \"lore\", \"raw_image_prompt_en\","
                },
                {
                  "lineNumber": 712,
                  "content": "+             \"name\", \"biome\", \"rarity\", \"atk\", \"def\", \"meme\", \"lore\", \"raw_image_prompt_en\","
                }
              ]
            },
            {
              "file": ".specstory/history/2026-01-02_19-02Z-generated-card-options.md",
              "matches": [
                {
                  "lineNumber": 338,
                  "content": "  \"plan\": \"# Card Generation Options Enhancement\\n\\n## Overview\\nAdd interactive options to the &amp;#96;/autocard&amp;#96; card generation flow, allowing admins to regenerate images and edit card fields before final approval. When fields are edited, the image automatically regenerates with the updated data.\\n\\n## Current Flow\\n1. Admin runs &amp;#96;/autocard&amp;#96; command\\n2. AI generates blueprint + image\\n3. Shows preview with two buttons: ‚úÖ Approve | ‚ùå Cancel\\n\\n## New Flow\\n1. Admin runs &amp;#96;/autocard&amp;#96; command\\n2. AI generates blueprint + image\\n3. Shows preview with FOUR buttons:\\n   - üîÑ **Regenerate Image** (keeps blueprint, generates new image)\\n   - ‚úèÔ∏è **Edit Fields** (edit all fields ‚Üí auto-regenerates image)\\n   - ‚úÖ **Approve and Add**\\n   - ‚ùå **Cancel**\\n\\n## Implementation Plan\\n\\n### 1. Update Redis Blueprint Storage\\n**File**: [&amp;#96;handlers/admin_autocard.py&amp;#96;](handlers/admin_autocard.py)\\n\\nCurrently, the blueprint data is stored in Redis without the image"
                },
                {
                  "lineNumber": 718,
                  "content": "+             blueprint_prompt=blueprint_data[\"raw_image_prompt_en\"],"
                },
                {
                  "lineNumber": 976,
                  "content": "+             \"‚Ä¢ &amp;#96;raw_image_prompt_en&amp;#96; - –ø—Ä–æ–º–ø—Ç –¥–ª—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è (–∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é)\\n\""
                },
                {
                  "lineNumber": 1212,
                  "content": "+             \"name\", \"biome\", \"rarity\", \"atk\", \"def\", \"lore\", \"raw_image_prompt_en\","
                },
                {
                  "lineNumber": 1586,
                  "content": "+ - &amp;#96;raw_image_prompt_en&amp;#96; - Image generation prompt (English)"
                },
                {
                  "lineNumber": 1928,
                  "content": "+ ‚îÇ    \"raw_image_prompt_en\": \"...\",                                ‚îÇ"
                }
              ]
            },
            {
              "file": ".specstory/history/2026-01-02_19-10Z-image-description-inconsistency.md",
              "matches": [
                {
                  "lineNumber": 192,
                  "content": "+ - The raw_image_prompt_en should describe the visual elements you see in the photo"
                }
              ]
            },
            {
              "file": "services/ai_architect.py",
              "matches": [
                {
                  "lineNumber": 59,
                  "content": "    raw_image_prompt_en: str = Field("
                },
                {
                  "lineNumber": 126,
                  "content": "- The raw_image_prompt_en should describe the visual elements you see in the photo"
                },
                {
                  "lineNumber": 142,
                  "content": "- raw_image_prompt_en: string (English) - descriptive prompt for visual elements ONLY, no game mechanics or stats, focus on appearance, style, mood, colors, composition"
                }
              ]
            },
            {
              "file": "CARD_GENERATION_FLOW.md",
              "matches": [
                {
                  "lineNumber": 228,
                  "content": "‚îÇ    \"raw_image_prompt_en\": \"...\",                                ‚îÇ"
                }
              ]
            }
          ],
          "totalLines": 30,
          "totalMatchedLines": 30
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "forge_card_image",
  "path": "h:\\repos\\pomyyka-the-game",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "forge_card_image",
    "path": "h:\\repos\\pomyyka-the-game",
    "outputMode": "content",
    "workspaceResults": {
      "h:\\repos\\pomyyka-the-game": {
        "content": {
          "matches": [
            {
              "file": "CARD_GENERATION_FLOW.md",
              "matches": [
                {
                  "lineNumber": 111,
                  "content": "            ‚îÇ   (ArtForgeService.forge_card_image)"
                }
              ]
            },
            {
              "file": "handlers/admin.py",
              "matches": [
                {
                  "lineNumber": 640,
                  "content": "        image_path = await art_forge.forge_card_image("
                }
              ]
            },
            {
              "file": "services/nano_banana.py",
              "matches": [
                {
                  "lineNumber": 337,
                  "content": "            image_path = await self.forge_card_image("
                },
                {
                  "lineNumber": 396,
                  "content": "        # Use parent's forge_card_image method which handles retries and saving"
                },
                {
                  "lineNumber": 397,
                  "content": "        return await self.forge_card_image(user_prompt, biome)"
                }
              ]
            },
            {
              "file": ".specstory/history/2026-01-02_19-02Z-generated-card-options.md",
              "matches": [
                {
                  "lineNumber": 338,
                  "content": "  \"plan\": \"# Card Generation Options Enhancement\\n\\n## Overview\\nAdd interactive options to the &amp;#96;/autocard&amp;#96; card generation flow, allowing admins to regenerate images and edit card fields before final approval. When fields are edited, the image automatically regenerates with the updated data.\\n\\n## Current Flow\\n1. Admin runs &amp;#96;/autocard&amp;#96; command\\n2. AI generates blueprint + image\\n3. Shows preview with two buttons: ‚úÖ Approve | ‚ùå Cancel\\n\\n## New Flow\\n1. Admin runs &amp;#96;/autocard&amp;#96; command\\n2. AI generates blueprint + image\\n3. Shows preview with FOUR buttons:\\n   - üîÑ **Regenerate Image** (keeps blueprint, generates new image)\\n   - ‚úèÔ∏è **Edit Fields** (edit all fields ‚Üí auto-regenerates image)\\n   - ‚úÖ **Approve and Add**\\n   - ‚ùå **Cancel**\\n\\n## Implementation Plan\\n\\n### 1. Update Redis Blueprint Storage\\n**File**: [&amp;#96;handlers/admin_autocard.py&amp;#96;](handlers/admin_autocard.py)\\n\\nCurrently, the blueprint data is stored in Redis without the image"
                },
                {
                  "lineNumber": 662,
                  "content": "Perfect! I can see the &#96;forge_card_image&#96; method signature. Now I'll add the helper function and the handlers. Let me insert them before the approve handler.&lt;/details&gt;&lt;/think&gt;"
                },
                {
                  "lineNumber": 717,
                  "content": "+         new_image_path = await art_forge.forge_card_image("
                },
                {
                  "lineNumber": 1811,
                  "content": "+             ‚îÇ   (ArtForgeService.forge_card_image)"
                }
              ]
            },
            {
              "file": "services/art_forge.py",
              "matches": [
                {
                  "lineNumber": 53,
                  "content": "    async def forge_card_image("
                }
              ]
            },
            {
              "file": "handlers\\admin.py",
              "matches": [
                {
                  "lineNumber": 640,
                  "content": "        image_path = await art_forge.forge_card_image("
                }
              ]
            },
            {
              "file": "handlers\\admin_autocard.py",
              "matches": [
                {
                  "lineNumber": 660,
                  "content": "        new_image_path = await art_forge.forge_card_image("
                }
              ]
            }
          ],
          "totalLines": 12,
          "totalMatchedLines": 12
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "NanoBananaService",
  "path": "h:\\repos\\pomyyka-the-game",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "NanoBananaService",
    "path": "h:\\repos\\pomyyka-the-game",
    "outputMode": "content",
    "workspaceResults": {
      "h:\\repos\\pomyyka-the-game": {
        "content": {
          "matches": [
            {
              "file": "CARD_GENERATION_FLOW.md",
              "matches": [
                {
                  "lineNumber": 108,
                  "content": "            ‚îÇ   (NanoBananaService._get_placeholder_path)"
                }
              ]
            },
            {
              "file": "IMPLEMENTATION_SUMMARY.md",
              "matches": [
                {
                  "lineNumber": 170,
                  "content": "- &#96;services.nano_banana.NanoBananaService&#96; for placeholder paths"
                }
              ]
            },
            {
              "file": "handlers/admin_autocard.py",
              "matches": [
                {
                  "lineNumber": 27,
                  "content": "from services.nano_banana import NanoBananaService"
                },
                {
                  "lineNumber": 452,
                  "content": "        # Use NanoBananaService for complete AI-driven generation"
                },
                {
                  "lineNumber": 453,
                  "content": "        nano_banana = NanoBananaService()"
                },
                {
                  "lineNumber": 647,
                  "content": "        nano_banana = NanoBananaService()"
                }
              ]
            },
            {
              "file": "handlers\\admin.py",
              "matches": [
                {
                  "lineNumber": 38,
                  "content": "from services.nano_banana import NanoBananaService"
                },
                {
                  "lineNumber": 197,
                  "content": "        # Use NanoBananaService for manual image generation"
                },
                {
                  "lineNumber": 198,
                  "content": "        nano_banana = NanoBananaService()"
                }
              ]
            },
            {
              "file": ".specstory/history/2026-01-02_19-02Z-generated-card-options.md",
              "matches": [
                {
                  "lineNumber": 122,
                  "content": "Let me search for more details about the NanoBananaService to understand how image generation works.&lt;/details&gt;&lt;/think&gt;"
                },
                {
                  "lineNumber": 338,
                  "content": "  \"plan\": \"# Card Generation Options Enhancement\\n\\n## Overview\\nAdd interactive options to the &amp;#96;/autocard&amp;#96; card generation flow, allowing admins to regenerate images and edit card fields before final approval. When fields are edited, the image automatically regenerates with the updated data.\\n\\n## Current Flow\\n1. Admin runs &amp;#96;/autocard&amp;#96; command\\n2. AI generates blueprint + image\\n3. Shows preview with two buttons: ‚úÖ Approve | ‚ùå Cancel\\n\\n## New Flow\\n1. Admin runs &amp;#96;/autocard&amp;#96; command\\n2. AI generates blueprint + image\\n3. Shows preview with FOUR buttons:\\n   - üîÑ **Regenerate Image** (keeps blueprint, generates new image)\\n   - ‚úèÔ∏è **Edit Fields** (edit all fields ‚Üí auto-regenerates image)\\n   - ‚úÖ **Approve and Add**\\n   - ‚ùå **Cancel**\\n\\n## Implementation Plan\\n\\n### 1. Update Redis Blueprint Storage\\n**File**: [&amp;#96;handlers/admin_autocard.py&amp;#96;](handlers/admin_autocard.py)\\n\\nCurrently, the blueprint data is stored in Redis without the image"
                },
                {
                  "lineNumber": 704,
                  "content": "+         nano_banana = NanoBananaService()"
                },
                {
                  "lineNumber": 1643,
                  "content": "+ - &amp;#96;services.nano_banana.NanoBananaService&amp;#96; for placeholder paths"
                },
                {
                  "lineNumber": 1808,
                  "content": "+             ‚îÇ   (NanoBananaService._get_placeholder_path)"
                }
              ]
            },
            {
              "file": "handlers/admin.py",
              "matches": [
                {
                  "lineNumber": 38,
                  "content": "from services.nano_banana import NanoBananaService"
                },
                {
                  "lineNumber": 197,
                  "content": "        # Use NanoBananaService for manual image generation"
                },
                {
                  "lineNumber": 198,
                  "content": "        nano_banana = NanoBananaService()"
                }
              ]
            },
            {
              "file": ".specstory/history/2026-01-02_16-25Z-autocard-photo-generation-feature.md",
              "matches": [
                {
                  "lineNumber": 117,
                  "content": "                &lt;summary&gt;Tool use: **codebase_search** ‚Ä¢ Searched codebase \"How does NanoBananaService generate cards with photos or images?\" ‚Ä¢ **12** results&lt;/summary&gt;"
                },
                {
                  "lineNumber": 506,
                  "content": "+         nano_banana = NanoBananaService()"
                },
                {
                  "lineNumber": 515,
                  "content": "+             nano_banana = NanoBananaService()"
                },
                {
                  "lineNumber": 576,
                  "content": "Fixing duplicate NanoBananaService instantiation:"
                },
                {
                  "lineNumber": 614,
                  "content": "-         nano_banana = NanoBananaService()"
                },
                {
                  "lineNumber": 628,
                  "content": "-             nano_banana = NanoBananaService()"
                },
                {
                  "lineNumber": 843,
                  "content": "### 1. **Updated &#96;NanoBananaService&#96;** (&#96;services/nano_banana.py&#96;)"
                }
              ]
            },
            {
              "file": ".specstory/history/2026-01-02_19-15Z-animated-gif-playback-issues.md",
              "matches": [
                {
                  "lineNumber": 692,
                  "content": "  from services.nano_banana import NanoBananaService"
                }
              ]
            },
            {
              "file": "services/nano_banana.py",
              "matches": [
                {
                  "lineNumber": 27,
                  "content": "class NanoBananaService(ArtForgeService):"
                },
                {
                  "lineNumber": 36,
                  "content": "        Initialize NanoBananaService."
                },
                {
                  "lineNumber": 46,
                  "content": "        logger.info(\"NanoBananaService initialized (AI-driven card generation)\")"
                }
              ]
            },
            {
              "file": ".specstory/history/2026-01-02_19-10Z-image-description-inconsistency.md",
              "matches": [
                {
                  "lineNumber": 42,
                  "content": "- &#96;NanoBananaService&#96; is the AI-driven card generation service"
                }
              ]
            },
            {
              "file": "services/__init__.py",
              "matches": [
                {
                  "lineNumber": 6,
                  "content": "from services.nano_banana import NanoBananaService"
                },
                {
                  "lineNumber": 14,
                  "content": "    \"NanoBananaService\","
                }
              ]
            },
            {
              "file": "handlers\\admin_autocard.py",
              "matches": [
                {
                  "lineNumber": 27,
                  "content": "from services.nano_banana import NanoBananaService"
                },
                {
                  "lineNumber": 452,
                  "content": "        # Use NanoBananaService for complete AI-driven generation"
                },
                {
                  "lineNumber": 453,
                  "content": "        nano_banana = NanoBananaService()"
                },
                {
                  "lineNumber": 647,
                  "content": "        nano_banana = NanoBananaService()"
                }
              ]
            }
          ],
          "totalLines": 35,
          "totalMatchedLines": 35
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

An unknown error occurred

---

An unknown error occurred

---

<think><details><summary>Thought Process</summary>
**Evaluating text rendering options**

I‚Äôm considering how to keep exact Ukrainian text and numbers intact. Generative models aren't great at placing exact text, but they might work. Instead, I could use the Python Imaging Library (PIL) to overlay text on a generated card image. Currently, we rely on AI for the whole card, but I could adjust the workflow to generate just the artwork without text. Then, I‚Äôd render it into a placeholder and manually add the text for consistency. I'll check CARD_PLACEHOLDER_SPEC.md for specifications.</details></think>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** ‚Ä¢ Read file: h:\repos\pomyyka-the-game\CARD_PLACEHOLDER_SPEC.md</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Considering card rendering solutions**

I‚Äôm noticing that the spec doesn‚Äôt define coordinates, and I have two potential solutions to consider. First, I could improve the AI prompt to include card text values to render them correctly. This might be risky due to text accuracy, but it fits the requirements. Alternatively, I could use deterministic rendering with Pillow, taking a template image and overlaying text. However, I‚Äôm unsure about finding text boxes without defined coordinates, which might take time. Storing coordinates could help but still poses challenges.
**Updating model generation approach**

The user's request about the model not generating text info on images seems to point toward needing a fix in the prompt. I also need to consider a friendly editing UI for updating the blueprint and auto-regeneration. This regeneration will now use the ArtForgeService and incorporate textual info, prompting me to update the forging function signature to accept full blueprint data or an optional "card_text" structure. I think a good solution involves creating a new prompt string that includes a visual description and card metadata with clear editing instructions for placeholders.
**Improving generative model instructions**

I‚Äôm realizing that the generative model may not always guarantee exact strings, but it should make an attempt. I could consider adding a "post-check" step using OCR, like pytesseract, to verify the generated text. However, that adds an extra dependency, which might not be necessary. Instead, I could implement a fallback to check for placeholder text using pixel scanning if OCR isn‚Äôt available. A simpler approach might be to adjust the prompt to explicitly mention replacing placeholders, which could enhance the instructions significantly.
**Planning card image generation**

I need to ensure we provide the necessary values, so I‚Äôll modify the `forge_card_image` function to accept card fields. Currently, it‚Äôs called from `NanoBananaService.generate_card_for_user` and the regenerate function. While I can‚Äôt change call sites in plan mode yet, I can still plan this out. I should examine the image generation sections in `handlers/admin.py`, particularly around line 640, as it might offer insights into manual card generation that could be helpful.</details></think>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** ‚Ä¢ Read file: h:\repos\pomyyka-the-game\handlers\admin.py</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Planning card editing features**

The user mentioned that the current JSON-based editing process is unfriendly since it requires admin access. I‚Äôm thinking about implementing at least the top-level fields: name, biome, rarity, attack (atk), defense (def), meme, lore, and raw_image_prompt_en. It seems like attacks need to be included later too. There‚Äôs a lot to consider, especially with implementation complexity regarding Telegram‚Äôs size limits and the use of CallbackData for editing fields while adhering to data constraints.
**Refining field editing design**

If I include the field, it adds a small string, which is manageable. I‚Äôm thinking about creating a separate CallbackData prefix, like "autocard_edit," which includes the blueprint_id and the field name. The total should stay within the 64-byte limit, considering that blueprint_id is 36 characters. I need to be cautious with separators, but I can keep the values small, ensuring everything stays under 60 bytes. Also, editing messages could reduce spam instead of sending new ones; this could streamline the user experience.
**Considering user interface options**

I‚Äôm thinking about creating a separate "control panel" message with an inline keyboard that shows current values. Editing the caption could include both a summary and instructions, as Telegram allows up to 1024 characters for photo captions, which should fit. However, we risk losing the original description if we modify it too much. An alternative is to send a separate message titled "–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –ü–æ–ª—ñ–≤ –ö–∞—Ä—Ç–∫–∏" with the keyboard. Editing existing messages is preferable to minimize spam, though creating a new message might be simpler since the preview may be outdated. I'll also need to regenerate the image after editing.
**Evaluating message handling**

I‚Äôm considering that we might want to delete the old message and send a new preview when regenerating. However, the current approach leads to spam, and the rule states that editing existing messages is preferred. For media changes, I could use `edit_media` or `edit_message_media` to update without deleting. But the existing code deletes the message first, which results in errors like "creation cancelled." I need to follow the rule that callback handlers should edit existing messages and avoid sending new ones.
**Revising message regeneration approach**

The current regenerate handler deletes the old message to send a new preview, which might violate our rules. Instead, we should edit the existing message using `edit_media` or `edit_message_media`. I could update the media and its caption to streamline the process. We need to consider whether the original message is an animation or a photo and track rarity accordingly. 

When the admin clicks "Edit fields," we can display an editing mode with current values, maintaining the preview caption and simply changing the inline keyboard. This should follow the rule about editing messages to reduce spam. For input fields, we might prompt the admin to send a new value, which might involve setting a state to ensure clarity.
**Updating preview message handling**

I‚Äôm thinking it might be useful to keep the caption when the admin presses "Edit name." The bot could then edit the caption to include instructions like "‚úèÔ∏è –í–≤–µ–¥—ñ—Ç—å –Ω–æ–≤—É –Ω–∞–∑–≤—É (–¥–æ X —Å–∏–º–≤–æ–ª—ñ–≤), —É –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—ñ. –ü–æ—Ç–æ—á–Ω–∞: ...". I need to set the state to waiting_for_field_input so I can track which message to update later.

To manage multiple previews better, I should store the preview message identifiers in the blueprint data when sending prompts. Capturing the returned Message object from `message.answer_photo` will help me do that effectively. I should also check if the send_card_animation helper returns a Message for animations.</details></think>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** ‚Ä¢ Read file: h:\repos\pomyyka-the-game\utils\animations.py</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Exploring card editing implementation**

I‚Äôm working on the `process_card_edit_json` function, which currently includes the `bot` parameter. I‚Äôll add a message handler for field input with the bot and track the preview message ID for editing sessions. If an admin leaves and returns, their state will be lost, but they can restart editing by clicking. I also want to enable editing via buttons, using callbacks to update the preview message directly. Additionally, I need to address an issue where the model isn't generating text info on images due to lacking actual text values; I plan to introduce a "render prompt" builder for improved organization.
**Updating prompt generation logic**

I need to update the call sites to build a prompt string using `blueprint_data`, which would fill in the placeholders. This function should help both for initial generation and for regenerating after edits. In the `NanoBananaService.generate_card_for_user`, I‚Äôll adjust the call to `forge_card_image` so it passes a combined `blueprint_prompt`. This prompt will include elements such as user photos and text data while enhancing instructions for image generation. I could keep the original `forge_card_image` signature, but building the prompt with all necessary information might be simpler.
**Reviewing prompt handling**

I see that the `full_prompt` already includes the style guide and has a section for "Subject: {blueprint_prompt}". If `blueprint_prompt` has many lines with braces and colons, that‚Äôs okay, but it could impact style or even exceed the token limit. We need to make sure we don‚Äôt disrupt the original intention of `raw_image_prompt_en` being visual. However, since this combined prompt is solely for image generation, I‚Äôll need to adjust the regenerate path to pass this new format. I think implementing a `build_card_image_prompt(blueprint_data)` helper in ArtForgeService will be the way to go.
**Enhancing image generation instructions**

I‚Äôm considering whether to include extra instructions alongside the subject description. In `_generate_image_sync`, if there are placeholders or photos, it already appends "IMPORTANT INSTRUCTIONS FOR IMAGE GENERATION" with bullet points. I could augment that by adding bullets for replacing placeholders and including exact text. The best approach might be to embed card info within the `blueprint_prompt` as part of the subject. However, I should keep the card info separate in the "IMPORTANT instructions" block to avoid confusion. I might also need to modify `_generate_image_sync` to accept optional `card_text` for clearer instructions.
**Modifying image generation parameters**

As part of our planning, I propose modifying the `forge_card_image` signature to accept an optional structured object, like a dictionary. This means updating all the call sites, but that seems manageable. For instance, `ArtForgeService.forge_card_image` is used in `NanoBananaService.generate_card_for_user` and in `handlers/admin.py`. I can add a new parameter, `card_text: dict | None = None`, without breaking existing calls. 

I‚Äôll also implement a prompt builder to include details like the card's name in Ukrainian, biome label with emoji, and rarity indicator. I need to check how to properly format these.</details></think>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** ‚Ä¢ Read file: h:\repos\pomyyka-the-game\database\enums.py</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Clarifying rarity values and stats**

I want to make sure I'm creating rarity values correctly in English. I‚Äôm thinking about formatting like "üî¥ MYTHIC" or "üî¥ Mythic" ‚Äî the rules say to use the exact format of "üî¥ MYTHIC," so I'll stick with that.

For the stats, placeholders like "‚öîÔ∏è ATK: 50" are mentioned, and I must align with that. The card template may use Ukrainian labels, but it sounds like I can match those stats.

As for attacks, I see examples like "–ü—Ä–∏–∫–ª–∞–¥ –ê—Ç–∞–∫–∏ 1" and will need to format those correctly, though I might not have icons to show.
**Representing energy cost and instructions**

I‚Äôm considering how to represent energy costs, maybe using repeated energy symbols like lightning icons that I see in the screenshot next to attack names. I think those icons may vary by biome, but I can suggest using consistent energy icons based on attack types and energy cost.

I could instruct to replace attack names and damage numbers, optionally adding effect text while preserving icons from the template. 

For lore, it looks like the blueprint is in Ukrainian and may have a length limit of two sentences. I‚Äôll also check the print date and details about weaknesses and resistances.
**Updating weakness and resistance icons**

The card template seems to show weakness and resistance icons in the corners, possibly with small numbers, like "x2" for weakness on the bottom left and "-20" for resistance on the bottom right. I think we can instruct updates for these if the placeholders have them. The blueprint data includes weakness and resistance, which I can format as "Weakness: {attack_type} x{multiplier}" and "Resistance: {attack_type} -{reduction}." 

While ensuring that the card image includes essential text fields like name, stats, and lore, I want to make the prompt for image generation clear, stressing that "exact text is crucial." We might also implement a local overlay as a fallback for the text fields.
**Approximating coordinates for placeholder images**

I don‚Äôt know the exact coordinates, but I could estimate them using the placeholder template size, which appears to be 1080x1920. I think I can check the placeholder files, but running code might not be possible.

In plan mode, I might be able to read the image files, even though they seem quite large. The user specifically asked for a fix to the model not generating text info, but they might be okay with a prompt adjustment.

I should propose a solid approach: updating the prompt and doing a quick check to ensure placeholders are replaced. Without OCR, checking is tricky, but I can ensure the card info is included in the prompt and instruct the replacement of placeholder texts. I‚Äôll also look into `save_generated_image` in utils/images.py for the output format.</details></think>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** ‚Ä¢ Read file: h:\repos\pomyyka-the-game\utils\images.py</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Planning button-based editing UI**

I'm thinking about implementing a button-based editing UI now. My plan is to look into the modifications needed in handlers/admin_autocard.py. I might also need to create or inspect the existing file in utils/keyboards.py. There's already a utils/keyboards.py, so I need to check what‚Äôs in there first. I'll figure out how to connect everything smoothly. Let's see where this leads!</details></think>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** ‚Ä¢ Read file: h:\repos\pomyyka-the-game\utils\keyboards.py</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Proposing image prompt updates**

I notice that the caption in the screenshot displays values, suggesting the blueprint generation needs adjustment. So, I‚Äôm thinking we should enhance the prompt in `ArtForgeService._generate_image_sync` to include a line like "CARD DATA (must be printed on the card): ..." as a JSON block. It should be in English to help the model understand, though we can include Ukrainian text values. This generative editing needs clearer instructions to replace placeholders effectively. I‚Äôll explore `types.EditImageConfig` or "image editing" to ensure it produces the correct output.
**Examining image editing functionality**

It seems there isn't an explicit editing mode, but using a placeholder as input might effectively act as one. The potential issue could be the reading order‚Äîmaybe the placeholder isn't correctly positioned relative to the prompt in `_generate_image_sync`. They append the placeholder image first, followed by the user and group photos, then add the text prompt, which should work, but I‚Äôm wondering if the placeholder is too large or invalid. I‚Äôll also need to implement the editing UI to interact with `blueprint_data`, update values, and regenerate the image while storing updates in Redis.
**Improving card preview functionality**

It looks like I need to fix the caption to include meme stats since the current `_send_card_preview` is missing this detail. There's also inconsistency with `handle_autocard_edit` showing meme values, but the preview caption does not. Although it's not a requested feature, maybe we should make it optional. The placeholder text in the screenshot shows inconsistent stats. To resolve this, I‚Äôll incorporate the blueprint fields into the image and might also include `dominant_color_hex` and accent colors in the prompt. Additionally, I can provide clear instructions for replacing fields in the template under "CARD_FILLS."
**Planning card editing features**

We could include the print date at the bottom center and adopt a placeholder specification with explicit placeholders like "–ù–ê–ó–í–ê –ö–ê–†–¢–ö–ò" and "‚öîÔ∏è ATK: 50." We can replace these strings, though the exact placeholders may vary across templates. Now, concerning user requests for proper buttons to edit generated cards, this is a significant feature. I need to plan and ask the user about their design preferences. I could ask a couple of questions, such as whether they prefer editing through inline keyboard menus or a separate conversation, and which fields should have buttons.
**Deciding on text implementation**

There's a developer instruction not to confirm assumptions but instead document and act on them, though the plan mode suggests asking the user for clarification when ambiguous situations arise. Since there are multiple valid implementations, I need to ask the user whether they prefer AI text rendering or a local overlay. Given the user‚Äôs request about the model not generating text info, we could fix prompts for AI improvements or choose an overlay for reliability. I think overlaying new text on placeholders with defined coordinates could work well, but there's potential for complexity. I lean towards overlaying due to accuracy, especially since the game is in Ukrainian. However, I‚Äôll review existing code to determine the best resolution.
**Exploring hybrid overlay solution**

I‚Äôm considering a hybrid approach where we instruct the AI to generate the card image and then programmatically overlay the correct text fields onto that image. This means even if the AI fails to render text, our overlay will be visible. To do this, I need the coordinates and fonts, but I can derive the bounding boxes by analyzing placeholder templates. Since the aspect ratios and dimensions may vary, it‚Äôs key to confirm the actual output size. I‚Äôll check the `media/cards` directory to find any generated image samples.</details></think>

---

<tool-use data-tool-type="unknown" data-tool-name="list_dir_v2">
<details>
<summary>Tool use: **list_dir_v2**</summary>


Parameters:

```json
{
  "targetDirectory": "h:\\repos\\pomyyka-the-game"
}
```
Result:

```json
{
  "directoryTreeRoot": {
    "absPath": "h:\\repos\\pomyyka-the-game",
    "childrenDirs": [
      {
        "absPath": "h:\\repos\\pomyyka-the-game\\.cursor",
        "childrenDirs": [
          {
            "absPath": "h:\\repos\\pomyyka-the-game\\.cursor\\rules",
            "childrenFiles": [
              {
                "name": "derived-cursor-rules.mdc"
              }
            ],
            "childrenWereProcessed": true
          }
        ],
        "childrenWereProcessed": true
      },
      {
        "absPath": "h:\\repos\\pomyyka-the-game\\.github",
        "childrenDirs": [
          {
            "absPath": "h:\\repos\\pomyyka-the-game\\.github\\workflows",
            "childrenFiles": [
              {
                "name": "test.yml"
              }
            ],
            "childrenWereProcessed": true
          }
        ],
        "childrenWereProcessed": true
      },
      {
        "absPath": "h:\\repos\\pomyyka-the-game\\.specstory",
        "childrenDirs": [
          {
            "absPath": "h:\\repos\\pomyyka-the-game\\.specstory\\history",
            "childrenFiles": [
              {
                "name": "2026-01-01_21-56Z-—Ö—Ä–æ–Ω—ñ–∫–∏-–ø–æ–º–∏–π–∫–∏-bot-initial-setup.md"
              },
              {
                "name": "2026-01-01_22-30Z-database-schema-and-biome-utility.md"
              },
              {
                "name": "2026-01-01_22-33Z-drop-claiming-race-condition-prevention.md"
              },
              {
                "name": "2026-01-01_22-34Z-chat-group-tracking-and-drop-claiming.md"
              },
              {
                "name": "2026-01-01_22-37Z-random-drops-scheduler-implementation.md"
              },
              {
                "name": "2026-01-01_22-39Z-admin-card-creation-flow.md"
              },
              {
                "name": "2026-01-01_22-45Z-group-chat-message-logging.md"
              },
              {
                "name": "2026-01-01_22-51Z-gemini-art-forge-service.md"
              }
            ],
            "fullSubtreeExtensionCounts": {
              ".md": 45
            },
            "numFiles": 45
          }
        ],
        "childrenFiles": [
          {
            "name": ".gitignore"
          }
        ],
        "fullSubtreeExtensionCounts": {
          ".md": 45
        },
        "numFiles": 45
      },
      {
        "absPath": "h:\\repos\\pomyyka-the-game\\assets",
        "childrenDirs": [
          {
            "absPath": "h:\\repos\\pomyyka-the-game\\assets\\placeholders",
            "childrenFiles": [
              {
                "name": "DARK_COMMON.png"
              },
              {
                "name": "DARK_EPIC.png"
              },
              {
                "name": "DARK_LEGENDARY.png"
              },
              {
                "name": "DARK_MYTHIC.png"
              },
              {
                "name": "DARK_RARE.png"
              },
              {
                "name": "FIRE_COMMON.png"
              },
              {
                "name": "FIRE_EPIC.png"
              },
              {
                "name": "FIRE_LEGENDARY.png"
              },
              {
                "name": "FIRE_MYTHIC.png"
              },
              {
                "name": "FIRE_RARE.png"
              },
              {
                "name": "GRASS_COMMON.png"
              },
              {
                "name": "GRASS_EPIC.png"
              },
              {
                "name": "GRASS_LEGENDARY.png"
              },
              {
                "name": "GRASS_MYTHIC.png"
              },
              {
                "name": "GRASS_RARE.png"
              },
              {
                "name": "NORMAL_COMMON.webp"
              },
              {
                "name": "NORMAL_EPIC.webp"
              },
              {
                "name": "NORMAL_LEGENDARY.webp"
              },
              {
                "name": "NORMAL_MYTHIC.webp"
              },
              {
                "name": "NORMAL_RARE.webp"
              },
              {
                "name": "PSYCHIC_COMMON.png"
              },
              {
                "name": "PSYCHIC_EPIC.png"
              },
              {
                "name": "PSYCHIC_LEGENDARY.png"
              },
              {
                "name": "PSYCHIC_MYTHIC.png"
              },
              {
                "name": "PSYCHIC_RARE.png"
              },
              {
                "name": "TECHNO_COMMON.png"
              },
              {
                "name": "TECHNO_EPIC.png"
              },
              {
                "name": "TECHNO_LEGENDARY.png"
              },
              {
                "name": "TECHNO_MYTHIC.png"
              },
              {
                "name": "TECHNO_RARE.png"
              },
              {
                "name": "WATER_COMMON.png"
              },
              {
                "name": "WATER_EPIC.png"
              },
              {
                "name": "WATER_LEGENDARY.png"
              },
              {
                "name": "WATER_MYTHIC.png"
              },
              {
                "name": "WATER_RARE.png"
              }
            ],
            "childrenWereProcessed": true
          }
        ],
        "childrenWereProcessed": true
      },
      {
        "absPath": "h:\\repos\\pomyyka-the-game\\data",
        "childrenDirs": [
          {
            "absPath": "h:\\repos\\pomyyka-the-game\\data\\chat_exports",
            "childrenFiles": [
              {
                "name": ".gitkeep"
              }
            ],
            "childrenWereProcessed": true
          }
        ],
        "childrenWereProcessed": true
      },
      {
        "absPath": "h:\\repos\\pomyyka-the-game\\database",
        "childrenFiles": [
          {
            "name": "__init__.py"
          },
          {
            "name": "enums.py"
          },
          {
            "name": "models.py"
          },
          {
            "name": "session.py"
          }
        ],
        "childrenWereProcessed": true
      },
      {
        "absPath": "h:\\repos\\pomyyka-the-game\\handlers",
        "childrenFiles": [
          {
            "name": "__init__.py"
          },
          {
            "name": "admin_autocard.py"
          },
          {
            "name": "admin.py"
          },
          {
            "name": "battles.py"
          },
          {
            "name": "drops.py"
          },
          {
            "name": "inline.py"
          },
          {
            "name": "player.py"
          },
          {
            "name": "trading.py"
          }
        ],
        "childrenWereProcessed": true
      },
      {
        "absPath": "h:\\repos\\pomyyka-the-game\\middlewares",
        "childrenFiles": [
          {
            "name": "__init__.py"
          },
          {
            "name": "group_tracker.py"
          },
          {
            "name": "logger.py"
          },
          {
            "name": "user_registration.py"
          }
        ],
        "childrenWereProcessed": true
      },
      {
        "absPath": "h:\\repos\\pomyyka-the-game\\services",
        "childrenFiles": [
          {
            "name": "__init__.py"
          },
          {
            "name": "ai_architect.py"
          },
          {
            "name": "art_forge.py"
          },
          {
            "name": "battle_engine.py"
          },
          {
            "name": "card_animator.py"
          },
          {
            "name": "card_architect.py"
          },
          {
            "name": "chat_import.py"
          },
          {
            "name": "cleanup.py"
          },
          {
            "name": "nano_banana.py"
          },
          {
            "name": "redis_lock.py"
          },
          {
            "name": "scheduler.py"
          },
          {
            "name": "session_manager.py"
          }
        ],
        "childrenWereProcessed": true
      },
      {
        "absPath": "h:\\repos\\pomyyka-the-game\\tests",
        "childrenDirs": [
          {
            "absPath": "h:\\repos\\pomyyka-the-game\\tests\\database",
            "childrenFiles": [
              {
                "name": "__init__.py"
              },
              {
                "name": "test_models.py"
              },
              {
                "name": "test_session.py"
              }
            ],
            "childrenWereProcessed": true
          },
          {
            "absPath": "h:\\repos\\pomyyka-the-game\\tests\\handlers",
            "childrenFiles": [
              {
                "name": "__init__.py"
              },
              {
                "name": "test_drops.py"
              }
            ],
            "childrenWereProcessed": true
          },
          {
            "absPath": "h:\\repos\\pomyyka-the-game\\tests\\integration",
            "childrenFiles": [
              {
                "name": "__init__.py"
              },
              {
                "name": "test_battle_flow.py"
              },
              {
                "name": "test_drop_flow.py"
              }
            ],
            "childrenWereProcessed": true
          },
          {
            "absPath": "h:\\repos\\pomyyka-the-game\\tests\\middlewares",
            "childrenFiles": [
              {
                "name": "__init__.py"
              },
              {
                "name": "test_user_registration.py"
              }
            ],
            "childrenWereProcessed": true
          },
          {
            "absPath": "h:\\repos\\pomyyka-the-game\\tests\\services",
            "childrenFiles": [
              {
                "name": "__init__.py"
              },
              {
                "name": "test_battle_engine.py"
              },
              {
                "name": "test_cleanup.py"
              },
              {
                "name": "test_redis_lock.py"
              },
              {
                "name": "test_scheduler.py"
              }
            ],
            "childrenWereProcessed": true
          },
          {
            "absPath": "h:\\repos\\pomyyka-the-game\\tests\\utils",
            "childrenFiles": [
              {
                "name": "__init__.py"
              },
              {
                "name": "test_biomes.py"
              },
              {
                "name": "test_card_ids.py"
              },
              {
                "name": "test_commands.py"
              },
              {
                "name": "test_emojis.py"
              },
              {
                "name": "test_text.py"
              }
            ],
            "childrenWereProcessed": true
          }
        ],
        "childrenFiles": [
          {
            "name": "__init__.py"
          },
          {
            "name": "conftest.py"
          },
          {
            "name": "README.md"
          }
        ],
        "childrenWereProcessed": true
      },
      {
        "absPath": "h:\\repos\\pomyyka-the-game\\utils",
        "childrenFiles": [
          {
            "name": "__init__.py"
          },
          {
            "name": "animations.py"
          },
          {
            "name": "biomes.py"
          },
          {
            "name": "card_ids.py"
          },
          {
            "name": "commands.py"
          },
          {
            "name": "emojis.py"
          },
          {
            "name": "images.py"
          },
          {
            "name": "keyboards.py"
          },
          {
            "name": "telegram_utils.py"
          },
          {
            "name": "text.py"
          }
        ],
        "childrenWereProcessed": true
      }
    ],
    "childrenFiles": [
      {
        "name": ".coveragerc"
      },
      {
        "name": ".cursorignore"
      },
      {
        "name": ".cursorindexingignore"
      },
      {
        "name": ".gitignore"
      },
      {
        "name": ".pre-commit-config.yaml"
      },
      {
        "name": "add_fade_edges.py"
      },
      {
        "name": "ANIMATION_FIX_SUMMARY.md"
      },
      {
        "name": "ANIMATION_ISSUES_ANALYSIS.md"
      },
      {
        "name": "CARD_GENERATION_FLOW.md"
      },
      {
        "name": "CARD_PLACEHOLDER_SPEC.md"
      },
      {
        "name": "config.py"
      },
      {
        "name": "convert_to_mp4.py"
      },
      {
        "name": "convert_webp_to_gif.py"
      },
      {
        "name": "create_animated_webp.py"
      },
      {
        "name": "delete_old_animations.py"
      },
      {
        "name": "docker-compose.yml"
      },
      {
        "name": "Dockerfile"
      },
      {
        "name": "enhance_card_borders.py"
      },
      {
        "name": "IMPLEMENTATION_SUMMARY.md"
      },
      {
        "name": "logging_config.py"
      },
      {
        "name": "main.py"
      },
      {
        "name": "plan-doc.md"
      },
      {
        "name": "PROMPTS_FOR_AI_STUDIO.md"
      },
      {
        "name": "pyproject.toml"
      },
      {
        "name": "pytest.ini"
      },
      {
        "name": "README.md"
      },
      {
        "name": "regenerate_all_animations.py"
      },
      {
        "name": "regenerate_animations.py"
      },
      {
        "name": "regenerate_placeholder_animations.py"
      },
      {
        "name": "remove_white_borders.py"
      },
      {
        "name": "VIDEO_EFFECTS_TEMPLATES.md"
      },
      {
        "name": "WEBP_1080P_MIGRATION_SUMMARY.md"
      }
    ],
    "fullSubtreeExtensionCounts": {
      ".md": 45
    },
    "numFiles": 45
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** ‚Ä¢ Read file: h:\repos\pomyyka-the-game\services\session_manager.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "store_blueprint",
  "path": "h:\\repos\\pomyyka-the-game\\services\\session_manager.py",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "store_blueprint",
    "path": "h:\\repos\\pomyyka-the-game\\services\\session_manager.py",
    "outputMode": "content",
    "workspaceResults": {
      "h:\\repos\\pomyyka-the-game": {
        "content": {
          "matches": [
            {
              "file": "services\\session_manager.py",
              "matches": [
                {
                  "lineNumber": 519,
                  "content": "    async def store_blueprint(self, blueprint_data: dict, ttl: int = 3600) -&gt; str:"
                }
              ]
            }
          ],
          "totalLines": 1,
          "totalMatchedLines": 1
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** ‚Ä¢ Read file: h:\repos\pomyyka-the-game\services\session_manager.py</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Identifying Code Issues**

I‚Äôm focused on text info rather than images in the editing UI. However, I've discovered a bug: the blueprint update isn‚Äôt using the same ID. I‚Äôll need to create an `update_blueprint` method or modify `store_blueprint` to accept an optional `blueprint_id`, which is a necessary code change. There's another bug with `_regenerate_card_image` where the docstring says it returns a tuple but actually returns just a string or None. Not crucial, but still important.
**Updating Editing Menu Functionality**

In the editing menu, I'm thinking about using a new callback prefix, maybe "autocard_edit," which will include `blueprint_id`, `field`, and possibly `value`. I‚Äôll also ensure that `safe_callback_answer` is utilized. Our updated `blueprint_data` should have essential fields, including attacks and resistances. 

I need to fix the ‚Äútext info not generated on images‚Äù issue, possibly affected by `blueprint_prompt`. I should also check if `placeholder_path` is passed correctly since it comes from `_get_placeholder_path`. There's a call to `self.forge_card_image`, which ties back to building the prompt and passing context images. I‚Äôll focus on adding card fields to the full prompt.
**Adding Parameters for Card Text**

I'm thinking about introducing a new parameter, `card_text_data`, to be used in `forge_card_image` and passed to `_generate_image_sync`. When building the `enhanced_prompt`, I‚Äôll include instructions for how card text should appear, structured like this:

- CARD_NAME_UA: "–§–∞–π–ª–∏ –ï–ø—à—Ç–µ–π–Ω–∞"
- BIOME_LABEL: "üåë –¢–µ–º–Ω–∏–π"
- RARITY_BADGE: "üî¥ MYTHIC"
- etc.

I need to ensure we instruct, "Do not invent text. Replace placeholders entirely." It might be helpful to add `dominant_color_hex` and `accent_color_hex` for gradient suggestions. Plus, the editing UI will need a text input for these fields, likely requiring new FSM states.
**Updating Card Edit States**

I'm looking to update the `CardEditStates` by replacing `waiting_for_json` with more specific states like `waiting_for_text_value` and `waiting_for_number_value`. Alternatively, I could use a generic `waiting_for_value` that stores the field type. For editing attacks, I might need nested states, but keeping it simpler is better. 

I‚Äôll implement the `waiting_for_value` state and store field information as well as attack index. When an admin selects "Edit attack 1 name," I‚Äôll set the state with that info. Over time, I can add a minimal subset of attack editing options like name, damage, effect, energy cost, and type. I'll provide inline keyboards to avoid typed values where possible. Also, I need to ensure that the `blueprint_data` attacks list matches the Pydantic model structure.
**Regenerating Card Images Explained**

To regenerate an image post-edit, I‚Äôll call `_regenerate_card_image`, which currently only uses `blueprint_data["raw_image_prompt_en"]` and doesn‚Äôt utilize user or group photos. I think we should preserve the style by keeping those photos as references. However, `blueprint_data` needs to store photo bytes for this. 

There‚Äôs a bug since the signature returns a tuple but doesn‚Äôt reflect this. For updating, I plan to create a new method for updating blueprints and ensure our storage updates existing IDs rather than generating new ones. I‚Äôll also look into refining how we handle message editing instead of deleting old messages. I see potential setups for generating images or animations based on their rarity, and need to ensure consistent handling when switching between media types. This will simplify and clarify the edit functionality!
**Enhancing Card Editing Functionality**

To implement proper buttons for editing the generated card, I‚Äôm thinking we can create a callback-based UI while still utilizing state prompts. However, we need to respect the rule that callback handlers should only edit existing messages, not create new ones. I might look into adding tests as well, although that could be beyond our current scope.

I‚Äôll need to clarify what the user wants regarding the editing UI ‚Äì whether they prefer AI-generated text or a deterministic overlay. For the biome and rarity indicators, we might need to update them based on the placeholders for accuracy. If I can modify the `_get_placeholder_path`, that might help us use PNG templates if we don't have the correct WebP, which seems to be the preferred format.
**Addressing Text Generation Issues**

I‚Äôm thinking the issue with the model not generating text info on images could relate to incorrect placeholder selection, which is currently defaulting to normal ones. To fix this, I should update the prompt. It may also help to improve how we select placeholders, especially if they haven't yet been converted to WebP.

I‚Äôll propose a fallback system: prioritize WebP placeholders if they exist and are over 1KB, and if not, then revert to PNGs. This way, I'd still have access to biome-specific designs while ensuring the biome text aligns with what we need. I'll check the PNG files with the Read tool to verify their integrity.</details></think>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** ‚Ä¢ Read file: h:\repos\pomyyka-the-game\assets\placeholders\DARK_MYTHIC.png</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Designing attack options**

I need to show Attack 1 and possibly Attack 2, along with an "Add attack" option, if it exists. But I should keep in mind that the attack count depends on rarity. Only editing existing attacks should be allowed. When selecting Attack 1, I‚Äôll provide subfields like Name, Type, Damage, Cost, Effect, and Status Effect. This is a lot to manage, but I could also consider a simpler "edit menu" using JSON, generated by buttons for easier interaction.
**Implementing value validation**

I also need to tackle value validation and storage in this project. For this, I‚Äôll create new `CallbackData` classes, like `AutocardEditCallback`, which will include fields for blueprint_id, section, key, value, and idx. I‚Äôm realizing the `CallbackData` should support integers for idx, but I want to ensure I stay within the character limits for these fields. A total of less than 64 characters works here. Including defaults and avoiding colon separators for value strings sounds good. It might be simpler to define a new class instead of reusing existing ones with too many action values.
**Implementing Autocard editing**

This seems simple enough: I‚Äôll create an `AutocardEditCallback` class with fields for action, blueprint_id, and value. For attack editing, I‚Äôm considering including an index and field, possibly creating a separate `AutocardEditFieldCallback` for that.

In the edit menu callback, I‚Äôll always ensure admin checks and retrieve `blueprint_data` through the session manager. For immediate updates, I'll modify the `blueprint_data` field and call the update method with a time-to-live setting. 

Then, I need to regenerate the card image using a full prompt to include text and update the image URL in Redis. Finally, I plan to edit the existing message with new media using the callback's message property.
**Updating message previews**

I don‚Äôt think I need to pass the Bot parameter because the message has its own methods that use the bot internally, but I might need it. In aiogram, `message.edit_media` utilizes `message.bot`, which seems fine, and I can use `FSInputFile`. I‚Äôll handle both photo and animation, but I face an issue since `Message.edit_media` returns a Message.

I can create an `async def _update_preview_message(callback.message, blueprint_data)` function that chooses the new image path and builds either `InputMediaPhoto` or `InputMediaAnimation` based on the message type. I‚Äôll also provide the necessary caption and parse mode, ensuring I handle reply markup correctly. For the media, the correct format should be something like `await callback.message.edit_media(media=InputMediaPhoto(...))` and adjust for animations as well. I need to remember to escape markdown for user-generated content too!
**Improving caption handling and image generation**

In caption building, I currently don't escape special characters except during approve/cancel success, which could lead to parsing errors if the card name has such characters. Even though the blueprint is AI-generated and not user-supplied, it could still contain special characters that need escaping. 

We've identified a bug with the blueprint update that I'll fix with `update_blueprint`, allowing the editing menu to update the blueprint. For typed inputs, I can set the state and store relevant IDs to validate and update input. 

For attack editing, I might need nested states to handle specific fields. After updates, image regeneration and preview message updates will follow. 

Regarding the missing text in images, I can attempt a fallback with overlays for key fields, ensuring text is always present. This involves covering placeholder text while drawing new text, which might require some calculated positioning based on the card layout. I‚Äôll also look for any existing code to help with drawing text onto images.</details></think>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "ImageDraw|draw\\.text|truetype",
  "path": "h:\\repos\\pomyyka-the-game",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "ImageDraw|draw\\.text|truetype",
    "path": "h:\\repos\\pomyyka-the-game",
    "outputMode": "content",
    "workspaceResults": {
      "h:\\repos\\pomyyka-the-game": {
        "content": {
          "matches": [
            {
              "file": "services/card_animator.py",
              "matches": [
                {
                  "lineNumber": 11,
                  "content": "from PIL import Image, ImageDraw, ImageFilter, ImageEnhance"
                },
                {
                  "lineNumber": 213,
                  "content": "        draw = ImageDraw.Draw(overlay)"
                },
                {
                  "lineNumber": 334,
                  "content": "        draw = ImageDraw.Draw(overlay)"
                },
                {
                  "lineNumber": 394,
                  "content": "        draw = ImageDraw.Draw(overlay)"
                },
                {
                  "lineNumber": 475,
                  "content": "        draw = ImageDraw.Draw(flare)"
                }
              ]
            },
            {
              "file": "enhance_card_borders.py",
              "matches": [
                {
                  "lineNumber": 5,
                  "content": "from PIL import Image, ImageDraw, ImageFilter"
                },
                {
                  "lineNumber": 40,
                  "content": "    draw = ImageDraw.Draw(result)"
                }
              ]
            },
            {
              "file": "add_fade_edges.py",
              "matches": [
                {
                  "lineNumber": 5,
                  "content": "from PIL import Image, ImageDraw"
                },
                {
                  "lineNumber": 26,
                  "content": "    draw = ImageDraw.Draw(mask)"
                }
              ]
            },
            {
              "file": "create_animated_webp.py",
              "matches": [
                {
                  "lineNumber": 5,
                  "content": "from PIL import Image, ImageDraw, ImageFilter"
                },
                {
                  "lineNumber": 30,
                  "content": "    draw = ImageDraw.Draw(overlay)"
                }
              ]
            },
            {
              "file": "services\\card_animator.py",
              "matches": [
                {
                  "lineNumber": 11,
                  "content": "from PIL import Image, ImageDraw, ImageFilter, ImageEnhance"
                },
                {
                  "lineNumber": 213,
                  "content": "        draw = ImageDraw.Draw(overlay)"
                },
                {
                  "lineNumber": 334,
                  "content": "        draw = ImageDraw.Draw(overlay)"
                },
                {
                  "lineNumber": 394,
                  "content": "        draw = ImageDraw.Draw(overlay)"
                },
                {
                  "lineNumber": 475,
                  "content": "        draw = ImageDraw.Draw(flare)"
                }
              ]
            },
            {
              "file": "VIDEO_EFFECTS_TEMPLATES.md",
              "matches": [
                {
                  "lineNumber": 62,
                  "content": "    draw = ImageDraw.Draw(overlay)"
                },
                {
                  "lineNumber": 99,
                  "content": "    draw = ImageDraw.Draw(flare)"
                },
                {
                  "lineNumber": 177,
                  "content": "    draw = ImageDraw.Draw(overlay)"
                },
                {
                  "lineNumber": 221,
                  "content": "        draw = ImageDraw.Draw(overlay)"
                }
              ]
            }
          ],
          "totalLines": 20,
          "totalMatchedLines": 20
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Assessing text overlay implementation**

I‚Äôm looking at the card fields and noticing no text overlay is used. It seems we‚Äôll need to implement something new. Maybe they rely on AI for text as a design choice. I think we should first try fixing the prompt; if that doesn‚Äôt work, we can then try adding the overlay. The model already preserves the placeholder text, so there's potential for change. It makes sense to adjust the prompt to instruct clearer text replacement. Let‚Äôs craft those additions carefully!
**Planning for card data integration**

In the `_generate_image_sync` function, I've noted that we currently use `enhanced_prompt = prompt`. When it involves a placeholder, user photo, or group photo, we add instructions for generating the image. 

I see we can incorporate card data into the process, but we need to ensure that the function accepts it. Instead of embedding card data into the `prompt`, it might be more effective to extend the signature of `_generate_image_sync` to accept optional `card_data`. Since edits aren't possible yet, I'll plan how to build this from `blueprint_data`.
**Designing card data generation**

I‚Äôm thinking we should create a function in either handlers or services to generate a `card_data` dictionary. Instead of defining a new dataclass, it might be simpler to treat `blueprint_data` as a dictionary to pass to `forge_card_image`. 

In the `NanoBananaService.generate_card_for_user` method, I can take the `CardBlueprint` object and build the `card_data` dictionary from it. This would include elements like name, biome, rarity, and stats, which match the data in Redis. We can create a helper function for this in `services/nano_banana.py` to ensure the right format is passed, thus retaining the text output.
**Assessing regeneration path adjustments**

In the regeneration path within `handlers/admin_autocard.py`, I think we can call `art_forge.forge_card_image` with parameters like `blueprint_prompt`, `biome`, `rarity`, and `card_data`. We could adjust `ArtForgeService.forge_card_image` to accept `card_data` as an optional dictionary as well. 

Instead of implementing changes right away, it feels better to propose a plan, particularly for the new editing buttons. I wonder about the best approach for text rendering‚Äîprompt fix or local overlay‚Äîthough I think proposing both options is sufficient without needing to ask the user right now.
**Evaluating text generation and overlays**

I‚Äôm considering how to proceed with the text generation issue and whether to ask the user any questions. Maybe it's best to implement both the prompt fix and a fallback overlay, but I realize that could add complexity. I should acknowledge that overlaying text using bounding boxes and font selection might be challenging. 

Since it seems the user's asking for the model to generate text, I‚Äôll focus on creating a strong prompt fix. Then I'll think about how to build that with a structured format while ensuring key details are retained. Additionally, I need to consider the font requirements for Ukrainian text, which could necessitate including a suitable font file. However, balancing all these factors is clearly tricky.
**Planning text generation approach**

I'm realizing that adding a font file for overlay could introduce unwanted complexity, especially since it might not properly support Ukrainian text. So, I feel it‚Äôs best to rely on the AI for text rendering instead. 

The plan should focus on just implementing the prompt fix, which seems straightforward. I also need to address the `store_blueprint` bug by adding an update method. As for the CreatePlan tool, I‚Äôll make sure to include file paths, code snippets, and key tasks in markdown. Let's get this plan put together!</details></think>

---

<tool-use data-tool-type="unknown" data-tool-name="create_plan">
<details>
<summary>Tool use: **create_plan**</summary>


Parameters:

```json
{
  "plan": "## Problem diagnosis\n- **Why text isn‚Äôt appearing on the card image**: the image model is currently only given &#96;raw_image_prompt_en&#96; (visual-only) and generic ‚Äúgenerate card text‚Äù instructions, but **never receives the actual card values to print**.\n  - Example: &#96;NanoBananaService.generate_card_for_user()&#96; calls &#96;forge_card_image(blueprint_prompt=blueprint.raw_image_prompt_en, ...)&#96; so the image model has no access to &#96;blueprint.name&#96;, &#96;atk/def/meme&#96;, &#96;lore&#96;, &#96;attacks&#96;, etc. ([&#96;h:\\repos\\pomyyka-the-game\\services\\nano_banana.py&#96;](h:\\repos\\pomyyka-the-game\\services\\nano_banana.py)).\n\n## Fix: pass full card fields into the image prompt\n- Update [&#96;h:\\repos\\pomyyka-the-game\\services\\art_forge.py&#96;](h:\\repos\\pomyyka-the-game\\services\\art_forge.py):\n  - Extend &#96;ArtForgeService.forge_card_image(...)&#96; and &#96;_generate_image_sync(...)&#96; to accept an optional &#96;card_fields: dict | None&#96;.\n  - When a placeholder is used, append a **strict ‚ÄúCARD_FIELDS_TO_RENDER‚Äù** block to the prompt:\n    - Card name (UA)\n    - Biome label (emoji + UA)\n    - Rarity badge (emoji + UPPERCASE English)\n    - Stats lines: &#96;‚öîÔ∏è ATK&#96;, &#96;üé≠ MEME&#96;, &#96;üõ°Ô∏è DEF&#96;\n    - Attacks list (name/type/damage/energy/effect/status)\n    - Lore (UA)\n    - Print date\n    - Weakness/resistance\n  - Add explicit instructions: ‚Äú**Replace placeholder text** (e.g. &#96;–ù–ê–ó–í–ê –ö–ê–†–¢–ö–ò&#96;, &#96;–ü—Ä–∏–∫–ª–∞–¥ –ê—Ç–∞–∫–∏ ‚Ä¶&#96;, default stats) with these exact values; don‚Äôt invent new text; keep the template layout.‚Äù\n\n- Update callers to pass &#96;card_fields&#96;:\n  - [&#96;h:\\repos\\pomyyka-the-game\\services\\nano_banana.py&#96;](h:\\repos\\pomyyka-the-game\\services\\nano_banana.py): build a dict from the generated &#96;CardBlueprint&#96; and pass it into &#96;forge_card_image(...)&#96;.\n  - [&#96;h:\\repos\\pomyyka-the-game\\handlers\\admin_autocard.py&#96;](h:\\repos\\pomyyka-the-game\\handlers\\admin_autocard.py): in &#96;_regenerate_card_image(...)&#96;, pass the Redis &#96;blueprint_data&#96; as &#96;card_fields&#96; so regenerations after edits also render text.\n\n## Fix: blueprint updates currently don‚Äôt persist (hidden bug)\n- &#96;SessionManager.store_blueprint()&#96; always creates a new UUID. Current code uses it for ‚Äúupdates‚Äù and ignores the returned ID, so callbacks keep pointing at stale data.\n- Add &#96;SessionManager.update_blueprint(blueprint_id, blueprint_data, ttl=...)&#96; in [&#96;h:\\repos\\pomyyka-the-game\\services\\session_manager.py&#96;](h:\\repos\\pomyyka-the-game\\services\\session_manager.py) and replace the incorrect ‚Äúupdate via store_blueprint‚Äù calls.\n\n## Replace JSON editing with button-driven editor\n- In [&#96;h:\\repos\\pomyyka-the-game\\handlers\\admin_autocard.py&#96;](h:\\repos\\pomyyka-the-game\\handlers\\admin_autocard.py):\n  - Replace the current &#96;CardEditStates.waiting_for_json&#96; flow with an inline **edit menu**:\n    - Top-level edit keyboard: &#96;üìõ –ù–∞–∑–≤–∞&#96;, &#96;üåç –ë—ñ–æ–º&#96;, &#96;üíé –†—ñ–¥–∫—ñ—Å—Ç—å&#96;, &#96;üìä –°—Ç–∞—Ç–∏ (ATK/DEF/MEME)&#96;, &#96;üìñ –õ–æ—Ä&#96;, &#96;‚ö° –ê—Ç–∞–∫–∏&#96;, &#96;üñº Prompt&#96;, &#96;üóì –î–∞—Ç–∞&#96;, &#96;‚¨ÖÔ∏è –ù–∞–∑–∞–¥&#96;.\n    - Biome/rarity/type/status selections are done via inline choices (no typing).\n    - Text/number fields prompt the admin for a value (FSM &#96;waiting_for_value&#96;), validate, then regenerate.\n  - After any edit, automatically:\n    - update the Redis blueprint via &#96;update_blueprint&#96;\n    - regenerate the image via &#96;_regenerate_card_image&#96;\n    - update the preview caption (and keep the four main actions available).\n\n## Safety/UX\n- Escape Markdown V2 / Markdown special chars when building captions and editor text via &#96;utils/text.py::escape_markdown()&#96;.\n- Keep callback data short (blueprint_id + small field/value codes) to avoid Telegram 64-byte limits.\n\n## Verification\n- Add/adjust tests where feasible (unit-level):\n  - &#96;SessionManager.update_blueprint&#96; updates the existing key.\n  - Prompt builder includes the card fields block when a placeholder is provided.\n- Manual: run &#96;/autocard&#96; and confirm the generated image shows the real name/stats/lore and that editing via buttons updates the image and caption without JSON.",
  "name": "AutocardTextAndEditUX",
  "todos": [
    {
      "content": "Add card_fields support in ArtForgeService; pass full blueprint fields from NanoBananaService and regen path so the image model receives exact text values to render.",
      "status": "pending",
      "id": "diagnose-and-wire-card-fields-into-image-prompt"
    },
    {
      "content": "Implement SessionManager.update_blueprint and replace incorrect store_blueprint usages during regen/edit so callbacks always read the latest blueprint.",
      "status": "pending",
      "id": "fix-blueprint-update-bug"
    },
    {
      "content": "Replace JSON editing with inline-button edit menus + FSM for typed values; validate inputs, update Redis, regenerate image, and refresh preview.",
      "status": "pending",
      "id": "implement-inline-edit-ui"
    },
    {
      "content": "Run targeted tests and a quick manual /autocard flow to confirm text appears on images and editing works end-to-end.",
      "status": "pending",
      "id": "verify"
    }
  ],
  "overview": "Fix /autocard so generated images include the card‚Äôs textual fields (name/stats/lore/attacks/etc.) and replace the admin JSON editor with an inline-button, step-by-step edit UI that regenerates the image after changes."
}
```
Additional data:

```json
{
  "reviewData": {
    "status": "Requested",
    "selectedOption": "none",
    "isShowingInput": false
  },
  "planUri": "file:///c%3A/Users/ThatHunky/.cursor/plans/autocardtextandeditux_1ce7ca25.plan.md",
  "hasOpenedEditor": true
}
```
Result:

```json
{
  "rejected": {}
}
```
Status: **completed**


</details>
</tool-use>

---

_**User**_

Implement the plan as specified, it is attached for your reference. Do NOT edit the plan file itself.

To-do's from the plan have already been created. Do not create them again. Mark them as in_progress as you work, starting with the first one. Don't stop until you have completed all the to-dos.

---

_**Agent (model gpt-5.2-xhigh, mode Agent)**_

<think><details><summary>Thought Process</summary>
**Investigating code adjustments**

I need to take a look at the existing code and design. Starting with `services/art_forge.py`, I want to add a `card_fields` parameter to both `forge_card_image` and `_generate_image_sync`. This will allow us to generate images with actual values instead of placeholders.

I also see that `handlers/admin.py`'s `createcommoncard` uses positional arguments for `art_forge.forge_card_image`, which might need an update to pass `card_fields`. Lastly, I should implement `SessionManager.update_blueprint` since current storage updates use a new ID, risking stale callbacks.
**Planning blueprint updates**

I‚Äôm thinking about implementing an update method to preserve TTL while updating existing blueprints. I also want to replace the current JSON input for editing generated cards with interactive inline buttons to make it easier.

I need to design a callback data scheme, possibly starting with the prefix "autocard_edit." I might extend `AutocardCallback` to include the action and `blueprint_id`, but that means I need to store identifiers in Redis sessions. Considering a new class, `AutocardEditCallback`, could help, while keeping in mind the 64-byte limit for callback data.
**Designing interactive flows**

I realize we might need multi-step interactive flows for editing. For example, when a user selects "edit name," the bot should prompt them to send a new name. This would involve storing the `blueprint_id` and the `edit_field` state in a finite state machine (FSM). 

For choices like biome or rarity, an inline keyboard could work well, allowing selection without extra messages. We could also provide buttons for stats adjustments, but maybe simply prompting for a value would be easier. Editing attacks is more complex, but I plan to allow for the selection of specific attacks and editing their details with options to add or remove as needed.
**Implementing attack editing**

I'm thinking of using callbacks to set which attack index to edit, followed by a sub-menu for specific attack fields. Some fields, like type and status effect, could be chosen via an inline list, while others, like name and damage, would require user input. 

For editing raw prompts, we should allow users to provide new strings and incorporate `card_fields`. The date editing could offer options for current or manual input. While weakness and resistance might be part of the blueprint data, I wonder if they should be included in the menu. Ultimately, the goal is to make editing user-friendly with buttons and intuitive follow-up prompts, while maintaining the ability to regenerate images.
**Improving message editing**

I need to ensure that after editing, the bot updates the existing preview message instead of sending a new one, as this could reduce spam. Currently, regenerating deletes the old message and sends a new preview, which doesn't align with the rules stating that callbacks should edit messages. 

So, I think it might be better to maintain the preview message as an image while using an ephemeral message for the editing menu. We could use `edit_message_media` and `edit_caption` to update the media and caption respectively. However, I should also consider user experience and ensure any changes align with workspace rules while keeping the original request for interactive editing in mind. Starting with a to-do update sounds like a good plan!</details></think>

---

Plan: I‚Äôll first wire the generated blueprint fields (name/stats/lore/etc.) into the image-generation prompt so the model can actually render the text onto the template. Then I‚Äôll fix the Redis blueprint ‚Äúupdate‚Äù bug, and finally replace the JSON editor with an inline-button edit UI that regenerates the preview after each change.

---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** ‚Ä¢ Todo List</summary>

- [-] Add card_fields support in ArtForgeService; pass full blueprint fields from NanoBananaService and regen path so the image model receives exact text values to render.
- [ ] Implement SessionManager.update_blueprint and replace incorrect store_blueprint usages during regen/edit so callbacks always read the latest blueprint.
- [ ] Replace JSON editing with inline-button edit menus + FSM for typed values; validate inputs, update Redis, regenerate image, and refresh preview.
- [ ] Run targeted tests and a quick manual /autocard flow to confirm text appears on images and editing works end-to-end.

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Implementing card fields support**

I‚Äôm getting ready to implement the support for card fields in ArtForgeService. I‚Äôll modify the `forge_card_image` to include `card_fields` in the prompt. First, I need to open `services/art_forge.py`, and I can apply the necessary patches.

I‚Äôll update the function signatures to incorporate `card_fields` and ensure that the call to `_generate_image_sync` passes it along. We‚Äôll also need to define how to handle text rendering based on whether a placeholder path is provided. It looks like I want to make sure everything works harmoniously!
**Incorporating additional color and data**

I‚Äôm considering whether to add `dominant_color_hex` and `accent_color_hex` to our implementation, as they could be beneficial. I also need to include details like attacks, weaknesses, resistance, and print date. I'll make sure the values are in the correct language.

It looks like the `blueprint_data` stored in Redis has a mix of Ukrainian and English labels. I‚Äôm noticing that the attack types are represented as Enums with Ukrainian strings, but there‚Äôs also some confusion about names versus actual values in the Pydantic model. It‚Äôs important to clarify how those values are parsed correctly!
**Handling JSON and formatting**

When I read JSON from the AI, I noticed that if it outputs "PHYSICAL," that might not match our expectations. There could have been a change in the prompt that I‚Äôm unaware of, but that‚Äôs not crucial to the current bug. My priority is to render whatever the attack dictionary contains.

In the `blueprint_data`, the `attacks` come from the services/card_architect as Pydantic model dumps, and I‚Äôll treat the fields as strings. I‚Äôm also considering adding emoji mapping for biome and rarity. It makes sense to use a small helper in art_forge for formatting. However, since art_forge is used for various purposes, I should keep it generic and create an internal mapping instead!
**Implementing card fields formatting**

I‚Äôm starting to implement a function, `_format_card_fields_block`, that will format card fields from a dictionary. This function expects keys like name, biome, rarity, and others. The challenge is that the data shapes may differ between calls from NanoBananaService and regen.

In NanoBananaService, I‚Äôll create a function to build a `card_fields` dictionary that aligns perfectly with the placeholder needs. It‚Äôll include fields from the CardBlueprint dataclass.

I need to remember that `blueprint_data` stored in Redis uses different keys, so I want to ensure that my code supports both formats. In art_forge, I‚Äôll set it up to check for both versions of the keys to make this robust!
**Ensuring correct text and images**

I need to manage text length carefully; while lore can go up to 500 characters, I‚Äôll make sure it fits well. We should avoid JSON dumps that could lead to odd quoting, but text in the prompt needs to be safe. It‚Äôs best to embed it as a JSON string directly in the prompt.

To make it simpler, I could opt for a bullet list format, making it clearer for the model to replicate exact values. I also need to ensure placeholder images are valid `.webp` files and check that biome-specific ones exist. If they don‚Äôt, we'll fall back to normal placeholders.

After making adjustments in art_forge, I‚Äôll update calls in NanoBananaService and other parts of the code to include the necessary `card_fields`. I want to make sure everything is cohesive, including any changes to function signatures. Let's apply these patches!</details></think>

---

Working on the first fix now: I‚Äôm going to extend the image-generation service to accept the generated card fields (name/stats/lore/attacks/etc.) and inject them into the prompt so the model can actually replace the placeholder text on the template.

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2** ‚Ä¢ Edit file: h:\repos\pomyyka-the-game\services\art_forge.py</summary>

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
**Patching code logic**

I'm thinking about how to patch `services/nano_banana.py`. In the `generate_card_for_user` function, I should first build the `card_fields` dictionary before calling `forge_card_image`. It looks like I can use blueprint stats and maybe even pass `card_fields` to `self.forge_card_image`. I should also consider incorporating `blueprint.dominant_color` and possibly `print_date`. Alright, let‚Äôs go ahead and apply this patch!</details></think>

---

Now I‚Äôll wire the generated blueprint values into the `/autocard` image-generation call, and also into the regeneration path, so both the initial image and any regenerated images can correctly render name/stats/lore on the template.

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2** ‚Ä¢ Edit file: h:\repos\pomyyka-the-game\services\nano_banana.py</summary>

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2** ‚Ä¢ Edit file: h:\repos\pomyyka-the-game\handlers\admin_autocard.py</summary>

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
**Considering code updates**

I‚Äôm looking into patching different regeneration flows in the handlers/admin.py file. For createcommoncard, we might pass card_fields, though it‚Äôs not strictly necessary. It won‚Äôt hurt to consider it. Next, we need to modify the ArtForgeService.forge_card_image call to include asyncio.to_thread(self._generate_image_sync, full_prompt, placeholder_path,..., card_fields), especially since we changed the signature of _generate_image_sync to accept an additional argument. I also need to update services/nano_banana.py for this adjustment.
**Evaluating placeholder logic**

I need to be cautious about certain flows that might not utilize the placeholder feature. In the forge_card_image function, it currently carries instructions for placeholders. If there's no placeholder but card_fields exist, the code only adds a block when there's a trigger from the placeholder, user_photo, or group_photo. If the placeholder is None and only card_fields are there, the enhanced_prompt won't include those instructions. It could be beneficial to include the card_fields block even without images. For /autocard, we typically have a placeholder and possibly photos, which is good.
**Reviewing placeholder conditions**

If placeholder_path is None, user_photo or group_photo might still exist, so instructions will be visible. The card_fields block will be included because we check for card_fields within that block. We only build the enhanced_prompt if placeholder_path, user_photo_bytes, or group_photo_bytes exist. If there are no photos and placeholder_path is None, the enhanced_prompt will equal the prompt without using card_fields, meaning the card won‚Äôt have text. However, the placeholder is usually found. I should also consider updating our tests and ensuring everything compiles without formatting issues, but I'll handle that later.
**Adjusting card preview and fixes**

Before moving forward, I should look at adjusting the caption in `handlers/admin_autocard._send_card_preview`. It currently doesn‚Äôt include meme statistics, but that might not be relevant. The screenshot shows that the caption does include the meme, though the main issue is that the image doesn‚Äôt include text info. I need to ensure that the art_forge modifies the placeholder correctly, especially since it looks like our placeholders directory has `NORMAL_*.webp` images with text. Also, I should consider how `save_generated_image` saves images as `.webp`, while APIs could return PNG or JPEG formats. I think the first todo is done, but I need to ensure the regeneration path passes successfully.
**Checking regeneration paths**

I'm looking into potential issues with the regeneration paths, especially in `services/nano_banana.generate_from_prompt`, where it calls `forge_card_image` with only two arguments. This means the placeholder is None, and no card_fields are included, which could be fine. We should consider adjusting `services/art_forge.py` to handle card_fields, even if the placeholder is passed without images. I also want to update `handlers/admin_autocard` to ensure appropriate data inclusion for rendering. 

Next, I plan to mark the first todo as completed and the second as in progress. I need to verify that we're not missing any call site connections, particularly `forge_card_image(` usage, since its signature may have changed. I'll check for any other calls that could conflict with keyword arguments, but that might not be necessary right now. Feels like I've completed the first todo, so here we go!</details></think>

---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** ‚Ä¢ Todo List</summary>

- [x] Add card_fields support in ArtForgeService; pass full blueprint fields from NanoBananaService and regen path so the image model receives exact text values to render.
- [-] Implement SessionManager.update_blueprint and replace incorrect store_blueprint usages during regen/edit so callbacks always read the latest blueprint.
- [ ] Replace JSON editing with inline-button edit menus + FSM for typed values; validate inputs, update Redis, regenerate image, and refresh preview.
- [ ] Run targeted tests and a quick manual /autocard flow to confirm text appears on images and editing works end-to-end.

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Evaluating blueprint updates**

I'm considering whether I need to update the blueprint_id, but it looks like that's not necessary. In my process for editing the card, I need to replace "store_blueprint" with "update." Later on, I'll need to update the image path as well. It seems fine to use "store_blueprint" in the initial storing of blueprint_data within cmd_autocard, but I'll check for other instances where "store_blueprint" is used and look into those using Grep.</details></think>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "store_blueprint\\(",
  "path": "h:\\repos\\pomyyka-the-game",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "store_blueprint\\(",
    "path": "h:\\repos\\pomyyka-the-game",
    "outputMode": "content",
    "workspaceResults": {
      "h:\\repos\\pomyyka-the-game": {
        "content": {
          "matches": [
            {
              "file": "services/session_manager.py",
              "matches": [
                {
                  "lineNumber": 519,
                  "content": "    async def store_blueprint(self, blueprint_data: dict, ttl: int = 3600) -&gt; str:"
                }
              ]
            },
            {
              "file": ".specstory/history/2026-01-02_19-02Z-generated-card-options.md",
              "matches": [
                {
                  "lineNumber": 539,
                  "content": "          blueprint_id = await session_manager.store_blueprint(blueprint_data, ttl=3600)"
                },
                {
                  "lineNumber": 583,
                  "content": "          blueprint_id = await session_manager.store_blueprint(blueprint_data, ttl=3600)"
                },
                {
                  "lineNumber": 904,
                  "content": "+         await session_manager.store_blueprint(blueprint_data, ttl=3600)"
                },
                {
                  "lineNumber": 1251,
                  "content": "+         await session_manager.store_blueprint(blueprint_data, ttl=3600)"
                },
                {
                  "lineNumber": 1266,
                  "content": "+         await session_manager.store_blueprint(blueprint_data, ttl=3600)"
                }
              ]
            },
            {
              "file": "handlers\\admin_autocard.py",
              "matches": [
                {
                  "lineNumber": 503,
                  "content": "        blueprint_id = await session_manager.store_blueprint(blueprint_data, ttl=3600)"
                },
                {
                  "lineNumber": 848,
                  "content": "        await session_manager.store_blueprint(blueprint_data, ttl=3600)"
                },
                {
                  "lineNumber": 1195,
                  "content": "        await session_manager.store_blueprint(blueprint_data, ttl=3600)"
                },
                {
                  "lineNumber": 1210,
                  "content": "        await session_manager.store_blueprint(blueprint_data, ttl=3600)"
                }
              ]
            },
            {
              "file": "handlers/admin_autocard.py",
              "matches": [
                {
                  "lineNumber": 503,
                  "content": "        blueprint_id = await session_manager.store_blueprint(blueprint_data, ttl=3600)"
                },
                {
                  "lineNumber": 848,
                  "content": "        await session_manager.store_blueprint(blueprint_data, ttl=3600)"
                },
                {
                  "lineNumber": 1195,
                  "content": "        await session_manager.store_blueprint(blueprint_data, ttl=3600)"
                },
                {
                  "lineNumber": 1210,
                  "content": "        await session_manager.store_blueprint(blueprint_data, ttl=3600)"
                }
              ]
            }
          ],
          "totalLines": 14,
          "totalMatchedLines": 14
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Patching session manager**

I need to ensure that only admin_autocard is using store_blueprint for updates, so I'll fix that. It's also essential to note there are duplicate paths because of windows and backslashes, but I‚Äôll ignore that. Next, I‚Äôll patch the session_manager to add the update_blueprint method right after the store/get/delete methods. Finally, I'll make the necessary changes to admin_autocard usage and implement that in the session_manager.</details></think>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2** ‚Ä¢ Edit file: h:\repos\pomyyka-the-game\services\session_manager.py</summary>

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2** ‚Ä¢ Edit file: h:\repos\pomyyka-the-game\handlers\admin_autocard.py</summary>

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
**Considering update processes**

I‚Äôm thinking about more uses here. When they update the blueprint_data in regenerate and call update_blueprint, if that update fails, it returns false but might be ignored. That seems okay? I wonder if it's truly necessary. Next, I‚Äôll look at updating the todo statuses: I have "fix-blueprint-update-bug" marked as completed and "implement-inline-edit-ui" set as in progress. It feels good to check off those tasks and keep things organized!</details></think>

---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** ‚Ä¢ Todo List</summary>

- [x] Add card_fields support in ArtForgeService; pass full blueprint fields from NanoBananaService and regen path so the image model receives exact text values to render.
- [x] Implement SessionManager.update_blueprint and replace incorrect store_blueprint usages during regen/edit so callbacks always read the latest blueprint.
- [-] Replace JSON editing with inline-button edit menus + FSM for typed values; validate inputs, update Redis, regenerate image, and refresh preview.
- [ ] Run targeted tests and a quick manual /autocard flow to confirm text appears on images and editing works end-to-end.

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Considering edit functionality**

When I click edit, I think we can update the reply_markup of the preview message to show options like editing, back, regenerate, approve, or cancel. It's clear we can reuse the same message, displaying the same image and caption but tweaking the keyboard for edits. This keeps us compliant with Telegram‚Äôs editing rules. So, when admin selects edit, I‚Äôll propose an editing menu with buttons and keep the option to regenerate the image after updates.
**Planning edit button implementation**

I've got a requirement to implement proper buttons for editing the generated card, and it seems they want easy, field-specific buttons when clicking edit. I‚Äôm thinking we can do this within the same message using `edit_reply_markup` or `edit_caption`. If it's an animation, I believe we can still edit the reply markup and caption. However, regenerating and updating the media might complicate things. For the editing menu, I can edit the reply_markup and prompt the admin for input, possibly opening an FSM for new values.
**Exploring message editing options**

To focus on editing messages only, I could consider using inline queries for predefined options, but for free text like names, lore, or prompts, I‚Äôll need user input. This would come from a new message from the admin, which is allowed. The bot can respond by editing the existing preview message instead of starting a new one. 

When the admin selects a field needing input, I'll use `safe_callback_answer` to guide them, possibly sending a prompt as well. However, if I modify the caption to show this prompt, it may lose the previous card info, so I need to think about incorporating the prompt into the caption instead.
**Considering editing strategies**

Editing the name might get messy, but it's doable! I could change the caption to include something like "üìù Send new name," which would keep some existing info. However, sending a new message with a prompt goes against the idea that the bot should edit messages primarily. I think it could work for FSM prompts, though. 

To comply with the callback handler rule, I'll aim to edit the existing message by adding input instructions in the caption and a "Cancel edit" button. Afterward, I can revert the caption, which seems manageable. Still, a separate message for editing could spam the chat, so that's something to keep in mind.
**Reviewing workspace rules**

I need to revisit the workspace rules for the bot, which emphasize that it should primarily edit messages instead of sending new ones to reduce spam. Callback handlers need to only edit existing messages. We can implement the editing menu and prompts by modifying the existing preview message, such as its caption.

When the admin uses the /autocard command, we‚Äôll send a photo or animation with relevant caption and keyboard options. Upon clicking edit, I'll edit the caption to add a prompt while keeping the preview info intact. I'll also set the FSM state to wait for text input and provide instructions through the caption after a field is selected. 

There‚Äôs a challenge with the chat context since the admin might use /autocard in a group, making it tricky to track messages. Instead of deleting and sending a new message during regeneration, we should update the existing message media to adhere to the rules. I plan to implement a helper function to handle this smoothly!
**Refining preview handling**

We need to handle rare card previews using `answer_animation` with mp4. To update the animation, I can use `edit_media` with `InputMediaAnimation`. For the initial send, the function sends the animation with `message.answer_animation`, but for editing, I‚Äôll switch to `message.edit_media`.

I think we could create a consistent function to either send new or edit existing previews, which would help streamline the process. As we track message ID changes in the blueprint data stored in Redis, we can update it whenever we regenerate. 

Instead of requiring the admin to reply to the preview message, I could prompt them to reply, which keeps things simpler. When they pick a field that needs input, I'll edit the caption to say something like "üìù Reply to this card message with the new value for NAME" to minimize confusion. If they haven't replied correctly, I can remind them to do so. Overall, I aim to maintain a friendly user experience while ensuring the message editing rule is respected!
**Structuring the editing process**

I‚Äôm planning on implementing a more organized editing process. When the admin clicks "–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ü–æ–ª—è," I‚Äôll change the keyboard to show an edit menu with fields like name, biome, rarity, etc. For biome and rarity, selecting an option would prompt an immediate update and regenerate the preview message.

I'll also manage the responses, instructing the admin to reply with updates for fields like name or lore, while the attacks menu allows for editing existing attacks or adding/removing them. 

For callback data management, I‚Äôll structure classes to maintain clarity and efficiency, ensuring that the lengths are kept within permissible limits for compactness while allowing room for essential information. I've settled on keeping prefixes concise but also meaningful for ease of handling actions. This should smooth out the whole editing workflow!
**Planning the editing workflow**

I need to figure out how to switch between view modes smoothly. The main actions keyboard will have four options, while the edit menu will include field buttons and a "‚¨ÖÔ∏è –ù–∞–∑–∞–¥" option for going back. It might also be a good idea to keep "Regenerate image" easily accessible, potentially within the edit menu.

I‚Äôm considering maintaining both approve and cancel options always visible‚Äîperhaps at the bottom of the edit menu‚Äîto streamline the user's experience while ensuring we mix different types of callback data strings effectively. 

Next up, I'll create helper functions to build the keyboards and update existing ones. I'll add a new CallbackData class specifically for editing, plus develop FSM states to handle input effectively. To store the preview message ID, we'll extract it from the callback and ensure that messages can be edited straightforwardly without requiring replies. This approach should minimize complications while enhancing the overall workflow!
**Exploring media editing options**

I‚Äôm considering how to approach editing media types in messages while keeping user experience smooth. If I can't change the media type, a fallback option could be to delete the old message and send a new preview, but it might be risky. 

I could set the media type to `InputMediaPhoto` even for rare cards, which would avoid some editing issues. However, this would mean users miss out on the animation preview. 

The Telegram API does allow changing media types when editing, so I think I can implement changes accordingly and handle both animated and photo types appropriately. I'll also need to ensure the caption's parse mode is correct. It appears aiogram handles Markdown V1 for captions. I‚Äôll keep refining these details!</details></think>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** ‚Ä¢ Read file: h:\repos\pomyyka-the-game\utils\text.py</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Designing action callbacks**

I'm thinking about the actions needed for a menu system. We should have options like "menu," "back," "set," "prompt," "att_menu," and "att_field." To make things clearer, I‚Äôm considering using different prefixes for attack-related callbacks: `AutocardEditCallback` for editing and `AutocardAttackCallback` for attacks. I can keep the action names short to save on callback size while still allowing for fields and values to be provided. Let's keep it efficient and organized!
**Implementing biome selection**

I'm setting up biome selection in the edit menu. I‚Äôll add a button labeled "üåç –ë—ñ–æ–º" with the callback data to trigger the biome menu. For the "biome_menu" action, I‚Äôll create a keyboard with options for each BiomeType, like NORMAL or FIRE, and provide a back button to return to the edit menu. When setting a biome, I‚Äôll update the blueprint data and regenerate the image. It sounds like keeping the edit menu open for further editing is a great idea!
**Setting up user input for stats**

For the action "ask" related to the "atk" field, I‚Äôll put the FSM into a waiting state for the user‚Äôs input, storing important details like blueprint_id and chat_id. To provide clear instructions, I think it‚Äôs better to edit the caption with a small note like "‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è: –≤–≤–µ–¥—ñ—Ç—å –Ω–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è –¥–ª—è ATK (0-100)." I also want to make sure we append this without losing the existing information. Sending an ephemeral callback answer with instructions could be helpful too! Let‚Äôs finalize that function for building the caption.
**Building the caption functionality**

I'm designing a function called `build_caption` that will help construct the message caption. If there's additional input, like specific instructions, I‚Äôll append that to the caption. When the action "ask" is triggered, I plan to edit the message caption using this function, providing clear prompts for the user. I‚Äôll also keep a cancellation keyboard option, which will allow users to cancel input and clear the FSM state easily. Each chat/user will manage their own FSM context. Let's get that running!
**Implementing various features for editing**

I‚Äôm working on several tasks to enhance the editing functionalities. First, I‚Äôll check the admin context and retrieve necessary data such as blueprint_id and chat_id. When users input values, I'll validate those inputs for type and length. For lore, I'll allow up to 500 characters, with input prompts and a cancellation option. After any updates, I‚Äôll ensure to regenerate the image and update the preview message accordingly. Plus, I‚Äôll streamline attack editing with buttons for existing attacks and offer options to add or modify attacks efficiently. Overall, I need to ensure everything‚Äôs clear and organized to avoid confusion!
**Updating media and states for editing**

I need to update the blueprint_data in Redis to ensure future actions have the latest information. Then, I‚Äôll update the preview message, checking the current media type to determine if we should use an animation or a static image. I must ensure the appropriate paths are set correctly, especially since they can be relative. For editing media, I'll implement a function to manage media selection based on rarity and availability. Also, I plan to refine how regenerating images works to improve the editing experience by keeping the message in place rather than deleting and recreating it.
**Implementing callback classes**

I'm working on creating the `AutocardEditCallback` and `AutocardAttackCallback` classes. These will help streamline callback actions, but I need to watch lengths to stay under the limits. I‚Äôve decided to use shorter prefixes like "aced" for edits and "acat" for attacks. I'll simplify action codes too. For instance, using single letters for actions will keep it concise while retaining clarity. This approach helps ensure that our packed strings remain manageable, so they won't exceed the maximum character limits.
**Planning callback actions**

I'm defining actions for the `AutocardEditCallback` related to the attack menu, including options like selecting, adding, or deleting attacks. I want to keep action strings concise so that our data doesn't exceed length limits. 

Now, I need to map shorter field codes for the different attributes, making sure to avoid conflicts with action codes. It looks like I can still use full names for inputs like 'name' or 'atk' in the edit callback, since those stay under the limits. However, for attack callbacks, I'll use shorter field names to fit the constraints. Also, I'll design the keyboards for the edit menu carefully, ensuring we stay organized and that the user interface remains straightforward to navigate.
**Updating card details**

I need to ensure that when the biome or rarity changes, the placeholder path updates to reflect this. The function `_regenerate_card_image` uses this placeholder path based on the incoming biome and rarity. If the rarity changes to "rare", I‚Äôll need to generate an animation with `art_forge.forge_card_image`. 

For the input states, I need to track various parameters like blueprint ID, field, message IDs, and chat IDs. I‚Äôll build a function to create input keyboards for user prompts, ensuring that we have a cancel option. For validation, I‚Äôll set specific criteria for input fields, like length checks and patterns for date formats. Then, I will edit the preview message to reflect ongoing changes and update the blueprint data accordingly. Finally, for handling attacks, I‚Äôll structure the menu for selecting and editing each attack, making sure to include options for adding and removing attacks.
**Implementing attack functionality**

I need to set up a status menu that includes various statuses like NONE, BURNED, POISONED, and so on. Each status will have a Ukrainian display value and a callback value reflecting `StatusEffect.name`. When the user selects a status within the attack callback, I‚Äôll update `blueprint_data['attacks'][idx]` for the chosen attack.

For input actions, I‚Äôll store necessary identifiers like blueprint ID, chat ID, and message ID. If the user wants to add a new attack, I‚Äôll check the existing number of attacks. I‚Äôll set default values for the new attack and update the data accordingly. I also need to ensure that both normal field editing and attack field editing are supported. Lastly, I'll patch the admin functionalities step-by-step, with updates to the state management and callbacks.</details></think>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2** ‚Ä¢ Edit file: h:\repos\pomyyka-the-game\handlers\admin_autocard.py</summary>

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2** ‚Ä¢ Edit file: h:\repos\pomyyka-the-game\handlers\admin_autocard.py</summary>

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
**Updating message handler**

I'm looking to update the final preview using the bot.edit_message_media function. I need to make sure I implement those functions right after get_biome_emoji. It‚Äôll be important to find the right insertion point after get_biome_emoji returns its value. I‚Äôll patch it accordingly to ensure everything flows smoothly. This seems like an organized plan to make sure the process works as intended!</details></think>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2** ‚Ä¢ Edit file: h:\repos\pomyyka-the-game\handlers\admin_autocard.py</summary>

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
**Updating keyboard handling**

I've imported `_pick_preview_media_path` with a `"Path"` type in quotes, which seems fine, but I'm using the same name after importing from `pathlib`. However, I imported `Path` again in the function but didn't actually use it, which might raise a linter warning. Now, I need to think about updating `cmd_autocard` to use new keyboard builders because the current method builds the keyboard manually and creates some duplication. I plan to patch it to use `build_autocard_main_keyboard(blueprint_id)` to streamline everything.
**Implementing edit handlers**

While it's not mandatory, I'm using `AutocardEditCallback(action="b")` for the back action in our edit menu, which means I need to create a handler to restore the main keyboard with `build_autocard_main_keyboard`. It's okay if the main keyboard remains built manually, but using a builder is easier. There's also `_send_card_preview` for regenerating messages that we might need to adapt or remove. I plan to implement `handle_autocard_regenerate` to edit the message in place rather than deleting and sending a new one. We can work on patching these sections!
**Preparing to patch**

I think it's best to open the snippet around `handle_autocard_edit` in the file for proper patching. I‚Äôll focus on lines 872 to 940 to read the relevant portion. This way, I can make sure that any changes I craft will be accurate and effective. Let‚Äôs dive into that section and see how I can implement the necessary updates! I want to make sure I get everything just right for smooth functionality.</details></think>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** ‚Ä¢ Read file: h:\repos\pomyyka-the-game\handlers\admin_autocard.py</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Evaluating keyboard and caption updates**

I see that the keyboard can be built manually, but it might be better to use `build_autocard_main_keyboard` for consistency. There‚Äôs also the caption that we might format using `_format_caption_from_blueprint_data`. While restructuring isn't essential now, it could help avoid duplication. We need to store the blueprint data in Redis and ensure that any captions match the edits. I‚Äôll focus on updating the keyboard creation and maybe preview sending, replacing sections quickly for consistency.
**Updating keyboard in send function**

In the `_send_card_preview` function, I notice that the keyboard is built manually. I could also update that section, but it might involve a larger patch than expected, though it seems manageable. I‚Äôll focus on patching the keyboard area there to improve consistency and streamline the process. It‚Äôs important to ensure that everything aligns correctly, so I‚Äôll make sure to keep track of these changes as I work on them.</details></think>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2** ‚Ä¢ Edit file: h:\repos\pomyyka-the-game\handlers\admin_autocard.py</summary>

</details>

</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** ‚Ä¢ Read file: h:\repos\pomyyka-the-game\handlers\admin_autocard.py</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Locating function details**

I need to focus on handling the `handle_autocard_regenerate` function, which is further down in the code. I realized the current snippet I have doesn't include it, as it appears earlier around line 808. I should check the areas around the `_send_card_preview` function after that. Let's quickly locate the exact position by scanning the lines surrounding where the regenerate function is defined, especially looking for `@router.callback_query(AutocardCallback.filter(F.action == "regenerate"))`.</details></think>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** ‚Ä¢ Read file: h:\repos\pomyyka-the-game\handlers\admin_autocard.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2** ‚Ä¢ Edit file: h:\repos\pomyyka-the-game\handlers\admin_autocard.py</summary>

</details>

</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** ‚Ä¢ Read file: h:\repos\pomyyka-the-game\handlers\admin_autocard.py</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Updating function behavior**

I need to replace the handle_autocard_edit function and patch lines 1222-1289. First, I'll retrieve blueprint_data and respond if it‚Äôs missing. Clearing any existing state might be necessary. 

Next, I‚Äôll change the message reply markup to edit menu keyboard using build_autocard_edit_keyboard. I can use callback.message.edit_reply_markup for this. 

Updating the caption to include "‚úèÔ∏è –†–µ–∂–∏–º —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è" is optional. Storing blueprint_id, preview_chat_id, and preview_message_id might be useful later for typed input, but it seems storing them right now isn't necessary. I'll patch the function body accordingly.</details></think>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2** ‚Ä¢ Edit file: h:\repos\pomyyka-the-game\handlers\admin_autocard.py</summary>

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
**Clarifying action codes**

I‚Äôm working on the action codes for our system. We decided to use 'd' for delete attacks and might use 'd' for damage in typed fields. But since the field code is separate, we can manage that. I‚Äôm considering other action codes: 'm' for menu, 'b' for back, 'x' for select, and 'r' for remove. We‚Äôll stick with 'd' for delete to avoid confusion. It all seems fine, but I might adjust the documentation later, though it's probably not necessary.
**Designing attack type menu**

I‚Äôm working on the attack type menu keyboard by iterating through the AttackType enum. Maybe I‚Äôll create button text using values like 'üî• –í–æ–≥–Ω—è–Ω–∞'; these values are in Ukrainian. I can map emojis based on AttackType too, but to keep it simple, it might be best to just display AttackType.value. I also need to set up callback data using AutocardAttackCallback with field code 't' for type. I‚Äôll ensure to include a way back to the attack fields and implement the AutocardAttackCallback handler for logic based on user actions.
**Determining menu actions**

I'm considering the actions for the attack menu's reply markup. It seems I can't edit it if the message doesn‚Äôt exist, which complicates things. For the action codes, 'x' will open the attack field menu using build_attack_fields_keyboard. The 'p' action adds an attack if there are fewer than two, updating blueprint_data and redis afterward. Then, I‚Äôll regenerate the image and update the message about the attack menu. Each code will have specific functions, like 'd' for deleting an attack at a specific index.
**Building attack input keyboard**

I'm planning to create a `build_attack_input_keyboard` with options for canceling input and going back to the attack menu. The keyboard will include buttons for these actions, using AutocardAttackCallback for the back button. When canceling input, it‚Äôs important to clear the FSM and restore the appropriate keyboard. I‚Äôm considering handling this in a separate cancel action specifically for the attack input, which will help ensure the correct keyboard is restored based on the previous state. This approach should keep things simple yet functional!
**Enhancing cancel functionality**

I‚Äôm considering the functionality of the cancel button, which could call AutocardEditCallback to clear the state and return to the edit menu. While it's fine to go back to the edit menu when canceling an attack edit, I think it‚Äôs better to return directly to the attack field. However, for simplicity, I‚Äôll keep the cancel function returning to the edit menu. 

I‚Äôll also set up state data to handle this more robustly. When asking for a typed value, I‚Äôll store the return mode in the FSM as either "edit_menu" or ‚Äúattack_fields.‚Äù This way, the cancel action can check the state and restore the correct keyboard based on what the user was working on.</details></think>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2** ‚Ä¢ Edit file: h:\repos\pomyyka-the-game\handlers\admin_autocard.py</summary>

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2** ‚Ä¢ Edit file: h:\repos\pomyyka-the-game\handlers\admin_autocard.py</summary>

</details>

</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** ‚Ä¢ Read file: h:\repos\pomyyka-the-game\utils\telegram_utils.py</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Implementing message handler**

I'm looking at the signature and it seems to match our intended uses! Now, I need to implement a typed input message handler for CardEditStates.waiting_for_value. The plan is to replace the old process_card_edit_json handler at the bottom. I should look for the patch that needs to be applied from around line 1116. Let's locate the old handler, which may still be present and referencing waiting_for_json. Time to search!</details></think>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "waiting_for_json|process_card_edit_json",
  "path": "h:\\repos\\pomyyka-the-game\\handlers\\admin_autocard.py",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "waiting_for_json|process_card_edit_json",
    "path": "h:\\repos\\pomyyka-the-game\\handlers\\admin_autocard.py",
    "outputMode": "content",
    "workspaceResults": {
      "h:\\repos\\pomyyka-the-game": {
        "content": {
          "matches": [
            {
              "file": "handlers\\admin_autocard.py",
              "matches": [
                {
                  "lineNumber": 2074,
                  "content": "@router.message(CardEditStates.waiting_for_json)"
                },
                {
                  "lineNumber": 2075,
                  "content": "async def process_card_edit_json(message: Message, state: FSMContext, bot: Bot) -&gt; None:"
                }
              ]
            }
          ],
          "totalLines": 2,
          "totalMatchedLines": 2
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Updating handler logic**

I notice that the old handler is still linked to waiting_for_json, but since we've changed the state to waiting_for_value, this handler is broken and won't be triggered. I realize that waiting_for_json no longer exists in CardEditStates, so the decorator referencing it will cause an error at import time. I need to update the handler to use waiting_for_value with new logic. I'll patch it accordingly. I've also added new callback classes with short prefixes to avoid conflicts. Time to work on that bottom handler!</details></think>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** ‚Ä¢ Read file: h:\repos\pomyyka-the-game\handlers\admin_autocard.py</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Evaluating code handler updates**

I‚Äôm thinking about completely replacing the old handler with a new typed input handler. The goal is not to send a status message but to update the preview directly using the stored message ID and chat ID with `_edit_preview_media`. I'm considering whether I still need to import the JSON module since it's currently only used in this handler. I‚Äôll need to quickly check the file for instances of `json.` to determine its necessity.</details></think>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "json\\.",
  "path": "h:\\repos\\pomyyka-the-game\\handlers\\admin_autocard.py",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "json\\.",
    "path": "h:\\repos\\pomyyka-the-game\\handlers\\admin_autocard.py",
    "outputMode": "content",
    "workspaceResults": {
      "h:\\repos\\pomyyka-the-game": {
        "content": {
          "matches": [
            {
              "file": "handlers\\admin_autocard.py",
              "matches": [
                {
                  "lineNumber": 2101,
                  "content": "            updates = json.loads(message.text or \"\")"
                },
                {
                  "lineNumber": 2102,
                  "content": "        except json.JSONDecodeError as e:"
                }
              ]
            }
          ],
          "totalLines": 2,
          "totalMatchedLines": 2
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Refactoring code clean-up**

I‚Äôm noticing that the `json` import at the top might be unused, so I should remove it later. I'm also considering whether to remove `from uuid import UUID` since it might not be used either. But I‚Äôll hold off for now and check for lints first. 

Next, I need to patch the message handler: I'll change the decorator to `@router.message(CardEditStates.waiting_for_value)`, rename the function to `process_card_edit_value`, and make sure to use the stored context.
**Implementing message handler**

I'm setting up the message handler with the decorator `@router.message(CardEditStates.waiting_for_value)` and defining the `process_card_edit_value` function. In this function, I‚Äôll first check if the user is an admin and strip the text from the message. 

If the text is empty, I might choose to ignore it. Then, I‚Äôll retrieve data from the state, including the blueprint ID, chat ID, and message ID. After validating the blueprint data, depending on the scope, I‚Äôll apply appropriate updates and handle image regeneration. Finally, I‚Äôll update the blueprint in the session manager and adjust the keyboard accordingly.
**Patching input handling**

I need to allow for clearing the effect field, so if the text is any of {"-", "none", "null", "0"}, I‚Äôll set it to None. For `raw_image_prompt_en`, it should mainly be in English, but I won‚Äôt enforce it strictly. 

For the name, I‚Äôm thinking of enforcing a length limit of 80 characters, and for lore, maybe I‚Äôll set a max of 500 characters. If parsing fails for int fields, I should send an error message while keeping the state, allowing the user to retry. 

I also need to support a cancel command with `/cancel`, along with the existing cancel button, but I‚Äôll avoid sending too many messages. If there's an invalid input, I could reply with an error and keep the state, but I‚Äôm considering the option to delete invalid messages. Let‚Äôs get this patched!</details></think>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2** ‚Ä¢ Edit file: h:\repos\pomyyka-the-game\handlers\admin_autocard.py</summary>

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
**Considering state management**

I'm noting that pressing "m" doesn‚Äôt clear the state; it just edits the reply markup. This could be confusing since it leaves the system waiting for input. If the admin sends a message expecting a response, it might create issues. I think I should clear the state when leaving input mode to avoid accidental overlaps. For actions like "m" and "b," clearing the state will help prevent confusion, especially for any navigation away from input.
**Patching actions for better state management**

I'm thinking about patching actions like "m" and potentially "bm," "rm," and "am" to clear the state. However, these actions might come from the edit menu instead of the input keyboard, so I need to be cautious. I plan to modify the handle_autocard_edit_actions to include `await state.clear()` before editing the reply markup for "m" and the others. I already clear the state for "ci," and should also consider clearing it for attack actions if navigating away from input. Some actions regenerate images and change keyboards, but I need to ensure there's a clear path back from the biome/rarity menus.
**Evaluating AutocardEditCallback**

I need to ensure that the `AutocardEditCallback` handler responds to its own callbacks. However, the edit menu doesn‚Äôt currently include approve or cancel options; it just has field buttons and a back button. So, if users want to approve or regenerate, they would need to return to the main keyboard first, which is okay, but it might be cumbersome. To improve user experience, I‚Äôm considering adding approve/cancel options at the bottom of the edit keyboard for easier access, even if it makes the keyboard larger.
**Assessing regeneration and caption formatting**

I‚Äôm considering the user‚Äôs need for image regeneration without leaving the edit menu. While triggering regeneration is tied to editing, some users might prefer random regenerations. I'll keep the current setup but ensure they can easily cancel if needed by backing out. Next, I should address the bug with caption formatting for the initial preview. We're using `_format_caption_from_blueprint_data`, which handles memes and escapes, but it seems the initial caption might differ. This inconsistency could confuse users, especially with how escaping markdown is handled.
**Updating code and handling callbacks**

The existing code already uses `escape_markdown` in some areas, which seems to be functioning, so I‚Äôll trust that for now. In `_format_caption_from_blueprint_data`, I need to ensure we stick with using `**` for bold formatting to maintain consistency with the original code. I also need to update the imports for `InputMediaAnimation` and `InputMediaPhoto`, and remember to include `Bot` in `_edit_preview_media`. 

Now, I should look closely at the `AutocardAttackCallback` class to ensure the `idx` field has proper defaults. While some calls pass `idx=0`, others don't, so I‚Äôll need to maintain coherence. We should also check that we didn‚Äôt interfere with the `AutocardCallback` filter before updating the `process_card_edit_value` handler to handle messages appropriately, taking care to avoid unnecessary spam. Lastly, I'll confirm there are no lingering references to `waiting_for_json`.</details></think>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "waiting_for_json",
  "path": "h:\\repos\\pomyyka-the-game\\handlers\\admin_autocard.py",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "waiting_for_json",
    "path": "h:\\repos\\pomyyka-the-game\\handlers\\admin_autocard.py",
    "outputMode": "content",
    "workspaceResults": {
      "h:\\repos\\pomyyka-the-game": {
        "content": {}
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2** ‚Ä¢ Edit file: h:\repos\pomyyka-the-game\handlers\admin_autocard.py</summary>

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
**Patching state management**

I‚Äôm considering that action "s" (set biome/rarity) triggers regeneration and then calls a function that edits media, caption, and keyboard, which overrides the previous keyboard. However, we should clear any pending states first, so I‚Äôll add `await state.clear()` in action "s." It's also important for other actions like "m" and "x" to clear any pending states too. We need to be cautious and include `await state.clear()` at the start of action "s" in edit actions as a safe measure, ensuring clean states.
**Updating attack handlers**

I‚Äôm thinking that in the attack handler for actions "p," "d," and "s," I should also add `await state.clear()` to ensure we've cleared any pending states. This way, we can avoid any issues that might pop up due to leftover state data. It‚Äôs a small patch, but it should help keep everything neat and organized. Alright, I‚Äôll implement this change and see how it improves the handling of these actions.</details></think>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2** ‚Ä¢ Edit file: h:\repos\pomyyka-the-game\handlers\admin_autocard.py</summary>

</details>

</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "_send_card_preview\\(",
  "path": "h:\\repos\\pomyyka-the-game",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "_send_card_preview\\(",
    "path": "h:\\repos\\pomyyka-the-game",
    "outputMode": "content",
    "workspaceResults": {
      "h:\\repos\\pomyyka-the-game": {
        "content": {
          "matches": [
            {
              "file": "handlers\\admin_autocard.py",
              "matches": [
                {
                  "lineNumber": 1211,
                  "content": "async def _send_card_preview("
                }
              ]
            },
            {
              "file": ".specstory/history/2026-01-02_19-02Z-generated-card-options.md",
              "matches": [
                {
                  "lineNumber": 742,
                  "content": "+ async def _send_card_preview("
                },
                {
                  "lineNumber": 907,
                  "content": "+         await _send_card_preview("
                },
                {
                  "lineNumber": 1275,
                  "content": "+         await _send_card_preview("
                },
                {
                  "lineNumber": 1411,
                  "content": "| &#96;handlers/admin_autocard.py&#96; | &#96;async def _send_card_preview(&#96; | L681 |"
                },
                {
                  "lineNumber": 1428,
                  "content": "| &#96;handlers/admin_autocard.py&#96; | &#96;await _send_card_preview(&#96; | L846 |"
                },
                {
                  "lineNumber": 1429,
                  "content": "| &#96;handlers/admin_autocard.py&#96; | &#96;await _send_card_preview(&#96; | L1212 |"
                },
                {
                  "lineNumber": 1508,
                  "content": "+ #### &amp;#96;_send_card_preview(message, blueprint_data, image_url, blueprint_id)&amp;#96;"
                },
                {
                  "lineNumber": 1820,
                  "content": "+     _send_card_preview()"
                },
                {
                  "lineNumber": 1881,
                  "content": "+             ‚îú‚îÄ‚ñ∫ _send_card_preview()"
                }
              ]
            },
            {
              "file": "IMPLEMENTATION_SUMMARY.md",
              "matches": [
                {
                  "lineNumber": 35,
                  "content": "#### &#96;_send_card_preview(message, blueprint_data, image_url, blueprint_id)&#96;"
                }
              ]
            },
            {
              "file": "CARD_GENERATION_FLOW.md",
              "matches": [
                {
                  "lineNumber": 120,
                  "content": "    _send_card_preview()"
                },
                {
                  "lineNumber": 181,
                  "content": "            ‚îú‚îÄ‚ñ∫ _send_card_preview()"
                }
              ]
            }
          ],
          "totalLines": 13,
          "totalMatchedLines": 13
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "\\bUUID\\b",
  "path": "h:\\repos\\pomyyka-the-game\\handlers\\admin_autocard.py",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "\\bUUID\\b",
    "path": "h:\\repos\\pomyyka-the-game\\handlers\\admin_autocard.py",
    "outputMode": "content",
    "workspaceResults": {
      "h:\\repos\\pomyyka-the-game": {
        "content": {
          "matches": [
            {
              "file": "handlers\\admin_autocard.py",
              "matches": [
                {
                  "lineNumber": 4,
                  "content": "from uuid import UUID"
                },
                {
                  "lineNumber": 53,
                  "content": "    blueprint_id: str  # UUID string for Redis-stored blueprint data"
                }
              ]
            }
          ],
          "totalLines": 2,
          "totalMatchedLines": 2
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2** ‚Ä¢ Edit file: h:\repos\pomyyka-the-game\handlers\admin_autocard.py</summary>

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
**Clarifying import issues**

Okay, I see there's been some confusion with the code. We accidentally kept the `import json` and added a `# noqa: F401` comment when we really intended to remove both the `json` and `UUID` imports. The comment only suppresses warnings if we're using flake8, which I'm not totally clear on whether we're utilizing. It seems best to just remove the `json` import entirely since it doesn't appear to be in use anymore. Let‚Äôs update the file accordingly!</details></think>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** ‚Ä¢ Read file: h:\repos\pomyyka-the-game\handlers\admin_autocard.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2** ‚Ä¢ Edit file: h:\repos\pomyyka-the-game\handlers\admin_autocard.py</summary>

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
**Verifying code changes**

I‚Äôve removed the JSON import completely, which is great! Now, I need to check if there's a blank line after the docstring. I want to verify if the first lines look correct. It's always good to ensure my formatting is tidy, so nothing unexpected sneaks in. Let's check those first lines to confirm everything is as it should be!</details></think>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** ‚Ä¢ Read file: h:\repos\pomyyka-the-game\handlers\admin_autocard.py</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Cleaning up imports**

I need to ensure there are no unused imports causing lints. We added `desc`, `distinct`, etc. earlier, which is fine. However, we imported `Path` in `_edit_preview_media` but haven‚Äôt used it, so it would be best to remove it to avoid unnecessary lints. I‚Äôll search for `from pathlib import Path` within `_edit_preview_media` to confirm its status and patch it. Also, `_pick_preview_media_path` does use `Path`, so I‚Äôll keep that in mind while tidying up!</details></think>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "async def _edit_preview_media\\([\\s\\S]*?from pathlib import Path",
  "path": "h:\\repos\\pomyyka-the-game\\handlers\\admin_autocard.py",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "async def _edit_preview_media\\([\\s\\S]*?from pathlib import Path",
    "path": "h:\\repos\\pomyyka-the-game\\handlers\\admin_autocard.py",
    "outputMode": "content",
    "workspaceResults": {
      "h:\\repos\\pomyyka-the-game": {
        "content": {}
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Looking into import paths**

I‚Äôm thinking that perhaps the import path is still valid, but it‚Äôs just not found because of multiline issues. It seems like a good idea to search through the file for the specific line "from pathlib import Path." By doing that, I might figure out what's going wrong with the import. Let's see if I can spot any issues related to it; it's always good to double-check!</details></think>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "from pathlib import Path",
  "path": "h:\\repos\\pomyyka-the-game\\handlers\\admin_autocard.py",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "from pathlib import Path",
    "path": "h:\\repos\\pomyyka-the-game\\handlers\\admin_autocard.py",
    "outputMode": "content",
    "workspaceResults": {
      "h:\\repos\\pomyyka-the-game": {
        "content": {
          "matches": [
            {
              "file": "handlers\\admin_autocard.py",
              "matches": [
                {
                  "lineNumber": 537,
                  "content": "    from pathlib import Path"
                },
                {
                  "lineNumber": 568,
                  "content": "    from pathlib import Path"
                },
                {
                  "lineNumber": 1068,
                  "content": "            from pathlib import Path"
                },
                {
                  "lineNumber": 1223,
                  "content": "    from pathlib import Path"
                }
              ]
            }
          ],
          "totalLines": 4,
          "totalMatchedLines": 4
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
I notice there are several local imports, and I need to determine which ones are actually necessary. I'm focusing on line 1223 to see if it relates to the _pick function. I also want to clean up any unused imports around lines 537 or 568. I'll check those areas to understand their context better. The file is pretty large, so I‚Äôll concentrate on lines 520-580 to gather more information.</details></think>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** ‚Ä¢ Read file: h:\repos\pomyyka-the-game\handlers\admin_autocard.py</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Removing unused imports**

I noticed that the import statement for Path at line 568 is actually unused. So, it makes sense to remove that line! I am also checking that the Path import on line 537 is indeed used within a function, which is good. So, to keep the code clean, I'll go ahead and patch it to remove the unused import at line 568. The code will be more streamlined that way!</details></think>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2** ‚Ä¢ Edit file: h:\repos\pomyyka-the-game\handlers\admin_autocard.py</summary>

</details>

</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "class CardTemplate|rarity",
  "path": "h:\\repos\\pomyyka-the-game\\database\\models.py",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "class CardTemplate|rarity",
    "path": "h:\\repos\\pomyyka-the-game\\database\\models.py",
    "outputMode": "content",
    "workspaceResults": {
      "h:\\repos\\pomyyka-the-game": {
        "content": {
          "matches": [
            {
              "file": "database\\models.py",
              "matches": [
                {
                  "lineNumber": 41,
                  "content": "class CardTemplate(Base):"
                },
                {
                  "lineNumber": 51,
                  "content": "    rarity: Mapped[Rarity] = mapped_column("
                }
              ]
            }
          ],
          "totalLines": 2,
          "totalMatchedLines": 2
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** ‚Ä¢ Read file: h:\repos\pomyyka-the-game\database\models.py</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Verifying code changes**

I need to make sure our new callback handlers, which use the prefixes "aced" and "acat," don't conflict with others. That looks good! Next, I'll remove the now-unused imports like `json` and `UUID`. I'm also updating `services/session_manager.py` to ensure `update_blueprint` uses `int | None`, since we're on Python 3.14. I might adjust the tests afterward, but first, I want to run ReadLints on the modified files: `art_forge.py`, `nano_banana.py`, `session_manager.py`, and `admin_autocard.py`.</details></think>

---

<tool-use data-tool-type="unknown" data-tool-name="read_lints">
<details>
<summary>Tool use: **read_lints**</summary>


Parameters:

```json
{
  "paths": [
    "h:\\repos\\pomyyka-the-game\\services\\art_forge.py",
    "h:\\repos\\pomyyka-the-game\\services\\nano_banana.py",
    "h:\\repos\\pomyyka-the-game\\services\\session_manager.py",
    "h:\\repos\\pomyyka-the-game\\handlers\\admin_autocard.py"
  ]
}
```
Result:

```json
{
  "linterErrorsByFile": [
    {
      "relativeWorkspacePath": "h:\\repos\\pomyyka-the-game\\services\\art_forge.py"
    },
    {
      "relativeWorkspacePath": "h:\\repos\\pomyyka-the-game\\services\\nano_banana.py"
    },
    {
      "relativeWorkspacePath": "h:\\repos\\pomyyka-the-game\\services\\session_manager.py"
    },
    {
      "relativeWorkspacePath": "h:\\repos\\pomyyka-the-game\\handlers\\admin_autocard.py",
      "errors": [
        {
          "message": "Import \"aiogram\" could not be resolved",
          "range": {
            "startPosition": {
              "line": 3,
              "column": 6
            },
            "endPosition": {
              "line": 3,
              "column": 13
            }
          },
          "source": "basedpyright",
          "severity": "DIAGNOSTIC_SEVERITY_WARNING"
        },
        {
          "message": "Import \"aiogram.filters\" could not be resolved",
          "range": {
            "startPosition": {
              "line": 4,
              "column": 6
            },
            "endPosition": {
              "line": 4,
              "column": 21
            }
          },
          "source": "basedpyright",
          "severity": "DIAGNOSTIC_SEVERITY_WARNING"
        },
        {
          "message": "Import \"aiogram.filters.callback_data\" could not be resolved",
          "range": {
            "startPosition": {
              "line": 5,
              "column": 6
            },
            "endPosition": {
              "line": 5,
              "column": 35
            }
          },
          "source": "basedpyright",
          "severity": "DIAGNOSTIC_SEVERITY_WARNING"
        },
        {
          "message": "Import \"aiogram.fsm.context\" could not be resolved",
          "range": {
            "startPosition": {
              "line": 6,
              "column": 6
            },
            "endPosition": {
              "line": 6,
              "column": 25
            }
          },
          "source": "basedpyright",
          "severity": "DIAGNOSTIC_SEVERITY_WARNING"
        },
        {
          "message": "Import \"aiogram.fsm.state\" could not be resolved",
          "range": {
            "startPosition": {
              "line": 7,
              "column": 6
            },
            "endPosition": {
              "line": 7,
              "column": 23
            }
          },
          "source": "basedpyright",
          "severity": "DIAGNOSTIC_SEVERITY_WARNING"
        },
        {
          "message": "Import \"aiogram.types\" could not be resolved",
          "range": {
            "startPosition": {
              "line": 8,
              "column": 6
            },
            "endPosition": {
              "line": 8,
              "column": 19
            }
          },
          "source": "basedpyright",
          "severity": "DIAGNOSTIC_SEVERITY_WARNING"
        },
        {
          "message": "Import \"sqlalchemy\" could not be resolved",
          "range": {
            "startPosition": {
              "line": 17,
              "column": 6
            },
            "endPosition": {
              "line": 17,
              "column": 16
            }
          },
          "source": "basedpyright",
          "severity": "DIAGNOSTIC_SEVERITY_WARNING"
        },
        {
          "message": "Import \"sqlalchemy.dialects.postgresql\" could not be resolved",
          "range": {
            "startPosition": {
              "line": 18,
              "column": 6
            },
            "endPosition": {
              "line": 18,
              "column": 36
            }
          },
          "source": "basedpyright",
          "severity": "DIAGNOSTIC_SEVERITY_WARNING"
        },
        {
          "message": "\"Path\" is not defined",
          "range": {
            "startPosition": {
              "line": 535,
              "column": 75
            },
            "endPosition": {
              "line": 535,
              "column": 79
            }
          },
          "source": "basedpyright",
          "severity": "DIAGNOSTIC_SEVERITY_WARNING"
        },
        {
          "message": "\"Optional\" is not defined",
          "range": {
            "startPosition": {
              "line": 1148,
              "column": 12
            },
            "endPosition": {
              "line": 1148,
              "column": 20
            }
          },
          "source": "basedpyright",
          "severity": "DIAGNOSTIC_SEVERITY_WARNING"
        }
      ]
    }
  ]
}
```
Status: **completed**


</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Resolving import issues**

I'm thinking about a possible "Path not defined" error, which might relate to forward references. To fix this, I should consider importing `Path` globally from `pathlib`. This way, I can use `tuple[Path, bool]` without quotes, which should resolve the issue. Instead of having local imports, moving it to the top of the file keeps the code cleaner. I noticed I also have to address the absence of "Optional" being defined at line 1148:12.
**Clarifying type annotations**

I think the issue stems from the `_regenerate_card_image` function's return type annotation, which is `tuple[Optional[str], InlineKeyboardMarkup]`. It looks like they didn't import `Optional` at the top of `admin_autocard.py`, leading to complaints from Pyright. Instead of using `Optional[str]`, I should change the annotation to `str | None`, as it's a more straightforward approach. Additionally, the return type documentation suggests it returns a tuple, but it actually returns a string or None, so I should make those adjustments for clarity. I'll also consider adding `from pathlib import Path` at the top.
**Planning code adjustments**

I'm considering some adjustments to the code, starting by replacing the return type of `_pick_preview_media_path` to `tuple[Path, bool]`, while also removing the local import of `Path` within that function. 

There are other instances of local imports for `Path`, but I think they might be okay to leave as they are for now. 

For the `_regenerate_card_image` function, I‚Äôll change the signature to `) -> str | None` and update the documentation accordingly, which will remove the need for importing `Optional`.

First, I‚Äôll add `from pathlib import Path` at the top of the file, right after the docstring and before the aiogram imports. I'll make these patches now!</details></think>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2** ‚Ä¢ Edit file: h:\repos\pomyyka-the-game\handlers\admin_autocard.py</summary>

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2** ‚Ä¢ Edit file: h:\repos\pomyyka-the-game\handlers\admin_autocard.py</summary>

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
**Fixing code imports and function**

I need to think about cleaning up some unused imports, like Path, but it might not be critical. I should also address the Optional import issue, which means updating the `_regenerate_card_image` function's signature and documentation. I‚Äôll need to locate it earlier in the code, around line 625 or so, and then make the necessary adjustments. First step is to find the function header. Let's get to work on this!</details></think>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "async def _regenerate_card_image\\(",
  "path": "h:\\repos\\pomyyka-the-game\\handlers\\admin_autocard.py",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "async def _regenerate_card_image\\(",
    "path": "h:\\repos\\pomyyka-the-game\\handlers\\admin_autocard.py",
    "outputMode": "content",
    "workspaceResults": {
      "h:\\repos\\pomyyka-the-game": {
        "content": {
          "matches": [
            {
              "file": "handlers\\admin_autocard.py",
              "matches": [
                {
                  "lineNumber": 1145,
                  "content": "async def _regenerate_card_image("
                }
              ]
            }
          ],
          "totalLines": 1,
          "totalMatchedLines": 1
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** ‚Ä¢ Read file: h:\repos\pomyyka-the-game\handlers\admin_autocard.py</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Updating annotations and parameters**

I need to change the return annotation to `str | None` and update the documentation lines. I noticed the `bot` parameter is unused, so I could prefix it with an underscore or remove it altogether. Honestly, renaming it to `_bot` might be a way to satisfy linting rules, but it isn‚Äôt strictly necessary. I also found that the annotation includes `InlineKeyboardMarkup`, which is incorrect, so I‚Äôll fix that to `str | None` and adjust the documentation accordingly.</details></think>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2** ‚Ä¢ Edit file: h:\repos\pomyyka-the-game\handlers\admin_autocard.py</summary>

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
**Fixing import issues**

So, the optional undefined issue is fixed, but I noticed we still imported InlineKeyboardMarkup in the type doc. Actually, in _regenerate_card_image, I've removed InlineKeyboardMarkup from the return annotation, which is good! Now, I think I should rerun the lints for that file to make sure there are no more warnings. I'll run ReadLints again. The environment may still show some import warnings, but the Path and Optional warnings should be resolved now. Let's do this!</details></think>

---

<tool-use data-tool-type="generic" data-tool-name="read_lints">
<details>
          <summary>Tool use: **read_lints** ‚Ä¢ Read lints for 1 file</summary>
      
Lint paths:

- `h:\repos\pomyyka-the-game\handlers\admin_autocard.py`

Lint results

Lint errors for `h:\repos\pomyyka-the-game\handlers\admin_autocard.py`


| Message | Range | Severity |
|-------|-------|----------|
| Import "aiogram" could not be resolved | 5:6-5:13 | DIAGNOSTIC_SEVERITY_WARNING |
| Import "aiogram.filters" could not be resolved | 6:6-6:21 | DIAGNOSTIC_SEVERITY_WARNING |
| Import "aiogram.filters.callback_data" could not be resolved | 7:6-7:35 | DIAGNOSTIC_SEVERITY_WARNING |
| Import "aiogram.fsm.context" could not be resolved | 8:6-8:25 | DIAGNOSTIC_SEVERITY_WARNING |
| Import "aiogram.fsm.state" could not be resolved | 9:6-9:23 | DIAGNOSTIC_SEVERITY_WARNING |
| Import "aiogram.types" could not be resolved | 10:6-10:19 | DIAGNOSTIC_SEVERITY_WARNING |
| Import "sqlalchemy" could not be resolved | 19:6-19:16 | DIAGNOSTIC_SEVERITY_WARNING |
| Import "sqlalchemy.dialects.postgresql" could not be resolved | 20:6-20:36 | DIAGNOSTIC_SEVERITY_WARNING |


</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Running Tests and Ensuring Setup**

I‚Äôm thinking about running some targeted tests, possibly using `python -m compileall`. It feels like running `pytest` is also a good idea to be thorough. I need to check the terminals folder beforehand since I might be running into issues with environment variables or dependencies. Even though the tests won't be long-running, I want to ensure everything is set up correctly. Let‚Äôs go ahead and execute `pytest -q` and see how it goes!
**Setting Working Directory**

I want to make sure the working directory is set to the correct repository path before running any commands. I'm planning to set the working directory to "h:\\repos\\pomyyka-the-game". After confirming that, I‚Äôll use the Shell tool to execute any necessary commands. It‚Äôs all about ensuring that everything is in the right place before proceeding!</details></think>

---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_command_v2">
<details><summary>Tool use: **run_terminal_command_v2** ‚Ä¢ Run command: python -m pytest -q</summary>

```bash
python -m pytest -q
```

```
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\python.exe: No module named pytest

```
</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Evaluating testing dependencies**

I noticed that Pytest isn't installed in the environment, but the project likely expects some dependencies. I could install them using `pip install -r requirements.txt`. There's also a `pyproject.toml`, so maybe I should try `pip install -e .` instead. The user didn‚Äôt specifically ask to install dependencies, just to verify if we can run tests. I wonder if installing Pytest could be fine. I should check the `pyproject` file to see if it lists any dependencies, including Pytest.</details></think>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** ‚Ä¢ Read file: h:\repos\pomyyka-the-game\pyproject.toml</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Setting up pytest dependencies**

I see that pytest is an optional development dependency that's not installed in the environment. To verify, we can install the dev extras using `pip install .[dev]`. I‚Äôll make sure it‚Äôs done without adding new dependencies since it‚Äôs already in pyproject. Since the user is on Windows with Python 3.14, I‚Äôll run `python -m pip install -e .[dev]` and use the Shell tool, ensuring everything is quoted and the working directory is set to the repo path.</details></think>

---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_command_v2">
<details><summary>Tool use: **run_terminal_command_v2** ‚Ä¢ Run command: python -m pip install -e ".[dev]"</summary>

```bash
python -m pip install -e ".[dev]"
```

```
Obtaining file:///H:/repos/pomyyka-the-game
  Installing build dependencies: started
  Installing build dependencies: finished with status 'done'
  Checking if build backend supports build_editable: started
  Checking if build backend supports build_editable: finished with status 'done'
  Getting requirements to build editable: started
  Getting requirements to build editable: finished with status 'error'
  error: subprocess-exited-with-error
  
  Getting requirements to build editable did not run successfully.
  exit code: 1
  
  [14 lines of output]
  error: Multiple top-level packages discovered in a flat-layout: ['data', 'assets', 'database', 'handlers', 'services', 'middlewares'].
  
  To avoid accidental inclusion of unwanted files or directories,
  setuptools will not proceed with this build.
  
  If you are trying to create a single distribution with multiple packages
  on purpose, you should not rely on automatic discovery.
  Instead, consider the following options:
  
  1. set up custom discovery (&#96;find&#96; directive with &#96;include&#96; or &#96;exclude&#96;)
  2. use a &#96;src-layout&#96;
  3. explicitly set &#96;py_modules&#96; or &#96;packages&#96; with a list of names
  
  To find more information, look for "package discovery" on setuptools docs.
  [end of output]
  
  note: This error originates from a subprocess, and is likely not a problem with pip.
ERROR: Failed to build 'file:///H:/repos/pomyyka-the-game' when getting requirements to build editable

```
</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Installing dependencies for tests**

I see that aiogram isn't resolved, which likely means it's not installed. I need to install the project runtime dependencies from the pyproject file. For testing, I have a list that includes things like aiogram, asyncpg, and sqlalchemy.

Plus, I should consider adding dev dependencies like pytest and fakeredis. Oh, and pytest-cov seems necessary for coverage reports! I‚Äôll install all these packages using pip, even if it takes some time. It's essential for verification!
I‚Äôm thinking about running `python -m pip install` with the dependency list. It might take a bit of time, but that‚Äôs totally fine. I know it‚Äôs essential to get everything set up properly, even if it seems like a long process. Hopefully, it'll go smoothly, and I just want to make sure I don‚Äôt miss anything important. Let's get this going!</details></think>

---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_command_v2">
<details><summary>Tool use: **run_terminal_command_v2** ‚Ä¢ Run command: python -m pip install "aiogram>=3.17,<4.0" "asyncpg>=0.29.0" "sqlalchemy[asyncio]>=2.0.0" "alembic>=1.13.0" "redis>=5.2.0,<6.0" "apscheduler>=3.10.0" "google-genai==1.56.0" "pydantic>=2.10,<3.0" "pydantic-settings>=2.1.0" "structlog>=24.1.0" "python-dotenv>=1.0.0" "Pillow>=10.0.0" "numpy>=1.24.0" "pytest>=8.0.0" "pytest-asyncio>=0.23.0" "pytest-mock>=3.14.0" "pytest-cov>=5.0.0" "pytest-xdist>=3.6.0" "faker>=33.0.0" "httpx>=0.27.0" "fakeredis>=2.25.0" "aiosqlite>=0.20.0"</summary>

```bash
python -m pip install "aiogram>=3.17,<4.0" "asyncpg>=0.29.0" "sqlalchemy[asyncio]>=2.0.0" "alembic>=1.13.0" "redis>=5.2.0,<6.0" "apscheduler>=3.10.0" "google-genai==1.56.0" "pydantic>=2.10,<3.0" "pydantic-settings>=2.1.0" "structlog>=24.1.0" "python-dotenv>=1.0.0" "Pillow>=10.0.0" "numpy>=1.24.0" "pytest>=8.0.0" "pytest-asyncio>=0.23.0" "pytest-mock>=3.14.0" "pytest-cov>=5.0.0" "pytest-xdist>=3.6.0" "faker>=33.0.0" "httpx>=0.27.0" "fakeredis>=2.25.0" "aiosqlite>=0.20.0"
```

```
Collecting aiogram&lt;4.0,&gt;=3.17
  Downloading aiogram-3.24.0-py3-none-any.whl.metadata (6.7 kB)
Collecting asyncpg&gt;=0.29.0
  Downloading asyncpg-0.31.0-cp314-cp314-win_amd64.whl.metadata (4.5 kB)
Collecting sqlalchemy&gt;=2.0.0 (from sqlalchemy[asyncio]&gt;=2.0.0)
  Downloading sqlalchemy-2.0.45-cp314-cp314-win_amd64.whl.metadata (9.8 kB)
Collecting alembic&gt;=1.13.0
  Downloading alembic-1.17.2-py3-none-any.whl.metadata (7.2 kB)
Collecting redis&lt;6.0,&gt;=5.2.0
  Downloading redis-5.3.1-py3-none-any.whl.metadata (9.2 kB)
Collecting apscheduler&gt;=3.10.0
  Downloading apscheduler-3.11.2-py3-none-any.whl.metadata (6.4 kB)
Collecting google-genai==1.56.0
  Downloading google_genai-1.56.0-py3-none-any.whl.metadata (53 kB)
Collecting pydantic&lt;3.0,&gt;=2.10
  Downloading pydantic-2.12.5-py3-none-any.whl.metadata (90 kB)
Collecting pydantic-settings&gt;=2.1.0
  Downloading pydantic_settings-2.12.0-py3-none-any.whl.metadata (3.4 kB)
Collecting structlog&gt;=24.1.0
  Downloading structlog-25.5.0-py3-none-any.whl.metadata (9.5 kB)
Collecting python-dotenv&gt;=1.0.0
  Downloading python_dotenv-1.2.1-py3-none-any.whl.metadata (25 kB)
Requirement already satisfied: Pillow&gt;=10.0.0 in c:\users\thathunky\appdata\local\programs\python\python314\lib\site-packages (12.1.0)
Collecting numpy&gt;=1.24.0
  Downloading numpy-2.4.0-cp314-cp314-win_amd64.whl.metadata (6.6 kB)
Collecting pytest&gt;=8.0.0
  Downloading pytest-9.0.2-py3-none-any.whl.metadata (7.6 kB)
Collecting pytest-asyncio&gt;=0.23.0
  Downloading pytest_asyncio-1.3.0-py3-none-any.whl.metadata (4.1 kB)
Collecting pytest-mock&gt;=3.14.0
  Downloading pytest_mock-3.15.1-py3-none-any.whl.metadata (3.9 kB)
Collecting pytest-cov&gt;=5.0.0
  Downloading pytest_cov-7.0.0-py3-none-any.whl.metadata (31 kB)
Collecting pytest-xdist&gt;=3.6.0
  Downloading pytest_xdist-3.8.0-py3-none-any.whl.metadata (3.0 kB)
Collecting faker&gt;=33.0.0
  Downloading faker-40.1.0-py3-none-any.whl.metadata (16 kB)
Collecting httpx&gt;=0.27.0
  Downloading httpx-0.28.1-py3-none-any.whl.metadata (7.1 kB)
Collecting fakeredis&gt;=2.25.0
  Downloading fakeredis-2.33.0-py3-none-any.whl.metadata (4.4 kB)
Collecting aiosqlite&gt;=0.20.0
  Downloading aiosqlite-0.22.1-py3-none-any.whl.metadata (4.3 kB)
Collecting anyio&lt;5.0.0,&gt;=4.8.0 (from google-genai==1.56.0)
  Downloading anyio-4.12.0-py3-none-any.whl.metadata (4.3 kB)
Collecting google-auth&lt;3.0.0,&gt;=2.45.0 (from google-auth[requests]&lt;3.0.0,&gt;=2.45.0-&gt;google-genai==1.56.0)
  Downloading google_auth-2.45.0-py2.py3-none-any.whl.metadata (6.8 kB)
Collecting requests&lt;3.0.0,&gt;=2.28.1 (from google-genai==1.56.0)
  Downloading requests-2.32.5-py3-none-any.whl.metadata (4.9 kB)
Collecting tenacity&lt;9.2.0,&gt;=8.2.3 (from google-genai==1.56.0)
  Downloading tenacity-9.1.2-py3-none-any.whl.metadata (1.2 kB)
Collecting websockets&lt;15.1.0,&gt;=13.0.0 (from google-genai==1.56.0)
  Downloading websockets-15.0.1-py3-none-any.whl.metadata (6.8 kB)
Collecting typing-extensions&lt;5.0.0,&gt;=4.11.0 (from google-genai==1.56.0)
  Downloading typing_extensions-4.15.0-py3-none-any.whl.metadata (3.3 kB)
Collecting distro&lt;2,&gt;=1.7.0 (from google-genai==1.56.0)
  Downloading distro-1.9.0-py3-none-any.whl.metadata (6.8 kB)
Collecting sniffio (from google-genai==1.56.0)
  Downloading sniffio-1.3.1-py3-none-any.whl.metadata (3.9 kB)
Collecting aiofiles&lt;26.0,&gt;=23.2.1 (from aiogram&lt;4.0,&gt;=3.17)
  Downloading aiofiles-25.1.0-py3-none-any.whl.metadata (6.3 kB)
Collecting aiohttp&lt;3.14,&gt;=3.9.0 (from aiogram&lt;4.0,&gt;=3.17)
  Downloading aiohttp-3.13.2-cp314-cp314-win_amd64.whl.metadata (8.4 kB)
Collecting certifi&gt;=2023.7.22 (from aiogram&lt;4.0,&gt;=3.17)
  Downloading certifi-2025.11.12-py3-none-any.whl.metadata (2.5 kB)
Collecting magic-filter&lt;1.1,&gt;=1.0.12 (from aiogram&lt;4.0,&gt;=3.17)
  Downloading magic_filter-1.0.12-py3-none-any.whl.metadata (1.5 kB)
Collecting PyJWT&gt;=2.9.0 (from redis&lt;6.0,&gt;=5.2.0)
  Downloading PyJWT-2.10.1-py3-none-any.whl.metadata (4.0 kB)
Collecting annotated-types&gt;=0.6.0 (from pydantic&lt;3.0,&gt;=2.10)
  Downloading annotated_types-0.7.0-py3-none-any.whl.metadata (15 kB)
Collecting pydantic-core==2.41.5 (from pydantic&lt;3.0,&gt;=2.10)
  Downloading pydantic_core-2.41.5-cp314-cp314-win_amd64.whl.metadata (7.4 kB)
Collecting typing-inspection&gt;=0.4.2 (from pydantic&lt;3.0,&gt;=2.10)
  Downloading typing_inspection-0.4.2-py3-none-any.whl.metadata (2.6 kB)
Collecting httpcore==1.* (from httpx&gt;=0.27.0)
  Downloading httpcore-1.0.9-py3-none-any.whl.metadata (21 kB)
Collecting idna (from httpx&gt;=0.27.0)
  Downloading idna-3.11-py3-none-any.whl.metadata (8.4 kB)
Collecting aiohappyeyeballs&gt;=2.5.0 (from aiohttp&lt;3.14,&gt;=3.9.0-&gt;aiogram&lt;4.0,&gt;=3.17)
  Downloading aiohappyeyeballs-2.6.1-py3-none-any.whl.metadata (5.9 kB)
Collecting aiosignal&gt;=1.4.0 (from aiohttp&lt;3.14,&gt;=3.9.0-&gt;aiogram&lt;4.0,&gt;=3.17)
  Downloading aiosignal-1.4.0-py3-none-any.whl.metadata (3.7 kB)
Collecting attrs&gt;=17.3.0 (from aiohttp&lt;3.14,&gt;=3.9.0-&gt;aiogram&lt;4.0,&gt;=3.17)
  Downloading attrs-25.4.0-py3-none-any.whl.metadata (10 kB)
Collecting frozenlist&gt;=1.1.1 (from aiohttp&lt;3.14,&gt;=3.9.0-&gt;aiogram&lt;4.0,&gt;=3.17)
  Downloading frozenlist-1.8.0-cp314-cp314-win_amd64.whl.metadata (21 kB)
Collecting multidict&lt;7.0,&gt;=4.5 (from aiohttp&lt;3.14,&gt;=3.9.0-&gt;aiogram&lt;4.0,&gt;=3.17)
  Downloading multidict-6.7.0-cp314-cp314-win_amd64.whl.metadata (5.5 kB)
Collecting propcache&gt;=0.2.0 (from aiohttp&lt;3.14,&gt;=3.9.0-&gt;aiogram&lt;4.0,&gt;=3.17)
  Downloading propcache-0.4.1-cp314-cp314-win_amd64.whl.metadata (14 kB)
Collecting yarl&lt;2.0,&gt;=1.17.0 (from aiohttp&lt;3.14,&gt;=3.9.0-&gt;aiogram&lt;4.0,&gt;=3.17)
  Downloading yarl-1.22.0-cp314-cp314-win_amd64.whl.metadata (77 kB)
Collecting cachetools&lt;7.0,&gt;=2.0.0 (from google-auth&lt;3.0.0,&gt;=2.45.0-&gt;google-auth[requests]&lt;3.0.0,&gt;=2.45.0-&gt;google-genai==1.56.0)
  Downloading cachetools-6.2.4-py3-none-any.whl.metadata (5.6 kB)
Collecting pyasn1-modules&gt;=0.2.1 (from google-auth&lt;3.0.0,&gt;=2.45.0-&gt;google-auth[requests]&lt;3.0.0,&gt;=2.45.0-&gt;google-genai==1.56.0)
  Downloading pyasn1_modules-0.4.2-py3-none-any.whl.metadata (3.5 kB)
Collecting rsa&lt;5,&gt;=3.1.4 (from google-auth&lt;3.0.0,&gt;=2.45.0-&gt;google-auth[requests]&lt;3.0.0,&gt;=2.45.0-&gt;google-genai==1.56.0)
  Downloading rsa-4.9.1-py3-none-any.whl.metadata (5.6 kB)
Collecting h11&gt;=0.16 (from httpcore==1.*-&gt;httpx&gt;=0.27.0)
  Downloading h11-0.16.0-py3-none-any.whl.metadata (8.3 kB)
Collecting charset_normalizer&lt;4,&gt;=2 (from requests&lt;3.0.0,&gt;=2.28.1-&gt;google-genai==1.56.0)
  Downloading charset_normalizer-3.4.4-cp314-cp314-win_amd64.whl.metadata (38 kB)
Collecting urllib3&lt;3,&gt;=1.21.1 (from requests&lt;3.0.0,&gt;=2.28.1-&gt;google-genai==1.56.0)
  Downloading urllib3-2.6.2-py3-none-any.whl.metadata (6.6 kB)
Collecting pyasn1&gt;=0.1.3 (from rsa&lt;5,&gt;=3.1.4-&gt;google-auth&lt;3.0.0,&gt;=2.45.0-&gt;google-auth[requests]&lt;3.0.0,&gt;=2.45.0-&gt;google-genai==1.56.0)
  Downloading pyasn1-0.6.1-py3-none-any.whl.metadata (8.4 kB)
Collecting greenlet&gt;=1 (from sqlalchemy&gt;=2.0.0-&gt;sqlalchemy[asyncio]&gt;=2.0.0)
  Downloading greenlet-3.3.0-cp314-cp314-win_amd64.whl.metadata (4.2 kB)
Collecting Mako (from alembic&gt;=1.13.0)
  Downloading mako-1.3.10-py3-none-any.whl.metadata (2.9 kB)
Collecting tzlocal&gt;=3.0 (from apscheduler&gt;=3.10.0)
  Downloading tzlocal-5.3.1-py3-none-any.whl.metadata (7.6 kB)
Collecting colorama&gt;=0.4 (from pytest&gt;=8.0.0)
  Downloading colorama-0.4.6-py2.py3-none-any.whl.metadata (17 kB)
Collecting iniconfig&gt;=1.0.1 (from pytest&gt;=8.0.0)
  Downloading iniconfig-2.3.0-py3-none-any.whl.metadata (2.5 kB)
Collecting packaging&gt;=22 (from pytest&gt;=8.0.0)
  Downloading packaging-25.0-py3-none-any.whl.metadata (3.3 kB)
Collecting pluggy&lt;2,&gt;=1.5 (from pytest&gt;=8.0.0)
  Downloading pluggy-1.6.0-py3-none-any.whl.metadata (4.8 kB)
Collecting pygments&gt;=2.7.2 (from pytest&gt;=8.0.0)
  Downloading pygments-2.19.2-py3-none-any.whl.metadata (2.5 kB)
Collecting coverage&gt;=7.10.6 (from coverage[toml]&gt;=7.10.6-&gt;pytest-cov&gt;=5.0.0)
  Downloading coverage-7.13.1-cp314-cp314-win_amd64.whl.metadata (8.7 kB)
Collecting execnet&gt;=2.1 (from pytest-xdist&gt;=3.6.0)
  Downloading execnet-2.1.2-py3-none-any.whl.metadata (2.9 kB)
Collecting tzdata (from faker&gt;=33.0.0)
  Downloading tzdata-2025.3-py2.py3-none-any.whl.metadata (1.4 kB)
Collecting sortedcontainers&gt;=2 (from fakeredis&gt;=2.25.0)
  Downloading sortedcontainers-2.4.0-py2.py3-none-any.whl.metadata (10 kB)
Collecting MarkupSafe&gt;=0.9.2 (from Mako-&gt;alembic&gt;=1.13.0)
  Downloading markupsafe-3.0.3-cp314-cp314-win_amd64.whl.metadata (2.8 kB)
Downloading google_genai-1.56.0-py3-none-any.whl (426 kB)
Downloading aiogram-3.24.0-py3-none-any.whl (706 kB)
   ---------------------------------------- 706.9/706.9 kB 9.5 MB/s  0:00:00

Downloading redis-5.3.1-py3-none-any.whl (272 kB)
Downloading pydantic-2.12.5-py3-none-any.whl (463 kB)
Downloading pydantic_core-2.41.5-cp314-cp314-win_amd64.whl (2.0 MB)
   ---------------------------------------- 2.0/2.0 MB 18.9 MB/s  0:00:00

Downloading httpx-0.28.1-py3-none-any.whl (73 kB)
Downloading aiofiles-25.1.0-py3-none-any.whl (14 kB)
Downloading aiohttp-3.13.2-cp314-cp314-win_amd64.whl (457 kB)
Downloading anyio-4.12.0-py3-none-any.whl (113 kB)
Downloading distro-1.9.0-py3-none-any.whl (20 kB)
Downloading google_auth-2.45.0-py2.py3-none-any.whl (233 kB)
Downloading cachetools-6.2.4-py3-none-any.whl (11 kB)
Downloading httpcore-1.0.9-py3-none-any.whl (78 kB)
Downloading magic_filter-1.0.12-py3-none-any.whl (11 kB)
Downloading multidict-6.7.0-cp314-cp314-win_amd64.whl (45 kB)
Downloading requests-2.32.5-py3-none-any.whl (64 kB)
Downloading charset_normalizer-3.4.4-cp314-cp314-win_amd64.whl (107 kB)
Downloading idna-3.11-py3-none-any.whl (71 kB)
Downloading rsa-4.9.1-py3-none-any.whl (34 kB)
Downloading tenacity-9.1.2-py3-none-any.whl (28 kB)
Downloading typing_extensions-4.15.0-py3-none-any.whl (44 kB)
Downloading urllib3-2.6.2-py3-none-any.whl (131 kB)
Downloading websockets-15.0.1-py3-none-any.whl (169 kB)
Downloading yarl-1.22.0-cp314-cp314-win_amd64.whl (88 kB)
Downloading asyncpg-0.31.0-cp314-cp314-win_amd64.whl (604 kB)
   ---------------------------------------- 604.9/604.9 kB 8.6 MB/s  0:00:00

Downloading sqlalchemy-2.0.45-cp314-cp314-win_amd64.whl (2.1 MB)
   ---------------------------------------- 2.1/2.1 MB 15.9 MB/s  0:00:00

Downloading alembic-1.17.2-py3-none-any.whl (248 kB)
Downloading apscheduler-3.11.2-py3-none-any.whl (64 kB)
Downloading pydantic_settings-2.12.0-py3-none-any.whl (51 kB)
Downloading structlog-25.5.0-py3-none-any.whl (72 kB)
Downloading python_dotenv-1.2.1-py3-none-any.whl (21 kB)
Downloading numpy-2.4.0-cp314-cp314-win_amd64.whl (12.4 MB)
   ---------------------------------------- 12.4/12.4 MB 21.8 MB/s  0:00:00

Downloading pytest-9.0.2-py3-none-any.whl (374 kB)
Downloading pluggy-1.6.0-py3-none-any.whl (20 kB)
Downloading pytest_asyncio-1.3.0-py3-none-any.whl (15 kB)
Downloading pytest_mock-3.15.1-py3-none-any.whl (10 kB)
Downloading pytest_cov-7.0.0-py3-none-any.whl (22 kB)
Downloading pytest_xdist-3.8.0-py3-none-any.whl (46 kB)
Downloading faker-40.1.0-py3-none-any.whl (2.0 MB)
   ---------------------------------------- 2.0/2.0 MB 16.3 MB/s  0:00:00

Downloading fakeredis-2.33.0-py3-none-any.whl (119 kB)
Downloading aiosqlite-0.22.1-py3-none-any.whl (17 kB)
Downloading aiohappyeyeballs-2.6.1-py3-none-any.whl (15 kB)
Downloading aiosignal-1.4.0-py3-none-any.whl (7.5 kB)
Downloading annotated_types-0.7.0-py3-none-any.whl (13 kB)
Downloading attrs-25.4.0-py3-none-any.whl (67 kB)
Downloading certifi-2025.11.12-py3-none-any.whl (159 kB)
Downloading colorama-0.4.6-py2.py3-none-any.whl (25 kB)
Downloading coverage-7.13.1-cp314-cp314-win_amd64.whl (222 kB)
Downloading execnet-2.1.2-py3-none-any.whl (40 kB)
Downloading frozenlist-1.8.0-cp314-cp314-win_amd64.whl (44 kB)
Downloading greenlet-3.3.0-cp314-cp314-win_amd64.whl (305 kB)
Downloading h11-0.16.0-py3-none-any.whl (37 kB)
Downloading iniconfig-2.3.0-py3-none-any.whl (7.5 kB)
Downloading packaging-25.0-py3-none-any.whl (66 kB)
Downloading propcache-0.4.1-cp314-cp314-win_amd64.whl (41 kB)
Downloading pyasn1-0.6.1-py3-none-any.whl (83 kB)
Downloading pyasn1_modules-0.4.2-py3-none-any.whl (181 kB)
Downloading pygments-2.19.2-py3-none-any.whl (1.2 MB)
   ---------------------------------------- 1.2/1.2 MB 10.7 MB/s  0:00:00

Downloading PyJWT-2.10.1-py3-none-any.whl (22 kB)
Downloading sortedcontainers-2.4.0-py2.py3-none-any.whl (29 kB)
Downloading typing_inspection-0.4.2-py3-none-any.whl (14 kB)
Downloading tzlocal-5.3.1-py3-none-any.whl (18 kB)
Downloading mako-1.3.10-py3-none-any.whl (78 kB)
Downloading markupsafe-3.0.3-cp314-cp314-win_amd64.whl (15 kB)
Downloading sniffio-1.3.1-py3-none-any.whl (10 kB)
Downloading tzdata-2025.3-py2.py3-none-any.whl (348 kB)
Installing collected packages: sortedcontainers, websockets, urllib3, tzdata, typing-extensions, tenacity, structlog, sniffio, python-dotenv, PyJWT, pygments, pyasn1, propcache, pluggy, packaging, numpy, multidict, MarkupSafe, magic-filter, iniconfig, idna, h11, greenlet, frozenlist, execnet, distro, coverage, colorama, charset_normalizer, certifi, cachetools, attrs, asyncpg, annotated-types, aiosqlite, aiohappyeyeballs, aiofiles, yarl, tzlocal, typing-inspection, sqlalchemy, rsa, requests, redis, pytest, pydantic-core, pyasn1-modules, Mako, httpcore, faker, anyio, aiosignal, pytest-xdist, pytest-mock, pytest-cov, pytest-asyncio, pydantic, httpx, google-auth, fakeredis, apscheduler, alembic, aiohttp, pydantic-settings, aiogram, google-genai


Successfully installed Mako-1.3.10 MarkupSafe-3.0.3 PyJWT-2.10.1 aiofiles-25.1.0 aiogram-3.24.0 aiohappyeyeballs-2.6.1 aiohttp-3.13.2 aiosignal-1.4.0 aiosqlite-0.22.1 alembic-1.17.2 annotated-types-0.7.0 anyio-4.12.0 apscheduler-3.11.2 asyncpg-0.31.0 attrs-25.4.0 cachetools-6.2.4 certifi-2025.11.12 charset_normalizer-3.4.4 colorama-0.4.6 coverage-7.13.1 distro-1.9.0 execnet-2.1.2 faker-40.1.0 fakeredis-2.33.0 frozenlist-1.8.0 google-auth-2.45.0 google-genai-1.56.0 greenlet-3.3.0 h11-0.16.0 httpcore-1.0.9 httpx-0.28.1 idna-3.11 iniconfig-2.3.0 magic-filter-1.0.12 multidict-6.7.0 numpy-2.4.0 packaging-25.0 pluggy-1.6.0 propcache-0.4.1 pyasn1-0.6.1 pyasn1-modules-0.4.2 pydantic-2.12.5 pydantic-core-2.41.5 pydantic-settings-2.12.0 pygments-2.19.2 pytest-9.0.2 pytest-asyncio-1.3.0 pytest-cov-7.0.0 pytest-mock-3.15.1 pytest-xdist-3.8.0 python-dotenv-1.2.1 redis-5.3.1 requests-2.32.5 rsa-4.9.1 sniffio-1.3.1 sortedcontainers-2.4.0 sqlalchemy-2.0.45 structlog-25.5.0 tenacity-9.1.2 typing-extensions-4.15.0 typing-inspection-0.4.2 tzdata-2025.3 tzlocal-5.3.1 urllib3-2.6.2 websockets-15.0.1 yarl-1.22.0

```
</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
I'm confirming that I've installed the necessary dependencies. Now, the next step is to run pytest again to check if everything's working as it should. It's like a little test I‚Äôm doing, hoping it all comes together smoothly. Fingers crossed that there are no hiccups this time! So, let‚Äôs see how it goes when I run the tests. It's exciting yet a bit nerve-wracking. I‚Äôll keep my eyes peeled for any issues!</details></think>

---

Cancelled

---

_**User**_

pytest hanged. Here's the log:


```
 
============================= test session starts =============================
platform win32 -- Python 3.14.2, pytest-9.0.2, pluggy-1.6.0
rootdir: H:\repos\pomyyka-the-game
configfile: pytest.ini (WARNING: ignoring pytest config in pyproject.toml!)
testpaths: tests
plugins: anyio-4.12.0, Faker-40.1.0, asyncio-1.3.0, cov-7.0.0, mock-3.15.1, xdist-3.8.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 144 items

tests\database\test_models.py EEEEEEEEEEEEE                              [  9%]
tests\database\test_session.py EEE                                       [ 11%]
tests\handlers\test_drops.py EE                                          [ 12%]
tests\integration\test_battle_flow.py E                                  [ 13%]
tests\integration\test_drop_flow.py E                                    [ 13%]
tests\middlewares\test_user_registration.py EEE                          [ 15%]
tests\services\test_battle_engine.py EEEEEEEEEEEEEEEEEEEEEEEEEEEEEE      [ 36%]
tests\services\test_cleanup.py EEE                                       [ 38%]
tests\services\test_redis_lock.py EEEEEEEEEEE                            [ 46%]
tests\services\test_scheduler.py EEEEE                                   [ 50%]
tests\utils\test_biomes.py EEEEEEEEEEEEE                                 [ 59%]
tests\utils\test_card_ids.py EEEEEE                                      [ 63%]
tests\utils\test_commands.py EEEEEEEEEE                                  [ 70%]
tests\utils\test_emojis.py EEEEEEEEEEEEEEEE                              [ 81%]
tests\utils\test_text.py EEEEEEEEEEEEEEEEEEEEEEEEEEE                     [100%]

=================================== ERRORS ====================================
________________ ERROR at setup of TestUser.test_user_creation ________________

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC678C0>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFEC87250>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFEC87390>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015FFEC67770>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015FFFCA8500>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC678C0>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC678C0> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_user_creation>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFEC87250>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFEC87390>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015FFEC67770>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015FFFCA8500>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC678C0> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
____________ ERROR at setup of TestUser.test_user_default_balance _____________

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49590>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFEC36F90>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFEC36E70>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015FFFE49450>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F91360FB0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49590>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49590> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_user_default_balance>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFEC36F90>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFEC36E70>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015FFFE49450>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F91360FB0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49590> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
___________ ERROR at setup of TestUser.test_user_relationship_cards ___________

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49F90>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFECBE250>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFECBE150>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015FFFE4BB10>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903BB5F0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49F90>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49F90> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

self = <Coroutine test_user_relationship_cards>

    def setup(self) -> None:
        runner_fixture_id = f"_{self._loop_scope}_scoped_runner"
        if runner_fixture_id not in self.fixturenames:
            self.fixturenames.append(runner_fixture_id)
>       return super().setup()
               ^^^^^^^^^^^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:458: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFECBE250>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFECBE150>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015FFFE4BB10>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903BB5F0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49F90> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
_______ ERROR at setup of TestCardTemplate.test_card_template_creation ________

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B390>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFEA5D7C0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFEA5D6D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015FFECCA650>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F91793050>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B390>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B390> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_card_template_creation>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFEA5D7C0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFEA5D6D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015FFECCA650>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F91793050>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B390> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
_____ ERROR at setup of TestCardTemplate.test_card_template_with_attacks ______

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015F901951D0>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F91BC6F70>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F91BC6C30>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F901AC9D0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F9018AB70>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015F901951D0>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015F901951D0> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_card_template_with_attacks>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F91BC6F70>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F91BC6C30>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F901AC9D0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F9018AB70>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015F901951D0> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
_____ ERROR at setup of TestCardTemplate.test_card_template_with_weakness _____

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015F90194690>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFEAB3E30>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFEAB20A0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F91221EB0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F9018B710>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015F90194690>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015F90194690> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_card_template_with_weakness>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFEAB3E30>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFEAB20A0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F91221EB0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F9018B710>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015F90194690> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
___________ ERROR at setup of TestUserCard.test_user_card_creation ____________

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015F90195F90>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFFD3A990>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFFD3AD50>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F901FEF10>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F9018F8F0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015F90195F90>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015F90195F90> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

self = <Coroutine test_user_card_creation>

    def setup(self) -> None:
        runner_fixture_id = f"_{self._loop_scope}_scoped_runner"
        if runner_fixture_id not in self.fixturenames:
            self.fixturenames.append(runner_fixture_id)
>       return super().setup()
               ^^^^^^^^^^^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:458: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFFD3A990>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFFD3AD50>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F901FEF10>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F9018F8F0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015F90195F90> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
__________ ERROR at setup of TestUserCard.test_user_card_acquired_at __________

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015F90195450>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFFD3A7B0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F90408E50>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F901FE690>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F901A60F0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015F90195450>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015F90195450> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

self = <Coroutine test_user_card_acquired_at>

    def setup(self) -> None:
        runner_fixture_id = f"_{self._loop_scope}_scoped_runner"
        if runner_fixture_id not in self.fixturenames:
            self.fixturenames.append(runner_fixture_id)
>       return super().setup()
               ^^^^^^^^^^^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:458: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFFD3A7B0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F90408E50>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F901FE690>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F901A60F0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015F90195450> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
_______ ERROR at setup of TestUserCard.test_user_card_unique_display_id _______

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEA35310>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFEBC9770>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F900700D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015FFEA11B50>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F9018AB70>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEA35310>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEA35310> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

self = <Coroutine test_user_card_unique_display_id>

    def setup(self) -> None:
        runner_fixture_id = f"_{self._loop_scope}_scoped_runner"
        if runner_fixture_id not in self.fixturenames:
            self.fixturenames.append(runner_fixture_id)
>       return super().setup()
               ^^^^^^^^^^^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:458: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFEBC9770>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F900700D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015FFEA11B50>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F9018AB70>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEA35310> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
__________ ERROR at setup of TestGroupChat.test_group_chat_creation ___________

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B890>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFFD3B430>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F903B6BD0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015FFECBC550>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F9018AD50>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B890>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B890> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_group_chat_creation>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFFD3B430>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F903B6BD0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015FFECBC550>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F9018AD50>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B890> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
_______ ERROR at setup of TestGroupChat.test_group_chat_default_active ________

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4A210>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFFD3B890>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F9180F7D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015FFFCA98B0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90171C70>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4A210>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4A210> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_group_chat_default_active>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFFD3B890>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F9180F7D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015FFFCA98B0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90171C70>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4A210> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
_ ERROR at setup of TestModelRelationships.test_card_template_user_cards_relationship _

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49E50>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFFD3B7F0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFEA934D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F907B3980>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F901E72F0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49E50>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49E50> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

self = <Coroutine test_card_template_user_cards_relationship>

    def setup(self) -> None:
        runner_fixture_id = f"_{self._loop_scope}_scoped_runner"
        if runner_fixture_id not in self.fixturenames:
            self.fixturenames.append(runner_fixture_id)
>       return super().setup()
               ^^^^^^^^^^^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:458: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFFD3B7F0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFEA934D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F907B3980>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F901E72F0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49E50> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
______ ERROR at setup of TestModelRelationships.test_cascade_delete_user ______

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC86AD0>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFFD38410>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F900A6A50>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015FFEA2AC10>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F901E54F0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC86AD0>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC86AD0> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

self = <Coroutine test_cascade_delete_user>

    def setup(self) -> None:
        runner_fixture_id = f"_{self._loop_scope}_scoped_runner"
        if runner_fixture_id not in self.fixturenames:
            self.fixturenames.append(runner_fixture_id)
>       return super().setup()
               ^^^^^^^^^^^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:458: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFFD38410>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F900A6A50>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015FFEA2AC10>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F901E54F0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC86AD0> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
________ ERROR at setup of TestSession.test_get_session_yields_session ________

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4BB10>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFFD3B7F0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F91D6C3D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015FFEA29010>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F9019F230>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4BB10>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4BB10> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

self = <Coroutine test_get_session_yields_session>

    def setup(self) -> None:
        runner_fixture_id = f"_{self._loop_scope}_scoped_runner"
        if runner_fixture_id not in self.fixturenames:
            self.fixturenames.append(runner_fixture_id)
>       return super().setup()
               ^^^^^^^^^^^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:458: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFFD3B7F0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F91D6C3D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015FFEA29010>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F9019F230>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4BB10> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
______ ERROR at setup of TestSession.test_get_session_commits_on_success ______

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE48F50>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFFD38550>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F903B6A50>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F91BC6000>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F901E41D0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE48F50>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE48F50> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

self = <Coroutine test_get_session_commits_on_success>

    def setup(self) -> None:
        runner_fixture_id = f"_{self._loop_scope}_scoped_runner"
        if runner_fixture_id not in self.fixturenames:
            self.fixturenames.append(runner_fixture_id)
>       return super().setup()
               ^^^^^^^^^^^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:458: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFFD38550>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F903B6A50>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F91BC6000>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F901E41D0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE48F50> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
______ ERROR at setup of TestSession.test_get_session_rollback_on_error _______

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4A5D0>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFFD3ACB0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFFCAF950>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90F3D310>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903C75F0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4A5D0>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4A5D0> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

self = <Coroutine test_get_session_rollback_on_error>

    def setup(self) -> None:
        runner_fixture_id = f"_{self._loop_scope}_scoped_runner"
        if runner_fixture_id not in self.fixturenames:
            self.fixturenames.append(runner_fixture_id)
>       return super().setup()
               ^^^^^^^^^^^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:458: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFFD3ACB0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFFCAF950>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90F3D310>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903C75F0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4A5D0> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
______ ERROR at setup of TestDropHandlers.test_claim_drop_callback_data _______

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B610>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C1C190>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F90456CD0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90F3E150>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903C67B0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B610>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B610> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

self = <Coroutine test_claim_drop_callback_data>

    def setup(self) -> None:
        runner_fixture_id = f"_{self._loop_scope}_scoped_runner"
        if runner_fixture_id not in self.fixturenames:
            self.fixturenames.append(runner_fixture_id)
>       return super().setup()
               ^^^^^^^^^^^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:458: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C1C190>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F90456CD0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90F3E150>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903C67B0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B610> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
__ ERROR at setup of TestDropHandlers.test_handle_claim_drop_already_claimed __

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEA34E10>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C1C230>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F90E35750>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015FFEA32E60>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903C3470>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEA34E10>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEA34E10> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

self = <Coroutine test_handle_claim_drop_already_claimed>

    def setup(self) -> None:
        runner_fixture_id = f"_{self._loop_scope}_scoped_runner"
        if runner_fixture_id not in self.fixturenames:
            self.fixturenames.append(runner_fixture_id)
>       return super().setup()
               ^^^^^^^^^^^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:458: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C1C230>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F90E35750>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015FFEA32E60>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903C3470>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEA34E10> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
_______ ERROR at setup of TestBattleFlow.test_complete_battle_execution _______

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC86E90>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C1C690>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F91D92650>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015FFEA959C0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903C1430>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC86E90>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC86E90> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

self = <Coroutine test_complete_battle_execution>

    def setup(self) -> None:
        runner_fixture_id = f"_{self._loop_scope}_scoped_runner"
        if runner_fixture_id not in self.fixturenames:
            self.fixturenames.append(runner_fixture_id)
>       return super().setup()
               ^^^^^^^^^^^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:458: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C1C690>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F91D92650>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015FFEA959C0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903C1430>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC86E90> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
________ ERROR at setup of TestDropFlow.test_complete_drop_claim_flow _________

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEA34E10>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C1CD70>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFEC0A9D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C1CB90>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903CB590>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEA34E10>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEA34E10> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

self = <Coroutine test_complete_drop_claim_flow>

    def setup(self) -> None:
        runner_fixture_id = f"_{self._loop_scope}_scoped_runner"
        if runner_fixture_id not in self.fixturenames:
            self.fixturenames.append(runner_fixture_id)
>       return super().setup()
               ^^^^^^^^^^^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:458: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C1CD70>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFEC0A9D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C1CB90>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903CB590>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEA34E10> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
_ ERROR at setup of TestUserRegistrationMiddleware.test_middleware_registers_new_user _

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE48A50>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C1E350>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F91B22850>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C1FD90>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903C3BF0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE48A50>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE48A50> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

self = <Coroutine test_middleware_registers_new_user>

    def setup(self) -> None:
        runner_fixture_id = f"_{self._loop_scope}_scoped_runner"
        if runner_fixture_id not in self.fixturenames:
            self.fixturenames.append(runner_fixture_id)
>       return super().setup()
               ^^^^^^^^^^^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:458: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C1E350>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F91B22850>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C1FD90>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903C3BF0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE48A50> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
_ ERROR at setup of TestUserRegistrationMiddleware.test_middleware_skips_existing_user _

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC86AD0>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFFD3B7F0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F91DB0AD0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015FFFD38D70>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903BD130>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC86AD0>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC86AD0> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

self = <Coroutine test_middleware_skips_existing_user>

    def setup(self) -> None:
        runner_fixture_id = f"_{self._loop_scope}_scoped_runner"
        if runner_fixture_id not in self.fixturenames:
            self.fixturenames.append(runner_fixture_id)
>       return super().setup()
               ^^^^^^^^^^^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:458: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFFD3B7F0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F91DB0AD0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015FFFD38D70>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903BD130>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC86AD0> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
_ ERROR at setup of TestUserRegistrationMiddleware.test_middleware_handles_callback_query _

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49450>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C1E850>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFFDED950>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C1D950>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903BE030>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49450>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49450> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

self = <Coroutine test_middleware_handles_callback_query>

    def setup(self) -> None:
        runner_fixture_id = f"_{self._loop_scope}_scoped_runner"
        if runner_fixture_id not in self.fixturenames:
            self.fixturenames.append(runner_fixture_id)
>       return super().setup()
               ^^^^^^^^^^^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:458: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C1E850>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFFDED950>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C1D950>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903BE030>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49450> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
_ ERROR at setup of TestTypeEffectiveness.test_calculate_type_effectiveness_no_weakness_or_resistance _

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4AFD0>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F903F1EF0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F90ACEDD0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015FFFD38CD0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903BFEF0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4AFD0>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4AFD0> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_calculate_type_effectiveness_no_weakness_or_resistance>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F903F1EF0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F90ACEDD0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015FFFD38CD0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903BFEF0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4AFD0> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
_ ERROR at setup of TestTypeEffectiveness.test_calculate_type_effectiveness_weakness_triggered _

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49D10>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F903F0050>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F907CDCD0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F903F13B0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903CE390>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49D10>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49D10> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_calculate_type_effectiveness_weakness_triggered>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F903F0050>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F907CDCD0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F903F13B0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903CE390>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49D10> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
_ ERROR at setup of TestTypeEffectiveness.test_calculate_type_effectiveness_resistance_flat_reduction _

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4BB10>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C1E850>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F90C08850>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015FFFD385F0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903FAF30>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4BB10>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4BB10> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_calculate_type_effectiveness_resistance_flat_reduction>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C1E850>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F90C08850>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015FFFD385F0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903FAF30>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4BB10> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
_ ERROR at setup of TestTypeEffectiveness.test_calculate_type_effectiveness_resistance_percentage _

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEA351D0>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFFD3A350>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F91C5C950>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015FFFD3AAD0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903FA9F0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEA351D0>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEA351D0> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_calculate_type_effectiveness_resistance_percentage>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFFD3A350>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F91C5C950>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015FFFD3AAD0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903FA9F0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEA351D0> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
_ ERROR at setup of TestTypeEffectiveness.test_calculate_type_effectiveness_fire_vs_grass _

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B890>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C1E170>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F919978D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C1FA70>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F9019ED50>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B890>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B890> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_calculate_type_effectiveness_fire_vs_grass>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C1E170>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F919978D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C1FA70>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F9019ED50>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B890> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
_ ERROR at setup of TestTypeEffectiveness.test_calculate_type_effectiveness_water_vs_fire _

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4BC50>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F903F2170>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F90408650>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C1F9D0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903FDD30>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4BC50>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4BC50> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_calculate_type_effectiveness_water_vs_fire>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F903F2170>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F90408650>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C1F9D0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903FDD30>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4BC50> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
_ ERROR at setup of TestTypeEffectiveness.test_calculate_type_effectiveness_fire_vs_water _

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC87390>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F903F0A50>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFFD88750>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F903F20D0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903FFB30>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC87390>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC87390> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_calculate_type_effectiveness_fire_vs_water>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F903F0A50>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFFD88750>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F903F20D0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903FFB30>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC87390> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
______ ERROR at setup of TestStatusEffects.test_apply_status_effect_none ______

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC86FD0>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFFD3A350>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFE9DB0D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C1C230>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903DCB90>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC86FD0>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC86FD0> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_apply_status_effect_none>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFFD3A350>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFE9DB0D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C1C230>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903DCB90>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC86FD0> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
_____ ERROR at setup of TestStatusEffects.test_apply_status_effect_burned _____

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49D10>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFFD3B430>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFFCE73D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C1FD90>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903C35F0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49D10>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49D10> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_apply_status_effect_burned>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFFD3B430>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFFCE73D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C1FD90>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903C35F0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49D10> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
____ ERROR at setup of TestStatusEffects.test_apply_status_effect_poisoned ____

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE48190>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F903F0370>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F9037BA50>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F903F31B0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903EF8F0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE48190>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE48190> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_apply_status_effect_poisoned>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F903F0370>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F9037BA50>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F903F31B0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903EF8F0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE48190> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
_____ ERROR at setup of TestStatusEffects.test_apply_status_effect_frozen _____

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B610>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F903F11D0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFFEA1650>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F903F3ED0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903ED1F0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B610>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B610> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_apply_status_effect_frozen>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F903F11D0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFFEA1650>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F903F3ED0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903ED1F0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B610> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
_____ ERROR at setup of TestStatusEffects.test_apply_status_effect_asleep _____

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE48050>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F903F1590>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F90ACE050>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F903F0B90>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90391BB0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE48050>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE48050> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_apply_status_effect_asleep>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F903F1590>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F90ACE050>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F903F0B90>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90391BB0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE48050> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
_______ ERROR at setup of TestCardPower.test_calculate_card_power_basic _______

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE48690>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90F11810>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFFCE6F50>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F903F22B0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C03110>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE48690>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE48690> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_calculate_card_power_basic>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90F11810>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFFCE6F50>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F903F22B0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C03110>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE48690> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
____ ERROR at setup of TestCardPower.test_calculate_card_power_biome_bonus ____

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B4D0>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F903F0050>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F91CA81D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F903F3390>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C01010>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B4D0>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B4D0> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_calculate_card_power_biome_bonus>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F903F0050>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F91CA81D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F903F3390>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C01010>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B4D0> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
__ ERROR at setup of TestCardPower.test_calculate_card_power_no_biome_bonus ___

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4AFD0>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F903F2AD0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F90ACE7D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F903F2670>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903EC890>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4AFD0>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4AFD0> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_calculate_card_power_no_biome_bonus>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F903F2AD0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F90ACE7D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F903F2670>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903EC890>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4AFD0> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
____ ERROR at setup of TestDeckPower.test_calculate_deck_power_three_cards ____

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC87890>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F903F3570>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFFCBD850>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C1D630>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C500B0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC87890>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC87890> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_calculate_deck_power_three_cards>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F903F3570>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFFCBD850>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C1D630>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C500B0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC87890> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
____ ERROR at setup of TestDeckPower.test_calculate_deck_power_biome_bonus ____

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B890>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90F105F0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F911E8B50>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015FFFD38550>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903C2990>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B890>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B890> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_calculate_deck_power_biome_bonus>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90F105F0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F911E8B50>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015FFFD38550>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F903C2990>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B890> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
_____ ERROR at setup of TestSelectAttack.test_select_attack_with_attacks ______

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4A0D0>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90F118B0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F90023150>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90F10C30>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C1AA50>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4A0D0>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4A0D0> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_select_attack_with_attacks>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90F118B0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F90023150>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90F10C30>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C1AA50>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4A0D0> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
_ ERROR at setup of TestSelectAttack.test_select_attack_fallback_basic_attack _

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49310>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90F137F0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F91D93DD0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90F13890>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C19F10>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49310>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49310> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_select_attack_fallback_basic_attack>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90F137F0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F91D93DD0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90F13890>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C19F10>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49310> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
___ ERROR at setup of TestSelectAttack.test_select_attack_energy_filtering ____

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4A850>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90F10730>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F904F0CD0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90F12B70>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C989B0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4A850>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4A850> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_select_attack_energy_filtering>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90F10730>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F904F0CD0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90F12B70>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C989B0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4A850> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
________ ERROR at setup of TestMemeCrit.test_roll_meme_crit_zero_meme _________

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEA35310>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F903F3ED0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F903B5850>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F903F0370>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C5A2D0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEA35310>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEA35310> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_roll_meme_crit_zero_meme>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F903F3ED0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F903B5850>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F903F0370>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C5A2D0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEA35310> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
______ ERROR at setup of TestMemeCrit.test_roll_meme_crit_negative_meme _______

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49BD0>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C1C230>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F90C08FD0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F903F25D0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C59490>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49BD0>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49BD0> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_roll_meme_crit_negative_meme>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C1C230>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F90C08FD0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F903F25D0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C59490>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49BD0> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
________ ERROR at setup of TestMemeCrit.test_roll_meme_crit_high_meme _________

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B750>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90F13070>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F91DF75D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90F12990>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C01CD0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B750>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B750> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_roll_meme_crit_high_meme>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90F13070>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F91DF75D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90F12990>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C01CD0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B750> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
___ ERROR at setup of TestMemeCrit.test_roll_meme_crit_capped_at_90_percent ___

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4A990>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90F122B0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFFEA3250>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90F11C70>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C69850>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4A990>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4A990> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_roll_meme_crit_capped_at_90_percent>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90F122B0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFFEA3250>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90F11C70>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C69850>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4A990> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
_ ERROR at setup of TestExecuteBattle.test_execute_battle_requires_three_cards _

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B4D0>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90F11270>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F91B218D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90F10910>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C6A7B0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B4D0>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B4D0> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_execute_battle_requires_three_cards>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90F11270>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F91B218D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90F10910>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C6A7B0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B4D0> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
___ ERROR at setup of TestExecuteBattle.test_execute_battle_returns_winner ____

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC87390>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90F100F0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F91995750>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90F13B10>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C4EE70>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC87390>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC87390> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_execute_battle_returns_winner>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90F100F0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F91995750>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90F13B10>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C4EE70>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC87390> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
_ ERROR at setup of TestExecuteBattle.test_execute_battle_returns_battle_log __

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4BC50>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C05C70>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFFDEF750>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F903F3CF0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C4F4D0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4BC50>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4BC50> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_execute_battle_returns_battle_log>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C05C70>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFFDEF750>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F903F3CF0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C4F4D0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4BC50> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
_ ERROR at setup of TestExecuteBattle.test_execute_battle_returns_power_stats _

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4BD90>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C06490>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F9195AA50>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C065D0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C3B350>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4BD90>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4BD90> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_execute_battle_returns_power_stats>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C06490>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F9195AA50>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C065D0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C3B350>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4BD90> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
_ ERROR at setup of TestExecuteBattle.test_execute_battle_stronger_deck_wins __

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B610>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C07C50>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F90ACD8D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C07570>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C38110>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B610>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B610> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_execute_battle_stronger_deck_wins>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C07C50>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F90ACD8D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C07570>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C38110>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B610> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
_ ERROR at setup of TestBattleSummary.test_generate_battle_summary_includes_stake _

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE48550>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C07D90>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F91CA8A50>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90F13B10>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015FFFE6F050>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE48550>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE48550> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_generate_battle_summary_includes_stake>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C07D90>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F91CA8A50>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90F13B10>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015FFFE6F050>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE48550> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
__ ERROR at setup of TestCleanupService.test_cleanup_service_initialization ___

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC86AD0>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C07430>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F91958450>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C060D0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C3AE10>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC86AD0>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC86AD0> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_cleanup_service_initialization>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C07430>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F91958450>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C060D0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C3AE10>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC86AD0> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
____ ERROR at setup of TestCleanupService.test_cleanup_service_start_stop _____

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEA34E10>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90F12F30>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F917F9250>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F903F2FD0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C5A990>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEA34E10>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEA34E10> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

self = <Coroutine test_cleanup_service_start_stop>

    def setup(self) -> None:
        runner_fixture_id = f"_{self._loop_scope}_scoped_runner"
        if runner_fixture_id not in self.fixturenames:
            self.fixturenames.append(runner_fixture_id)
>       return super().setup()
               ^^^^^^^^^^^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:458: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90F12F30>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F917F9250>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F903F2FD0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C5A990>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEA34E10> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
___ ERROR at setup of TestCleanupService.test_cleanup_service_double_start ____

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4A710>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C04730>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F90023950>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90F12B70>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015FFFE422D0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4A710>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4A710> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

self = <Coroutine test_cleanup_service_double_start>

    def setup(self) -> None:
        runner_fixture_id = f"_{self._loop_scope}_scoped_runner"
        if runner_fixture_id not in self.fixturenames:
            self.fixturenames.append(runner_fixture_id)
>       return super().setup()
               ^^^^^^^^^^^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:458: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C04730>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F90023950>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90F12B70>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015FFFE422D0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4A710> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
________ ERROR at setup of TestDropManager.test_try_claim_drop_success ________

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4BB10>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C062B0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F91DF6BD0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C04550>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015FFFE43170>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4BB10>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4BB10> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

self = <Coroutine test_try_claim_drop_success>

    def setup(self) -> None:
        runner_fixture_id = f"_{self._loop_scope}_scoped_runner"
        if runner_fixture_id not in self.fixturenames:
            self.fixturenames.append(runner_fixture_id)
>       return super().setup()
               ^^^^^^^^^^^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:458: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C062B0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F91DF6BD0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C04550>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015FFFE43170>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4BB10> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
____ ERROR at setup of TestDropManager.test_try_claim_drop_already_claimed ____

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4BC50>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C05310>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F904F0450>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C04B90>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015FFFE8BBF0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4BC50>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4BC50> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

self = <Coroutine test_try_claim_drop_already_claimed>

    def setup(self) -> None:
        runner_fixture_id = f"_{self._loop_scope}_scoped_runner"
        if runner_fixture_id not in self.fixturenames:
            self.fixturenames.append(runner_fixture_id)
>       return super().setup()
               ^^^^^^^^^^^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:458: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C05310>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F904F0450>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C04B90>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015FFFE8BBF0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4BC50> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
__ ERROR at setup of TestDropManager.test_try_claim_drop_different_messages ___

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE482D0>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C07ED0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F9028CBD0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90F12850>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015FFFE74410>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE482D0>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE482D0> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

self = <Coroutine test_try_claim_drop_different_messages>

    def setup(self) -> None:
        runner_fixture_id = f"_{self._loop_scope}_scoped_runner"
        if runner_fixture_id not in self.fixturenames:
            self.fixturenames.append(runner_fixture_id)
>       return super().setup()
               ^^^^^^^^^^^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:458: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C07ED0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F9028CBD0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90F12850>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015FFFE74410>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE482D0> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
______ ERROR at setup of TestDropManager.test_try_claim_drop_custom_ttl _______

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC865D0>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C06990>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F917FA650>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C05630>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015FFFE74170>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC865D0>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC865D0> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

self = <Coroutine test_try_claim_drop_custom_ttl>

    def setup(self) -> None:
        runner_fixture_id = f"_{self._loop_scope}_scoped_runner"
        if runner_fixture_id not in self.fixturenames:
            self.fixturenames.append(runner_fixture_id)
>       return super().setup()
               ^^^^^^^^^^^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:458: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C06990>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F917FA650>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C05630>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015FFFE74170>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC865D0> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
_________ ERROR at setup of TestDropManager.test_release_drop_success _________

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B610>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C079D0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F901C8C50>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90F10910>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C4CA10>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B610>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B610> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

self = <Coroutine test_release_drop_success>

    def setup(self) -> None:
        runner_fixture_id = f"_{self._loop_scope}_scoped_runner"
        if runner_fixture_id not in self.fixturenames:
            self.fixturenames.append(runner_fixture_id)
>       return super().setup()
               ^^^^^^^^^^^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:458: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C079D0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F901C8C50>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90F10910>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C4CA10>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B610> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
_______ ERROR at setup of TestDropManager.test_release_drop_not_claimed _______

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49BD0>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F91B6E0D0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFE813550>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C04AF0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C0E570>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49BD0>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49BD0> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

self = <Coroutine test_release_drop_not_claimed>

    def setup(self) -> None:
        runner_fixture_id = f"_{self._loop_scope}_scoped_runner"
        if runner_fixture_id not in self.fixturenames:
            self.fixturenames.append(runner_fixture_id)
>       return super().setup()
               ^^^^^^^^^^^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:458: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F91B6E0D0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFE813550>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C04AF0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C0E570>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49BD0> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
_______ ERROR at setup of TestDropManager.test_get_claim_owner_success ________

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4A850>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F91B6C7D0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F9129A250>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F91B6DF90>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C0DA30>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4A850>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4A850> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

self = <Coroutine test_get_claim_owner_success>

    def setup(self) -> None:
        runner_fixture_id = f"_{self._loop_scope}_scoped_runner"
        if runner_fixture_id not in self.fixturenames:
            self.fixturenames.append(runner_fixture_id)
>       return super().setup()
               ^^^^^^^^^^^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:458: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F91B6C7D0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F9129A250>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F91B6DF90>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C0DA30>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4A850> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
_____ ERROR at setup of TestDropManager.test_get_claim_owner_not_claimed ______

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49310>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F91B6C730>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F911E8250>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F91B6CC30>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015FFFE789B0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49310>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49310> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

self = <Coroutine test_get_claim_owner_not_claimed>

    def setup(self) -> None:
        runner_fixture_id = f"_{self._loop_scope}_scoped_runner"
        if runner_fixture_id not in self.fixturenames:
            self.fixturenames.append(runner_fixture_id)
>       return super().setup()
               ^^^^^^^^^^^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:458: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F91B6C730>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F911E8250>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F91B6CC30>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015FFFE789B0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49310> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
____ ERROR at setup of TestDropManager.test_get_claim_owner_after_release _____

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B890>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F91B6DEF0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F90E37050>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C07B10>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015FFFE2B3B0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B890>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B890> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

self = <Coroutine test_get_claim_owner_after_release>

    def setup(self) -> None:
        runner_fixture_id = f"_{self._loop_scope}_scoped_runner"
        if runner_fixture_id not in self.fixturenames:
            self.fixturenames.append(runner_fixture_id)
>       return super().setup()
               ^^^^^^^^^^^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:458: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F91B6DEF0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F90E37050>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C07B10>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015FFFE2B3B0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B890> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
______ ERROR at setup of TestDropManager.test_race_condition_prevention _______

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC86AD0>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C06AD0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F917FA8D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C05770>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015FFFE28410>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC86AD0>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC86AD0> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

self = <Coroutine test_race_condition_prevention>

    def setup(self) -> None:
        runner_fixture_id = f"_{self._loop_scope}_scoped_runner"
        if runner_fixture_id not in self.fixturenames:
            self.fixturenames.append(runner_fixture_id)
>       return super().setup()
               ^^^^^^^^^^^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:458: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C06AD0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F917FA8D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C05770>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015FFFE28410>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC86AD0> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
____________ ERROR at setup of TestDropManager.test_close_cleanup _____________

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4A350>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F91B6D270>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F91C5C050>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C06B70>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C0E330>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4A350>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4A350> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

self = <Coroutine test_close_cleanup>

    def setup(self) -> None:
        runner_fixture_id = f"_{self._loop_scope}_scoped_runner"
        if runner_fixture_id not in self.fixturenames:
            self.fixturenames.append(runner_fixture_id)
>       return super().setup()
               ^^^^^^^^^^^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:458: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F91B6D270>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F91C5C050>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C06B70>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C0E330>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4A350> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
______ ERROR at setup of TestDropScheduler.test_scheduler_initialization ______

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B9D0>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F91B6E8F0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F9129B2D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F91B6F2F0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015FFFE1B170>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B9D0>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B9D0> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

self = <Coroutine test_scheduler_initialization>

    def setup(self) -> None:
        runner_fixture_id = f"_{self._loop_scope}_scoped_runner"
        if runner_fixture_id not in self.fixturenames:
            self.fixturenames.append(runner_fixture_id)
>       return super().setup()
               ^^^^^^^^^^^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:458: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F91B6E8F0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F9129B2D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F91B6F2F0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015FFFE1B170>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B9D0> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
__________ ERROR at setup of TestDropScheduler.test_scheduler_start ___________

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49D10>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F91B6E2B0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F90021ED0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F91B6FED0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015FFFE1A210>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49D10>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49D10> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

self = <Coroutine test_scheduler_start>

    def setup(self) -> None:
        runner_fixture_id = f"_{self._loop_scope}_scoped_runner"
        if runner_fixture_id not in self.fixturenames:
            self.fixturenames.append(runner_fixture_id)
>       return super().setup()
               ^^^^^^^^^^^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:458: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F91B6E2B0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F90021ED0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F91B6FED0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015FFFE1A210>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE49D10> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
___________ ERROR at setup of TestDropScheduler.test_scheduler_stop ___________

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC87890>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F91B6FE30>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F913642D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F91B6FB10>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015FFFE5E390>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC87890>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC87890> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

self = <Coroutine test_scheduler_stop>

    def setup(self) -> None:
        runner_fixture_id = f"_{self._loop_scope}_scoped_runner"
        if runner_fixture_id not in self.fixturenames:
            self.fixturenames.append(runner_fixture_id)
>       return super().setup()
               ^^^^^^^^^^^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:458: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F91B6FE30>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F913642D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F91B6FB10>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015FFFE5E390>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC87890> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
_______ ERROR at setup of TestDropScheduler.test_scheduler_double_start _______

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC865D0>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F91B6C0F0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F9129A3D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F91B6E0D0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C0DA30>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC865D0>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC865D0> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

self = <Coroutine test_scheduler_double_start>

    def setup(self) -> None:
        runner_fixture_id = f"_{self._loop_scope}_scoped_runner"
        if runner_fixture_id not in self.fixturenames:
            self.fixturenames.append(runner_fixture_id)
>       return super().setup()
               ^^^^^^^^^^^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:458: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F91B6C0F0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F9129A3D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F91B6E0D0>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C0DA30>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFEC865D0> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
__ ERROR at setup of TestDropScheduler.test_scheduler_stop_when_not_started ___

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B9D0>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C06B70>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFFEA3850>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C05270>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015FFFE789B0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B9D0>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B9D0> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

self = <Coroutine test_scheduler_stop_when_not_started>

    def setup(self) -> None:
        runner_fixture_id = f"_{self._loop_scope}_scoped_runner"
        if runner_fixture_id not in self.fixturenames:
            self.fixturenames.append(runner_fixture_id)
>       return super().setup()
               ^^^^^^^^^^^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:458: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015F90C06B70>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015FFFEA3850>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F90C05270>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015FFFE789B0>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B9D0> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
________ ERROR at setup of TestBiomes.test_get_chat_biome_positive_id _________

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B610>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFFD563F0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F904084D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F91B6E850>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C3D550>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B610>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B610> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_get_chat_biome_positive_id>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:743: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:313: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\runners.py:127: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\asyncio\base_events.py:719: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest_asyncio\plugin.py:309: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:48: in db_engine
    await conn.run_sync(Base.metadata.create_all)
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\ext\asyncio\engine.py:888: in run_sync
    return await greenlet_spawn(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\schema.py:5928: in create_all
    bind._run_ddl_visitor(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:2467: in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:984: in visit_metadata
    self.traverse_single(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:661: in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:1022: in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:321: in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\engine\base.py:1527: in _execute_ddl
    compiled = ddl.compile(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\elements.py:312: in compile
    return self._compiler(dialect, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\ddl.py:76: in _compiler
    return dialect.ddl_compiler(dialect, self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:887: in __init__
    self.string = self.process(self.statement, **compile_kwargs)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFFD563F0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F904084D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015F91B6E850>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015F90C3D550>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
                processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )
                if processed is not None:
                    text += separator
                    separator = ", \n"
                    text += "\t" + processed
                if column.primary_key:
                    first_pk = True
            except exc.CompileError as ce:
>               raise exc.CompileError(
                    "(in table '%s', column '%s'): %s"
                    % (table.description, column.name, ce.args[0])
                ) from ce
E               sqlalchemy.exc.CompileError: (in table 'card_templates', column 'stats'): Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4B610> can't render element of type JSONB

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6801: CompileError
________ ERROR at setup of TestBiomes.test_get_chat_biome_negative_id _________

self = JSONB(astext_type=Text())
visitor = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4A350>
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def _compiler_dispatch(
        self: Visitable, visitor: Any, **kw: Any
    ) -> str:
        """Look for an attribute named "visit_<visit_name>" on the
        visitor, and call it with the same kw params.
    
        """
        try:
>           meth = getter(visitor)
                   ^^^^^^^^^^^^^^^
E           AttributeError: 'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'. Did you mean: 'visit_JSON'?

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:134: AttributeError

The above exception was the direct cause of the following exception:

self = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x0000015FFFD551D0>
create = <sqlalchemy.sql.ddl.CreateTable object at 0x0000015F919D51D0>, kw = {}
table = Table('card_templates', MetaData(), Column('id', UUID(), table=<card_templates>, primary_key=True, nullable=False, def...ext_type=Text()), table=<card_templates>), Column('print_date', String(length=7), table=<card_templates>), schema=None)
preparer = <sqlalchemy.dialects.sqlite.base.SQLiteIdentifierPreparer object at 0x0000015FFFD55B30>
text = '\nCREATE TABLE card_templates (\n\tid UUID NOT NULL, \n\tname VARCHAR(255) NOT NULL, \n\timage_url VARCHAR(512), \n\trarity VARCHAR(9) NOT NULL, \n\tbiome_affinity VARCHAR(7) NOT NULL'
create_table_suffix = '', separator = ', \n', first_pk = True
create_column = <sqlalchemy.sql.ddl.CreateColumn object at 0x0000015FFFDA3A10>

    def visit_create_table(self, create, **kw):
        table = create.element
        preparer = self.preparer
    
        text = "\nCREATE "
        if table._prefixes:
            text += " ".join(table._prefixes) + " "
    
        text += "TABLE "
        if create.if_not_exists:
            text += "IF NOT EXISTS "
    
        text += preparer.format_table(table) + " "
    
        create_table_suffix = self.create_table_suffix(table)
        if create_table_suffix:
            text += create_table_suffix + " "
    
        text += "("
    
        separator = "\n"
    
        # if only one primary key, specify it along with the column
        first_pk = False
        for create_column in create.columns:
            column = create_column.element
            try:
>               processed = self.process(
                    create_column, first_pk=column.primary_key and not first_pk
                )

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6791: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:933: in process
    return obj._compiler_dispatch(self, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:138: in _compiler_dispatch
    return meth(self, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:6822: in visit_create_column
    text = self.get_column_specification(column, first_pk=first_pk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1692: in get_column_specification
    coltype = self.dialect.type_compiler_instance.process(
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:978: in process
    return type_._compiler_dispatch(self, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\visitors.py:136: in _compiler_dispatch
    return visitor.visit_unsupported_compilation(self, err, **kw)  # type: ignore  # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4A350>
element = JSONB(astext_type=Text())
err = AttributeError("'SQLiteTypeCompiler' object has no attribute 'visit_JSONB'")
kw = {'type_expression': Column('stats', JSONB(astext_type=Text()), table=<card_templates>, nullable=False)}

    def visit_unsupported_compilation(
        self, element: Any, err: Exception, **kw: Any
    ) -> NoReturn:
>       raise exc.UnsupportedCompilationError(self, element) from err
E       sqlalchemy.exc.UnsupportedCompilationError: Compiler <sqlalchemy.dialects.sqlite.base.SQLiteTypeCompiler object at 0x0000015FFFE4A350> can't render element of type JSONB (Background on this error at: https://sqlalche.me/e/20/l7de)

C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\sqlalchemy\sql\compiler.py:983: UnsupportedCompilationError

The above exception was the direct cause of the following exception:

fixturedef = <FixtureDef argname='db_engine' scope='function' baseid='tests'>
request = <SubRequest 'db_engine' for <Function test_get_chat_biome_negative_id>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)  + Exception Group Traceback (most recent call last):
  |   File "<frozen runpy>", line 198, in _run_module_as_main
  |   File "<frozen runpy>", line 88, in _run_code
  |   File "C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pytest\__main__.py", line 9, in <module>
  |     raise SystemExit(pytest.console_main())
  |                      ~~~~~~~~~~~~~~~~~~~^^
  |   File "C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\_pytest\config\__init__.py", line 223, in console_main
  |     code = main()
  |   File "C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\_pytest\config\__init__.py", line 199, in main
  |     ret: ExitCode | int = config.hook.pytest_cmdline_main(config=config)
  |                           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^
  |   File "C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pluggy\_hooks.py", line 512, in __call__
  |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
  |            ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pluggy\_manager.py", line 120, in _hookexec
  |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
  |            ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pluggy\_callers.py", line 167, in _multicall
  |     raise exception
  |   File "C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\pluggy\_callers.py", line 121, in _multicall
  |     res = hook_impl.function(*args)
  |   File "C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\_pytest\main.py", line 365, in pytest_cmdline_main
  |     return wrap_session(config, _main)
  |   File "C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\_pytest\main.py", line 360, in wrap_session
  |     config._ensure_unconfigure()
  |     ~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\_pytest\config\__init__.py", line 1171, in _ensure_unconfigure
  |     self._cleanup_stack.close()
  |     ~~~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\contextlib.py", line 627, in close
  |     self.__exit__(None, None, None)
  |     ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  |   File "C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\contextlib.py", line 619, in __exit__
  |     raise exc
  |   File "C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\contextlib.py", line 604, in __exit__
  |     if cb(*exc_details):
  |        ~~^^^^^^^^^^^^^^
  |   File "C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\contextlib.py", line 482, in _exit_wrapper
  |     callback(*args, **kwds)
  |     ~~~~~~~~^^^^^^^^^^^^^^^
  |   File "C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\_pytest\unraisableexception.py", line 95, in cleanup
  |     collect_unraisable(config)
  |     ~~~~~~~~~~~~~~~~~~^^^^^^^^
  |   File "C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\_pytest\unraisableexception.py", line 81, in collect_unraisable
  |     raise ExceptionGroup("multiple unraisable exception warnings", errors)
  | ExceptionGroup: multiple unraisable exception warnings (5 sub-exceptions)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\aiosqlite\core.py", line 102, in __del__
    |     warn(
    |     ~~~~^
    |         (
    |         ^
    |     ...<4 lines>...
    |         stacklevel=1,
    |         ^^^^^^^^^^^^^
    |     )
    |     ^
    | ResourceWarning: <aiosqlite.core.Connection object at 0x0000015F917FB950> was deleted before being closed. Please use 'async with' or '.close()' to close the connection properly.
    | 
    | The above exception was the direct cause of the following exception:
    | 
    | Traceback (most recent call last):
    |   File "C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\_pytest\unraisableexception.py", line 67, in collect_unraisable
    |     warnings.warn(pytest.PytestUnraisableExceptionWarning(msg))
    |     ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    | pytest.PytestUnraisableExceptionWarning: Exception ignored while calling deallocator <function Connection.__del__ at 0x0000015FFECBA8D0>: None
    | 
    +---------------- 2 ----------------
    | Traceback (most recent call last):
    |   File "C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\aiosqlite\core.py", line 102, in __del__
    |     warn(
    |     ~~~~^
    |         (
    |         ^
    |     ...<4 lines>...
    |         stacklevel=1,
    |         ^^^^^^^^^^^^^
    |     )
    |     ^
    | ResourceWarning: <aiosqlite.core.Connection object at 0x0000015F90E371D0> was deleted before being closed. Please use 'async with' or '.close()' to close the connection properly.
    | 
    | The above exception was the direct cause of the following exception:
    | 
    | Traceback (most recent call last):
    |   File "C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\_pytest\unraisableexception.py", line 67, in collect_unraisable
    |     warnings.warn(pytest.PytestUnraisableExceptionWarning(msg))
    |     ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    | pytest.PytestUnraisableExceptionWarning: Exception ignored while calling deallocator <function Connection.__del__ at 0x0000015FFECBA8D0>: None
    | 
    +---------------- 3 ----------------
    | Traceback (most recent call last):
    |   File "C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\aiosqlite\core.py", line 102, in __del__
    |     warn(
    |     ~~~~^
    |         (
    |         ^
    |     ...<4 lines>...
    |         stacklevel=1,
    |         ^^^^^^^^^^^^^
    |     )
    |     ^
    | ResourceWarning: <aiosqlite.core.Connection object at 0x0000015F91BD7E50> was deleted before being closed. Please use 'async with' or '.close()' to close the connection properly.
    | 
    | The above exception was the direct cause of the following exception:
    | 
    | Traceback (most recent call last):
    |   File "C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\_pytest\unraisableexception.py", line 67, in collect_unraisable
    |     warnings.warn(pytest.PytestUnraisableExceptionWarning(msg))
    |     ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    | pytest.PytestUnraisableExceptionWarning: Exception ignored while calling deallocator <function Connection.__del__ at 0x0000015FFECBA8D0>: None
    | 
    +---------------- 4 ----------------
    | Traceback (most recent call last):
    |   File "C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\aiosqlite\core.py", line 102, in __del__
    |     warn(
    |     ~~~~^
    |         (
    |         ^
    |     ...<4 lines>...
    |         stacklevel=1,
    |         ^^^^^^^^^^^^^
    |     )
    |     ^
    | ResourceWarning: <aiosqlite.core.Connection object at 0x0000015FFFF44850> was deleted before being closed. Please use 'async with' or '.close()' to close the connection properly.
    | 
    | The above exception was the direct cause of the following exception:
    | 
    | Traceback (most recent call last):
    |   File "C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\_pytest\unraisableexception.py", line 67, in collect_unraisable
    |     warnings.warn(pytest.PytestUnraisableExceptionWarning(msg))
    |     ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    | pytest.PytestUnraisableExceptionWarning: Exception ignored while calling deallocator <function Connection.__del__ at 0x0000015FFECBA8D0>: None
    | 
    +---------------- 5 ----------------
    | Traceback (most recent call last):
    |   File "C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\aiosqlite\core.py", line 102, in __del__
    |     warn(
    |     ~~~~^
    |         (
    |         ^
    |     ...<4 lines>...
    |         stacklevel=1,
    |         ^^^^^^^^^^^^^
    |     )
    |     ^
    | ResourceWarning: <aiosqlite.core.Connection object at 0x0000015F91366B50> was deleted before being closed. Please use 'async with' or '.close()' to close the connection properly.
    | 
    | The above exception was the direct cause of the following exception:
    | 
    | Traceback (most recent call last):
    |   File "C:\Users\ThatHunky\AppData\Local\Programs\Python\Python314\Lib\site-packages\_pytest\unraisableexception.py", line 67, in collect_unraisable
    |     warnings.warn(pytest.PytestUnraisableExceptionWarning(msg))
    |     ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    | pytest.PytestUnraisableExceptionWarning: Exception ignored while calling deallocator <function Connection.__del__ at 0x0000015FFECBA8D0>: None
    | 
    +------------------------------------
```

---

_**Agent (model gpt-5.2-xhigh, mode Agent)**_



---

