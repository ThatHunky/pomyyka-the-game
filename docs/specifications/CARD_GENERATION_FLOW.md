# Card Generation Flow Diagram

## New Interactive Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Admin runs /autocard                        â”‚
â”‚                  (with photo and description)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              AI Generates Blueprint + Image                     â”‚
â”‚  (CardArchitectService + ArtForgeService + CardAnimator)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Show Card Preview with                        â”‚
â”‚                      4 Action Buttons:                          â”‚
â”‚                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚      ğŸ”„ ĞŸĞµÑ€ĞµĞ³ĞµĞ½ĞµÑ€ÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ—Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ                     â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚      âœï¸ Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ñ‚Ğ¸ ĞŸĞ¾Ğ»Ñ                               â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚      âœ… Ğ—Ğ°Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğ¸ Ñ‚Ğ° Ğ’Ğ¸Ğ´Ğ°Ñ‚Ğ¸                          â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚      âŒ Ğ¡ĞºĞ°ÑÑƒĞ²Ğ°Ñ‚Ğ¸                                      â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚            â”‚            â”‚            â”‚
         â–¼            â–¼            â–¼            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚Regeneraâ”‚  â”‚  Edit   â”‚  â”‚ Approve â”‚  â”‚ Cancel  â”‚
    â”‚  te    â”‚  â”‚ Fields  â”‚  â”‚         â”‚  â”‚         â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚           â”‚            â”‚            â”‚
         â–¼           â–¼            â”‚            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚            â”‚
    â”‚Generateâ”‚  â”‚Ask JSON â”‚      â”‚            â”‚
    â”‚New Img â”‚  â”‚Input    â”‚      â”‚            â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â”‚            â”‚
         â”‚           â”‚            â”‚            â”‚
         â”‚           â–¼            â”‚            â”‚
         â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚            â”‚
         â”‚      â”‚Validate â”‚      â”‚            â”‚
         â”‚      â”‚& Update â”‚      â”‚            â”‚
         â”‚      â”‚Blueprintâ”‚      â”‚            â”‚
         â”‚      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â”‚            â”‚
         â”‚           â”‚            â”‚            â”‚
         â”‚           â–¼            â”‚            â”‚
         â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚            â”‚
         â”‚      â”‚Generate â”‚      â”‚            â”‚
         â”‚      â”‚New Img  â”‚      â”‚            â”‚
         â”‚      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â”‚            â”‚
         â”‚           â”‚            â”‚            â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
                     â”‚                         â”‚
                     â–¼                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Show Updated Preview â”‚    â”‚  Clean Redis  â”‚
         â”‚  (Back to 4 buttons)  â”‚    â”‚  Show Cancel  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   Message     â”‚
                     â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Admin can continue    â”‚
         â”‚ editing/regenerating  â”‚
         â”‚ or approve/cancel     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Click Approve        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Save to Database      â”‚
         â”‚ Issue to User         â”‚
         â”‚ Clean Redis           â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Regenerate Flow (Detailed)

```
Admin clicks "ğŸ”„ ĞŸĞµÑ€ĞµĞ³ĞµĞ½ĞµÑ€ÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ—Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ"
            â”‚
            â–¼
    Check admin permissions
            â”‚
            â–¼
    Retrieve blueprint from Redis
            â”‚
            â–¼
    Delete old message
            â”‚
            â–¼
    _regenerate_card_image()
            â”‚
            â”œâ”€â–º Get placeholder path
            â”‚   (NanoBananaService._get_placeholder_path)
            â”‚
            â”œâ”€â–º Generate new image
            â”‚   (ArtForgeService.forge_card_image)
            â”‚
            â””â”€â–º Return new image path
            â”‚
            â–¼
    Update blueprint in Redis
    (store new image_url)
            â”‚
            â–¼
    _send_card_preview()
            â”‚
            â”œâ”€â–º Format caption
            â”œâ”€â–º Create 4-button keyboard
            â”œâ”€â–º Check if rare (animated)
            â””â”€â–º Send photo/animation
            â”‚
            â–¼
    Admin sees new preview
    (can regenerate again, edit, approve, or cancel)
```

## Edit Flow (Detailed)

```
Admin clicks "âœï¸ Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ñ‚Ğ¸ ĞŸĞ¾Ğ»Ñ"
            â”‚
            â–¼
    Check admin permissions
            â”‚
            â–¼
    Retrieve blueprint from Redis
            â”‚
            â–¼
    Store blueprint_id in FSM context
            â”‚
            â–¼
    Show current values + instructions
    (with JSON example)
            â”‚
            â–¼
    Enter FSM state: waiting_for_json
            â”‚
            â–¼
    Admin sends JSON message
    e.g., {"name": "New Name", "atk": 75}
            â”‚
            â–¼
    process_card_edit_json()
            â”‚
            â”œâ”€â–º Parse JSON
            â”‚   (handle JSONDecodeError)
            â”‚
            â”œâ”€â–º Validate fields
            â”‚   â€¢ Check field names
            â”‚   â€¢ Validate biome enum
            â”‚   â€¢ Validate rarity enum
            â”‚   â€¢ Validate stat ranges (0-100)
            â”‚
            â”œâ”€â–º Update blueprint in Redis
            â”‚
            â”œâ”€â–º Show status message
            â”‚   "ğŸ”„ Ğ“ĞµĞ½ĞµÑ€ÑƒÑ Ğ½Ğ¾Ğ²Ğµ Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ..."
            â”‚
            â”œâ”€â–º _regenerate_card_image()
            â”‚   (same as regenerate flow)
            â”‚
            â”œâ”€â–º Update blueprint with new image
            â”‚
            â”œâ”€â–º Delete status message
            â”‚
            â”œâ”€â–º _send_card_preview()
            â”‚   (show updated card)
            â”‚
            â””â”€â–º Clear FSM state
            â”‚
            â–¼
    Admin sees updated preview
    (can edit again, regenerate, approve, or cancel)
```

## Key Features

### 1. Regenerate Image
- Keeps all blueprint data (name, stats, lore)
- Generates completely new image
- Can be done multiple times
- No user input required

### 2. Edit Fields
- Edit any field via JSON
- Automatic validation
- Auto-regenerates image after edit
- Can edit multiple fields at once
- Can be done multiple times

### 3. Approve
- Saves card to database
- Issues card to target user
- Cleans up Redis data
- Final action (ends flow)

### 4. Cancel
- Cleans up Redis data
- Shows cancellation message
- Final action (ends flow)

## Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Redis Storage                           â”‚
â”‚                                                                 â”‚
â”‚  Key: blueprint:{uuid}                                          â”‚
â”‚  TTL: 3600 seconds (1 hour)                                     â”‚
â”‚                                                                 â”‚
â”‚  Value: {                                                       â”‚
â”‚    "name": "Card Name",                                         â”‚
â”‚    "raw_image_prompt_en": "...",                                â”‚
â”‚    "biome": "FIRE",                                             â”‚
â”‚    "rarity": "EPIC",                                            â”‚
â”‚    "atk": 75,                                                   â”‚
â”‚    "def": 60,                                                   â”‚
â”‚    "lore": "...",                                               â”‚
â”‚    "dominant_color_hex": "#FF5733",                             â”‚
â”‚    "accent_color_hex": "#33FF57",                               â”‚
â”‚    "attacks": [...],                                            â”‚
â”‚    "weakness": {...},                                           â”‚
â”‚    "resistance": {...},                                         â”‚
â”‚    "print_date": "01/2025",                                     â”‚
â”‚    "target_user_id": 123456789,                                 â”‚
â”‚    "image_url": "media/cards/abc123.png"  â† NEW!               â”‚
â”‚  }                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## State Management

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      FSM State (Edit Flow)                      â”‚
â”‚                                                                 â”‚
â”‚  State: CardEditStates.waiting_for_json                         â”‚
â”‚                                                                 â”‚
â”‚  Context Data: {                                                â”‚
â”‚    "blueprint_id": "uuid-string"                                â”‚
â”‚  }                                                              â”‚
â”‚                                                                 â”‚
â”‚  Cleared after:                                                 â”‚
â”‚  â€¢ Successful edit + regeneration                               â”‚
â”‚  â€¢ Error during processing                                      â”‚
â”‚  â€¢ Admin cancels (timeout)                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Error Handling

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Error Scenarios                         â”‚
â”‚                                                                 â”‚
â”‚  1. Blueprint not found in Redis                                â”‚
â”‚     â†’ Show error, prompt to start over                          â”‚
â”‚                                                                 â”‚
â”‚  2. Image generation fails                                      â”‚
â”‚     â†’ Show error, keep blueprint, allow retry                   â”‚
â”‚                                                                 â”‚
â”‚  3. Invalid JSON in edit flow                                   â”‚
â”‚     â†’ Show validation error with example                        â”‚
â”‚                                                                 â”‚
â”‚  4. Invalid field values                                        â”‚
â”‚     â†’ Show specific validation error                            â”‚
â”‚                                                                 â”‚
â”‚  5. Admin permissions check fails                               â”‚
â”‚     â†’ Show access denied error                                  â”‚
â”‚                                                                 â”‚
â”‚  6. FSM state lost                                              â”‚
â”‚     â†’ Prompt to start over                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
